<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å…¬å¸ Bingo å¤§å»³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
        "PingFang TC", "Microsoft JhengHei", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    .small-hint {
      font-size: 12px;
      color: #777;
    }

    .btn {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid transparent;
      background: #0d6efd;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s, opacity 0.15s;
    }
    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    .btn-secondary {
      background: #6c757d;
    }
    .btn-danger {
      background: #dc3545;
    }
    .btn-outline {
      background: #fff;
      color: #0d6efd;
      border-color: #0d6efd;
    }

    input, select {
      padding: 4px 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /* layout ä¸»é«”ä¸‰æ¬„ */
    .layout {
      display: grid;
      grid-template-columns: 260px 1fr 320px;
      gap: 12px;
      align-items: start;
    }

    .card {
      background: #fff;
      border-radius: 6px;
      padding: 10px 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
    }

    /* æˆ¿é–“å¤§å»³ */
    #lobby {
      margin-top: 8px;
      margin-bottom: 12px;
      padding: 10px 12px;
      background: #fff8e1;
      border-radius: 6px;
      border: 1px solid #ffe082;
    }

    #room-list {
      margin-top: 6px;
      border-top: 1px solid #eee;
      padding-top: 6px;
      max-height: 120px;
      overflow-y: auto;
      font-size: 13px;
    }

    .room-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
    }

    .room-lock {
      margin-right: 4px;
      color: #ff9800;
    }

    /* ç©å®¶æ¸…å–® */
    .player-list {
      border: 1px solid #eee;
      border-radius: 4px;
      max-height: 260px;
      overflow-y: auto;
      padding: 4px;
      font-size: 13px;
    }
    .player-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px 4px;
    }

    /* æ ¼å­ç›¸é—œ */
    .grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
    }

    .grid-5 {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
    }

    .num-btn {
      padding: 4px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
      text-align: center;
      cursor: pointer;
      background: #f8f9fa;
      user-select: none;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    .num-btn.selected {
      background: #3f51b5;
      color: #fff;
      border-color: #3f51b5;
    }
    .num-btn.disabled {
      cursor: not-allowed;
      background: #eee;
      color: #aaa;
    }

    .num-btn-mycard {
      padding: 14px 0;
    }

    .center {
      text-align: center;
    }

    .hint-text {
      font-size: 13px;
      color: #777;
    }

    .bingo-highlight {
      color: #d32f2f;
      font-weight: 700;
    }

    /* å³å´ æ—¥èªŒç™½æ¡†å’Œé»‘æ¡† */
    #log-wrapper {
      display: flex;
      flex-direction: column;
      gap: 6px;
      height: 100%;
    }

    #room-info {
      font-size: 13px;
      line-height: 1.5;
    }

    #log-box {
      flex: 1;
      min-height: 260px;
      max-height: 400px; /* èˆ‡ä¸­é–“å¡ç‰‡å·®ä¸å¤š */
      border-radius: 4px;
      background: #111;
      color: #eee;
      padding: 6px;
      font-size: 12px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    /* æš±ç¨±è¼¸å…¥å½ˆçª— */
    #nickname-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    #nickname-modal {
      background: #fff;
      padding: 16px 20px;
      border-radius: 6px;
      width: 280px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    #nickname-modal h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }

    #nickname-modal p {
      margin: 0 0 8px;
      font-size: 13px;
      color: #555;
    }

    /* ä¸€äº›å°æ±è¥¿ */
    .mt-4 { margin-top: 4px; }
    .mt-6 { margin-top: 6px; }
    .mt-8 { margin-top: 8px; }
    .mt-10 { margin-top: 10px; }

    .text-small {
      font-size: 12px;
      color: #777;
    }

    .lock-btn-unlock {
      background: #0d6efd;
    }
    .lock-btn-locked {
      background: #dc3545; /* åç´… */
    }

    .pointer-forbidden {
      cursor: not-allowed !important;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>å…¬å¸ Bingo å¤§å»³</h1>
      <div class="small-hint">ä½¿ç”¨åŒä¸€ç¶²å€ï¼ŒåŒä¸€ Firebaseï¼Œå°±èƒ½å¤§å®¶ä¸€èµ·ç©ã€‚</div>
    </div>
    <!-- å³ä¸ŠåŸæœ¬é¡¯ç¤ºæš±ç¨±çš„å€å¡Šæ‹¿æ‰ï¼Œæš±ç¨±æ”¹æ”¾åœ¨å³å´ç™½æ¡†å…§ -->
  </header>

  <!-- æˆ¿é–“å¤§å»³ï¼ˆå»ºç«‹ / åŠ å…¥ + æˆ¿é–“åˆ—è¡¨ï¼‰ -->
  <div id="lobby">
    <div>
      <label>æˆ¿è™Ÿï¼š</label>
      <input id="room-id-input" type="text" placeholder="ä¾‹å¦‚ï¼š101" style="width:100px;" />
      <button id="create-room-btn" class="btn">å»ºç«‹æˆ¿é–“</button>
      <button id="join-room-btn" class="btn btn-outline">åŠ å…¥æˆ¿é–“</button>
    </div>
    <div id="room-list"></div>
  </div>

  <!-- é–å®š & éŠæˆ²å€ä¸‰æ¬„ -->
  <div class="layout">
    <!-- å·¦å´ï¼šé–å®š / ç©å®¶åˆ—è¡¨ / åˆ·æ–°å¡ç‰‡ -->
    <div class="card">
      <div class="card-title-row">
        <h3 class="card-title">æ§åˆ¶ / ç©å®¶</h3>
      </div>
      <button id="lock-btn" class="btn lock-btn-unlock" style="width:100%; margin-bottom:6px;">
        é–å®šé–‹å§‹æœ¬å±€
      </button>
      <div class="card-title-row" style="margin-top:4px;">
        <span class="card-title" style="font-size:14px;">ç©å®¶åˆ—è¡¨</span>
      </div>
      <div id="player-list" class="player-list"></div>

      <button id="refresh-card-btn" class="btn btn-outline mt-8" style="width:100%;">
        é‡æ–°æŠ½æˆ‘çš„å¡ç‰‡
      </button>
      <div class="text-small mt-4">
        â€» æœªé–å®šæ™‚ï¼Œæ‰€æœ‰è™Ÿç¢¼éƒ½ä¸èƒ½é»ã€‚é–å®šå¾Œæ‰é–‹å§‹éŠæˆ²ã€‚
      </div>
    </div>

    <!-- ä¸­é–“ï¼šå…¬å…±è™Ÿç¢¼ + æˆ‘çš„å¡ç‰‡ -->
    <div class="card">
      <div class="card-title-row">
        <h3 class="card-title center" style="flex:1; text-align:center;">
          å…¬å…±è™Ÿç¢¼ï¼ˆ1â€“50ï¼‰
        </h3>
      </div>
      <div id="turn-hint" class="center hint-text mt-4">
        å°šæœªé–å®šï¼Œè«‹æˆ¿ä¸»å…ˆé–å®šé–‹å§‹ã€‚
      </div>
      <div id="public-grid" class="grid mt-4"></div>

      <div class="card-title-row mt-10">
        <h3 class="card-title" style="flex:1; text-align:center;">
          æˆ‘çš„å¡ç‰‡ã€€<span id="bingo-count-label">ç›®å‰ BINGOï¼š0 æ¢</span>
        </h3>
        <button id="brag-btn" class="btn btn-outline" style="margin-left:6px; font-size:13px;">
          ç‚«è€€
        </button>
      </div>
      <div class="center hint-text">
        é»æ“Šè™Ÿç¢¼ = è¨­ç‚ºé¸ä¸­ / å–æ¶ˆé¸ä¸­ï¼ˆé–å®šå¾Œæ‰å¯æ“ä½œï¼‰
      </div>
      <div id="mycard-grid" class="grid-5 mt-4"></div>
    </div>

    <!-- å³å´ï¼šæˆ¿é–“è³‡è¨Š + æ—¥èªŒ -->
    <div class="card" style="height:100%;">
      <div id="log-wrapper">
        <div id="room-info">
          æˆ¿è™Ÿï¼š<span id="room-info-id">-</span><br/>
          æš±ç¨±ï¼š<span id="room-info-nick">-</span>
        </div>
        <div id="log-box"></div>
      </div>
    </div>
  </div>
</div>

<!-- æš±ç¨±è¼¸å…¥å½ˆçª— -->
<div id="nickname-modal-backdrop">
  <div id="nickname-modal">
    <h2>è¼¸å…¥æš±ç¨±</h2>
    <p>ç¬¬ä¸€æ¬¡ä½¿ç”¨è«‹å…ˆè¨­å®šæš±ç¨±ï¼Œä¹‹å¾ŒåŒä¸€å°é›»è…¦æœƒè‡ªå‹•è¨˜ä½ã€‚</p>
    <input id="nickname-input" type="text" placeholder="ä¾‹å¦‚ï¼šGARY" style="width:100%;"/>
    <button id="nickname-confirm-btn" class="btn mt-8" style="width:100%;">ç¢ºå®š</button>
  </div>
</div>

<!-- Firebase ï¼‹ éŠæˆ²é‚è¼¯ -->
<script type="module">
  // ===== Firebase åˆå§‹åŒ– =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    child,
    get,
    set,
    update,
    push,
    onValue,
    serverTimestamp,
    remove
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB4IBPbuGxztyzd8E3YTitMoTt8L19MSG0",
    authDomain: "company-bingo.firebaseapp.com",
    databaseURL: "https://company-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "company-bingo",
    storageBucket: "company-bingo.firebasestorage.app",
    messagingSenderId: "844173689886",
    appId: "1:844173689886:web:ac2f1888f542b138861a0f",
    measurementId: "G-WGDVJPKMEH"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // ====== ä¸€äº› DOM è®Šæ•¸ ======
  const lobbyEl           = document.getElementById("lobby");
  const roomIdInput       = document.getElementById("room-id-input");
  const createRoomBtn     = document.getElementById("create-room-btn");
  const joinRoomBtn       = document.getElementById("join-room-btn");
  const roomListEl        = document.getElementById("room-list");

  const lockBtn           = document.getElementById("lock-btn");
  const playerListEl      = document.getElementById("player-list");
  const refreshCardBtn    = document.getElementById("refresh-card-btn");

  const publicGridEl      = document.getElementById("public-grid");
  const myCardGridEl      = document.getElementById("mycard-grid");
  const turnHintEl        = document.getElementById("turn-hint");

  const bingoCountLabelEl = document.getElementById("bingo-count-label");
  const bragBtn           = document.getElementById("brag-btn");

  const roomInfoIdEl      = document.getElementById("room-info-id");
  const roomInfoNickEl    = document.getElementById("room-info-nick");
  const logBoxEl          = document.getElementById("log-box");

  // æš±ç¨± modal
  const nicknameModalBackdrop = document.getElementById("nickname-modal-backdrop");
  const nicknameInput         = document.getElementById("nickname-input");
  const nicknameConfirmBtn    = document.getElementById("nickname-confirm-btn");

  // ====== ç‹€æ…‹ ======
  let myUid = null;
  let myNickname = null;
  let currentRoomId = null;
  let isRoomHost = false;
  let isLocked = false;
  let myCardNumbers = []; // 25 numbers
  let myCardSelected = new Set(); // é¸ä¸­çš„è™Ÿç¢¼
  let bragState = {
    lastLines: 0,
    count: 0
  };

  // ç”¢ç”Ÿ / å–å¾— uid
  function ensureMyUid() {
    let uid = localStorage.getItem("company-bingo-uid");
    if (!uid) {
      uid = "u_" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("company-bingo-uid", uid);
    }
    myUid = uid;
  }

  // å–å¾— / è¨­å®šæš±ç¨±
  function ensureNickname() {
    const nick = localStorage.getItem("company-bingo-nick");
    if (!nick) {
      nicknameModalBackdrop.style.display = "flex";
      nicknameInput.focus();
    } else {
      myNickname = nick;
      roomInfoNickEl.textContent = myNickname || "-";
    }
  }

  nicknameConfirmBtn.addEventListener("click", () => {
    const v = nicknameInput.value.trim();
    if (!v) {
      alert("æš±ç¨±ä¸èƒ½ç©ºç™½");
      return;
    }
    myNickname = v;
    localStorage.setItem("company-bingo-nick", v);
    roomInfoNickEl.textContent = v;
    nicknameModalBackdrop.style.display = "none";
  });

  nicknameInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      nicknameConfirmBtn.click();
    }
  });

  // ====== å·¥å…· ======

  function timeString() {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    const ss = String(d.getSeconds()).padStart(2,"0");
    return `${hh}:${mm}:${ss}`;
  }

  function appendLog(text) {
    const line = `[${timeString()}] ${text}`;
    logBoxEl.textContent += (logBoxEl.textContent ? "\n" : "") + line;
    logBoxEl.scrollTop = logBoxEl.scrollHeight;
  }

  function firebasePushLog(roomId, text) {
    const logsRef = ref(db, `rooms/${roomId}/logs`);
    push(logsRef, {
      t: serverTimestamp(),
      msg: text
    });
  }

  // ç›£è½ logs æ›´æ–°
  function listenLogs(roomId) {
    const logsRef = ref(db, `rooms/${roomId}/logs`);
    onValue(logsRef, (snap) => {
      const val = snap.val() || {};
      const lines = Object.values(val)
        .sort((a,b)=> (a.t||0) - (b.t||0))
        .map(v => v.msg);
      logBoxEl.textContent = lines.join("\n");
      logBoxEl.scrollTop = logBoxEl.scrollHeight;
    });
  }

  // ====== å¤§å»³ï¼šæˆ¿é–“åˆ—è¡¨ ======
  function listenRoomList() {
    const roomsRef = ref(db, "rooms");
    onValue(roomsRef, (snap) => {
      const val = snap.val() || {};
      const rows = Object.entries(val).map(([rid, room]) => {
        const players = room.players ? Object.keys(room.players).length : 0;
        const locked = !!room.locked;
        return { rid, players, locked };
      });
      roomListEl.innerHTML = rows.length
        ? "<div style='font-size:13px;margin-bottom:4px;'>å·²å»ºç«‹æˆ¿é–“ï¼š</div>"
        : "<div style='font-size:13px;color:#777;'>ç›®å‰å°šç„¡æˆ¿é–“</div>";

      rows.forEach(r => {
        const row = document.createElement("div");
        row.className = "room-row";
        row.innerHTML = `
          <div>
            ${r.locked ? "<span class='room-lock'>ğŸ”’</span>" : ""}
            æˆ¿è™Ÿ ${r.rid}ï¼ˆç©å®¶ï¼š${r.players}ï¼‰
          </div>
        `;
        const btn = document.createElement("button");
        btn.className = "btn btn-outline";
        btn.textContent = "åŠ å…¥";
        btn.onclick = () => {
          roomIdInput.value = r.rid;
          joinRoomBtn.click();
        };
        row.appendChild(btn);
        roomListEl.appendChild(row);
      });
    });
  }

  // å»ºç«‹æˆ¿é–“
  async function createRoom(roomId) {
    const roomRef = ref(db, `rooms/${roomId}`);
    const snap = await get(roomRef);
    if (snap.exists()) {
      alert("æ­¤æˆ¿è™Ÿå·²å­˜åœ¨ï¼Œè«‹æ”¹ç”¨åŠ å…¥æˆ–æ›ä¸€å€‹æˆ¿è™Ÿã€‚");
      return;
    }
    await set(roomRef, {
      info: {
        createdAt: serverTimestamp(),
        host: myUid
      },
      locked: false
    });
    return joinRoom(roomId, true);
  }

  // åŠ å…¥æˆ¿é–“
  async function joinRoom(roomId, createdNow = false) {
    if (!myNickname) {
      alert("è«‹å…ˆè¨­å®šæš±ç¨±");
      ensureNickname();
      return;
    }
    const roomRef = ref(db, `rooms/${roomId}`);
    const snap = await get(roomRef);
    if (!snap.exists()) {
      alert("æˆ¿é–“ä¸å­˜åœ¨ï¼Œè«‹å…ˆå»ºç«‹æˆ–ç¢ºèªæˆ¿è™Ÿã€‚");
      return;
    }

    const room = snap.val() || {};
    const host = room.info?.host;

    isRoomHost = !host || host === myUid; // æ²’ host æˆ– host æ˜¯è‡ªå·±ï¼Œå°±ç•¶ host
    if (!host) {
      await update(roomRef.child ? roomRef.child("info") : child(roomRef,"info"), {
        host: myUid
      }).catch(()=>{});
    }

    currentRoomId = roomId;

    // ç©å®¶è¨»å†Š
    const playerRef = ref(db, `rooms/${roomId}/players/${myUid}`);
    await set(playerRef, {
      nickname: myNickname,
      joinedAt: serverTimestamp()
    });

    // å¦‚æœæ²’æœ‰è‡ªå·±çš„å¡ç‰‡ï¼Œç”¢ä¸€å¼µ
    await ensureMyCard(roomId);

    // UI èª¿æ•´
    lobbyEl.style.display = "none";
    roomInfoIdEl.textContent = roomId;
    roomInfoNickEl.textContent = myNickname;

    listenRoomState(roomId);
    listenPlayers(roomId);
    listenLogs(roomId);

    firebasePushLog(roomId, `${myNickname} åŠ å…¥æˆ¿é–“`);
  }

  // ç›£è½æˆ¿é–“é–å®š / å…¬å…±è™Ÿç¢¼ / å¡ç‰‡ç­‰
  function listenRoomState(roomId) {
    const roomRef = ref(db, `rooms/${roomId}`);
    onValue(roomRef, (snap) => {
      const val = snap.val() || {};
      isLocked = !!val.locked;
      updateLockButtonUI();

      // å…¬å…±è™Ÿç¢¼é¡¯ç¤º
      const pubSelected = new Set();
      if (val.publicNumbers) {
        Object.keys(val.publicNumbers).forEach(num => {
          if (val.publicNumbers[num]) pubSelected.add(Number(num));
        });
      }
      renderPublicGrid(pubSelected);

      // æ›´æ–°å›åˆæç¤ºï¼ˆç°¡åŒ–ç‰ˆï¼Œåƒ…é¡¯ç¤ºæ˜¯å¦é–å®šï¼‰
      if (!isLocked) {
        turnHintEl.textContent = "å°šæœªé–å®šï¼Œè«‹æˆ¿ä¸»å…ˆé–å®šé–‹å§‹ã€‚";
      } else {
        turnHintEl.textContent = "éŠæˆ²å·²é–å®šï¼Œå¤§å®¶å¯ä»¥é–‹å§‹é¸è™Ÿã€‚";
      }
      updateAllButtonsEnabled();
    });
  }

  function listenPlayers(roomId) {
    const playersRef = ref(db, `rooms/${roomId}/players`);
    onValue(playersRef, (snap) => {
      const val = snap.val() || {};
      const list = Object.entries(val)
        .map(([uid,obj]) => ({
          uid, nick: obj.nickname || "ï¼ˆæœªå‘½åï¼‰"
        }))
        .sort((a,b)=> a.nick.localeCompare(b.nick,"zh-Hant"));
      renderPlayerList(list);
    });
  }

  // ====== å…¬å…±è™Ÿç¢¼ã€æˆ‘çš„å¡ç‰‡ ======

  // ç”¢ç”Ÿå¡ç‰‡
  async function ensureMyCard(roomId) {
    const cardRef = ref(db, `rooms/${roomId}/cards/${myUid}`);
    const snap = await get(cardRef);
    let nums;
    if (snap.exists()) {
      nums = snap.val();
    } else {
      const pool = [];
      for (let i=1;i<=50;i++) pool.push(i);
      pool.sort(()=>Math.random()-0.5);
      nums = pool.slice(0,25);
      await set(cardRef, nums);
    }
    myCardNumbers = nums;
    myCardSelected = new Set();
    renderMyCardGrid();
    updateBingoCount();
  }

  function renderPublicGrid(selectedSet = new Set()) {
    publicGridEl.innerHTML = "";
    for (let i=1;i<=50;i++) {
      const div = document.createElement("div");
      div.className = "num-btn";
      div.textContent = i;
      div.dataset.num = String(i);
      if (selectedSet.has(i)) div.classList.add("selected");
      if (!isLocked) {
        div.classList.add("pointer-forbidden");
      }
      publicGridEl.appendChild(div);
    }
  }

  function renderMyCardGrid() {
    myCardGridEl.innerHTML = "";
    myCardNumbers.forEach(num => {
      const div = document.createElement("div");
      div.className = "num-btn num-btn-mycard";
      div.textContent = num;
      div.dataset.num = String(num);
      if (myCardSelected.has(num)) div.classList.add("selected");
      myCardGridEl.appendChild(div);
    });
    updateAllButtonsEnabled();
  }

  function updateAllButtonsEnabled() {
    // å…¬å…±è™Ÿç¢¼ï¼šåªèƒ½é¡¯ç¤ºï¼Œç¦æ­¢ç›´æ¥é»
    publicGridEl.querySelectorAll(".num-btn").forEach(btn => {
      if (!isLocked) {
        btn.classList.add("pointer-forbidden");
      } else {
        btn.classList.remove("pointer-forbidden");
      }
    });

    // æˆ‘çš„å¡ç‰‡ï¼šé–å®šå‰ä¸èƒ½é»
    myCardGridEl.querySelectorAll(".num-btn").forEach(btn => {
      if (!isLocked) {
        btn.classList.add("disabled","pointer-forbidden");
      } else {
        btn.classList.remove("disabled","pointer-forbidden");
      }
    });

    // åˆ·æ–°æŒ‰éˆ•ï¼šé–å®šå¾Œå°±é–ä½é¿å…ä½œå¼Š
    refreshCardBtn.disabled = isLocked;

    // é–å®šæŒ‰éˆ•åªæœ‰æˆ¿ä¸»å¯ä»¥æŒ‰
    if (!isRoomHost || !currentRoomId) {
      lockBtn.disabled = true;
    } else {
      lockBtn.disabled = false;
    }
  }

  function updateLockButtonUI() {
    if (isLocked) {
      lockBtn.textContent = "å–æ¶ˆé–å®šï¼ˆçµæŸæœ¬å±€ï¼‰";
      lockBtn.classList.remove("lock-btn-unlock");
      lockBtn.classList.add("lock-btn-locked");
    } else {
      lockBtn.textContent = "é–å®šé–‹å§‹æœ¬å±€";
      lockBtn.classList.remove("lock-btn-locked");
      lockBtn.classList.add("lock-btn-unlock");
    }
  }

  // è¨ˆç®— BINGO æ¢æ•¸ï¼ˆè‡ªå·±å¡ç‰‡ï¼‰
  function computeBingoLines() {
    const marked = new Set(myCardSelected);
    let lines = 0;
    // 5x5
    const getNum = (r,c)=> myCardNumbers[r*5 + c];

    // row
    for (let r=0;r<5;r++) {
      let ok = true;
      for (let c=0;c<5;c++) {
        if (!marked.has(getNum(r,c))) { ok=false; break; }
      }
      if (ok) lines++;
    }
    // col
    for (let c=0;c<5;c++) {
      let ok = true;
      for (let r=0;r<5;r++) {
        if (!marked.has(getNum(r,c))) { ok=false; break; }
      }
      if (ok) lines++;
    }
    // diag 1
    let ok1 = true;
    for (let i=0;i<5;i++) {
      if (!marked.has(getNum(i,i))) { ok1=false; break; }
    }
    if (ok1) lines++;
    // diag 2
    let ok2 = true;
    for (let i=0;i<5;i++) {
      if (!marked.has(getNum(i,4-i))) { ok2=false; break; }
    }
    if (ok2) lines++;
    return lines;
  }

  function updateBingoCount() {
    const lines = computeBingoLines();
    bingoCountLabelEl.textContent = `ç›®å‰ BINGOï¼š${lines} æ¢`;
    if (lines > 0) {
      bingoCountLabelEl.classList.add("bingo-highlight");
    } else {
      bingoCountLabelEl.classList.remove("bingo-highlight");
    }

    // æ›´æ–°ç‚«è€€ç‹€æ…‹ï¼ˆå¦‚æœæ¢æ•¸å¢åŠ å°±é‡ç½®æ¬¡æ•¸ï¼‰
    if (lines > bragState.lastLines) {
      bragState.lastLines = lines;
      bragState.count = 0;
      bragBtn.disabled = lines === 0;
    } else if (lines === 0) {
      bragState.lastLines = 0;
      bragState.count = 0;
      bragBtn.disabled = true;
    } else {
      // æ¢æ•¸æ²’è®Šï¼šç¶­æŒåŸæœ‰ countï¼Œä½†å¦‚æœå·²é–æ­»å°±ä¿æŒ disabled
      if (bragState.count >= 3) {
        bragBtn.disabled = true;
      } else {
        bragBtn.disabled = false;
      }
    }
  }

  // ====== æ¸²æŸ“ç©å®¶åˆ—è¡¨ ======
  function renderPlayerList(list) {
    playerListEl.innerHTML = "";
    list.forEach(p => {
      const row = document.createElement("div");
      row.className = "player-row";
      row.innerHTML = `
        <div>${p.uid === myUid ? "ğŸ‘¤" : "ğŸ§‘"} ${p.nick}</div>
        ${p.uid === myUid ? "<span style='font-size:11px;color:#ff9800;'>(ä½ )</span>" : ""}
      `;
      playerListEl.appendChild(row);
    });
  }

  // ====== äº‹ä»¶ç¶å®š ======

  // å»ºç«‹æˆ¿é–“
  createRoomBtn.addEventListener("click", async () => {
    const roomId = roomIdInput.value.trim();
    if (!roomId) {
      alert("è«‹è¼¸å…¥æˆ¿è™Ÿ");
      return;
    }
    await createRoom(roomId);
  });

  // åŠ å…¥æˆ¿é–“
  joinRoomBtn.addEventListener("click", async () => {
    const roomId = roomIdInput.value.trim();
    if (!roomId) {
      alert("è«‹è¼¸å…¥æˆ¿è™Ÿ");
      return;
    }
    await joinRoom(roomId, false);
  });

  // é–å®š / è§£é–
  lockBtn.addEventListener("click", async () => {
    if (!currentRoomId || !isRoomHost) return;

    const newLocked = !isLocked;
    if (!newLocked) {
      // è§£é™¤é–å®šæ™‚å•ä¸€ä¸‹
      if (!confirm("ç¢ºå®šè¦çµæŸæ­¤å±€ä¸¦è§£é™¤é–å®šï¼Ÿ\nå…¬å…±è™Ÿç¢¼æœƒæ¸…é™¤ï¼Œä½†å„è‡ªå¡ç‰‡çš„å‹¾é¸ä¸æœƒè¢«åˆªé™¤ã€‚")) {
        return;
      }
      // æ¸…ç©ºå…¬å…±è™Ÿç¢¼
      await remove(ref(db, `rooms/${currentRoomId}/publicNumbers`));
      firebasePushLog(currentRoomId, `${myNickname} å–æ¶ˆé–å®šï¼ŒçµæŸæœ¬å±€ã€‚`);
    } else {
      firebasePushLog(currentRoomId, `${myNickname} é–å®šé–‹å§‹æœ¬å±€ã€‚`);
    }

    await update(ref(db, `rooms/${currentRoomId}`), {
      locked: newLocked
    });
  });

  // é‡æ–°æŠ½å¡ç‰‡ï¼ˆåªèƒ½åœ¨æœªé–å®šæ™‚ï¼‰
  refreshCardBtn.addEventListener("click", async () => {
    if (!currentRoomId) return;
    if (isLocked) return;
    if (!confirm("ç¢ºå®šè¦é‡æ–°æŠ½å¡ç‰‡ï¼Ÿ")) return;

    const pool = [];
    for (let i=1;i<=50;i++) pool.push(i);
    pool.sort(()=>Math.random()-0.5);
    const nums = pool.slice(0,25);
    await set(ref(db, `rooms/${currentRoomId}/cards/${myUid}`), nums);

    myCardNumbers = nums;
    myCardSelected.clear();
    renderMyCardGrid();
    updateBingoCount();

    firebasePushLog(currentRoomId, `${myNickname} é‡æ–°æŠ½å¡ç‰‡`);
  });

  // é»ã€Œæˆ‘çš„å¡ç‰‡ã€ä¸Šçš„è™Ÿç¢¼
  myCardGridEl.addEventListener("click", async (e) => {
    const target = e.target.closest(".num-btn");
    if (!target || !currentRoomId) return;
    if (!isLocked) return; // é–å®šå‰ä¸èƒ½é»
    if (target.classList.contains("disabled")) return;

    const num = Number(target.dataset.num);
    const isSelected = myCardSelected.has(num);

    if (isSelected) {
      myCardSelected.delete(num);
      target.classList.remove("selected");
      firebasePushLog(currentRoomId, `${myNickname}: å–æ¶ˆ ${num}`);
      // å…¬å…±è™Ÿç¢¼æ”¹æˆ false
      await update(ref(db, `rooms/${currentRoomId}/publicNumbers`), {
        [num]: false
      });
    } else {
      myCardSelected.add(num);
      target.classList.add("selected");
      firebasePushLog(currentRoomId, `${myNickname}: ${num}`);
      await update(ref(db, `rooms/${currentRoomId}/publicNumbers`), {
        [num]: true
      });
    }
    updateBingoCount();
  });

  // ç‚«è€€æŒ‰éˆ•
  bragBtn.addEventListener("click", () => {
    const lines = computeBingoLines();
    if (lines <= 0) return;

    // æ¢æ•¸æ²’è®Šæ‰æª¢æŸ¥æ¬¡æ•¸
    if (lines === bragState.lastLines) {
      if (bragState.count >= 3) {
        bragBtn.disabled = true;
        alert("ä½èª¿ï¼ä½èª¿ï¼");
        return;
      }
      bragState.count++;
    } else {
      // æ¢æ•¸æ”¹è®Š
      bragState.lastLines = lines;
      bragState.count = 1;
    }

    if (!currentRoomId) return;
    firebasePushLog(currentRoomId, `${myNickname} ç‚«è€€ï¼ç›®å‰ BINGO ${lines} æ¢ï½`);
  });

  // ====== åˆå§‹åŒ– ======
  ensureMyUid();
  ensureNickname();
  listenRoomList();

  // å¦‚æœæš±ç¨±å½ˆçª—é‚„æ²’é—œï¼Œé˜»æ­¢ç›´æ¥å»ºç«‹ / åŠ å…¥
  [createRoomBtn, joinRoomBtn].forEach(btn => {
    btn.addEventListener("click", (e) => {
      if (!myNickname) {
        e.preventDefault();
        alert("è«‹å…ˆè¨­å®šæš±ç¨±");
        ensureNickname();
      }
    }, { capture:true });
  });
</script>
</body>
</html>
