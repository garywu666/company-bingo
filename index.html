<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å…¬å¸ Bingo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --main-bg: #f5f5f5;
      --panel-bg: #ffffff;
      --primary: #3f51b5;
      --primary-dark: #283593;
      --primary-light: #c5cae9;
      --danger: #e53935;
      --text-main: #222;
      --text-sub: #666;
      --border: #ddd;
      --btn-disabled: #ccc;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Microsoft JhengHei", sans-serif;
    }

    body {
      margin: 0;
      background: var(--main-bg);
      color: var(--text-main);
    }

    h1, h2, h3, h4 {
      margin: 0;
      font-weight: 600;
    }

    button {
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s, transform 0.05s;
    }

    button:hover:not(:disabled) {
      background: #f0f0f0;
    }

    button:active:not(:disabled) {
      transform: translateY(1px);
    }

    button:disabled {
      background: var(--btn-disabled);
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary-dark);
      color: #fff;
    }
    .btn-primary:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    .btn-danger {
      background: var(--danger);
      border-color: #b71c1c;
      color: #fff;
    }

    .hidden {
      display: none !important;
    }

    #app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px;
    }

    /* å¤§å»³å€ */
    #lobby {
      background: var(--panel-bg);
      border-radius: 8px;
      padding: 12px 16px 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,.06);
    }

    #lobby-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    #lobby-room-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }

    #lobby-room-form input {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
      font-size: 14px;
    }

    #roomList {
      border-top: 1px solid var(--border);
      padding-top: 10px;
      max-height: 180px;
      overflow-y: auto;
      font-size: 14px;
    }

    .room-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px dashed #eee;
    }

    .room-row span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* æˆ¿é–“ä¸»å€åŸŸä½ˆå±€ */
    #roomSection {
      background: var(--panel-bg);
      border-radius: 8px;
      padding: 10px 12px 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,.06);
    }

    #roomHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    #roomHeader-left {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    #roomHeader-right {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    #roomMainLayout {
      display: grid;
      grid-template-columns: 220px minmax(0, 1fr) 260px;
      gap: 10px;
      align-items: flex-start;
    }

    @media (max-width: 980px) {
      #roomMainLayout {
        grid-template-columns: 1fr;
      }
    }

    /* å·¦å´ç©å®¶æ’åº panel */
    .panel {
      background: #fafafa;
      border-radius: 6px;
      border: 1px solid var(--border);
      padding: 8px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      margin-bottom: 4px;
    }

    #playersList {
      margin: 4px 0 8px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 14px;
    }

    .player-row {
      padding: 4px 6px;
      margin-bottom: 2px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .player-row:hover {
      background: #f5f5f5;
    }

    .player-row.order-assigned {
      border-color: var(--primary);
      background: #e8eaf6;
    }

    .player-name {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .player-order {
      font-size: 12px;
      color: var(--primary-dark);
      min-width: 30px;
      text-align: right;
    }

    .icon-host {
      font-size: 14px;
    }

    #playersPanel-footer {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    /* ä¸­é–“ï¼šå…¬å…±è™Ÿç¢¼ï¼‹æˆ‘çš„å¡ç‰‡ */
    #turnIndicator {
      text-align: center;
      font-size: 15px;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--primary-dark);
    }

    #publicBoard-title {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 4px;
      gap: 8px;
    }

    #publicBoard-title span {
      font-weight: 600;
    }

    #publicBoard {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      margin-bottom: 10px;
    }

    .num-btn,
    .card-btn {
      width: 100%;
      padding: 10px 0;
      border-radius: 4px;
      font-size: 13px;
      background: #fff;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border 0.15s, transform 0.05s;
    }

    .num-btn.selected,
    .card-btn.selected {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary-dark);
    }

    .num-btn:disabled,
    .card-btn:disabled {
      cursor: not-allowed;
    }

    /* æˆ‘çš„å¡ç‰‡ */
    #myCardHeader {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 6px 0 4px;
    }

    #bingoCountLabel {
      font-weight: 600;
      color: #2e7d32;
    }

    #myCard {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 4px;
    }

    .card-btn {
      aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢ */
    }

    /* å³å´æ—¥èªŒ */
    #logContent {
      background: #111;
      color: #fff;
      padding: 6px;
      border-radius: 4px;
      max-height: 360px;
      overflow-y: auto;
      font-size: 12px;
      white-space: pre-wrap;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal {
      background: #fff;
      border-radius: 8px;
      padding: 14px 16px 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,.25);
      max-width: 360px;
      width: 100%;
      font-size: 14px;
    }

    .modal h2 {
      margin-bottom: 8px;
      font-size: 18px;
    }

    .modal input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
      margin: 6px 0 10px;
      font-size: 14px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    /* å°æç¤ºæ–‡å­— */
    .text-muted {
      color: var(--text-sub);
      font-size: 12px;
    }

    .badge-lock {
      font-size: 13px;
      color: var(--danger);
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- æš±ç¨±è¼¸å…¥ Modal -->
    <div id="nicknameModalBackdrop" class="modal-backdrop hidden">
      <div class="modal">
        <h2>è«‹è¼¸å…¥æš±ç¨±</h2>
        <div class="text-muted">é€™å€‹æš±ç¨±æœƒè¨˜åœ¨ç€è¦½å™¨ï¼Œä¸‹æ¬¡é€²ä¾†æœƒè‡ªå‹•å¹«ä½ å¸¶å…¥ã€‚</div>
        <input id="nicknameInput" maxlength="12" placeholder="ä¾‹å¦‚ï¼šèŠ±èŠ±ã€è³¢ã€GARY..." />
        <div class="modal-footer">
          <button id="nicknameConfirmBtn" class="btn-primary">ç¢ºå®š</button>
        </div>
      </div>
    </div>

    <!-- æº–å‚™ä¸­ Modal -->
    <div id="readyModalBackdrop" class="modal-backdrop hidden">
      <div class="modal">
        <h2>éŠæˆ²æº–å‚™ä¸­</h2>
        <div id="readyStatusText" class="text-muted" style="margin-bottom:8px;">
          æˆ¿ä¸»å·²é–å®šï¼Œè«‹å¤§å®¶æŒ‰ã€Œæº–å‚™ã€æˆ–ã€Œå–æ¶ˆã€ã€‚
        </div>
        <div id="readyPlayerList" class="text-muted" style="max-height:160px;overflow-y:auto;"></div>
        <div class="modal-footer">
          <button id="readyCancelBtn">å–æ¶ˆ</button>
          <button id="readyOkBtn" class="btn-primary">æº–å‚™</button>
        </div>
      </div>
    </div>

    <!-- å¤§å»³ -->
    <section id="lobby">
      <div id="lobby-header">
        <div>
          <h1 style="font-size:20px;">å…¬å¸ Bingo å¤§å»³</h1>
          <div id="nicknameDisplay" class="text-muted"></div>
        </div>
        <button id="scrollToRoomBtn" class="btn-primary hidden">åˆ‡æ›åˆ°æˆ¿é–“ç•«é¢</button>
      </div>

      <div id="lobby-room-form">
        <span>æˆ¿è™Ÿï¼š</span>
        <input id="roomIdInput" placeholder="ä¾‹å¦‚ï¼šA01 æˆ– è‡ªè¨‚åç¨±" />
        <span>å¯†ç¢¼ï¼š</span>
        <input id="roomPwdInput" placeholder="å¯ç•™ç©º" />
        <button id="createRoomBtn" class="btn-primary">å»ºç«‹æˆ¿é–“</button>
        <button id="joinRoomBtn">åŠ å…¥æˆ¿é–“</button>
      </div>

      <div class="text-muted" style="margin-bottom:4px;">å·²å»ºç«‹æˆ¿é–“ï¼š</div>
      <div id="roomList"></div>
    </section>

    <!-- æˆ¿é–“ -->
    <section id="roomSection" class="hidden">
      <div id="roomHeader">
        <div id="roomHeader-left">
          <span>æˆ¿è™Ÿï¼š<strong id="currentRoomIdLabel">-</strong></span>
          <span>æš±ç¨±ï¼š<strong id="currentNicknameLabel">-</strong></span>
        </div>
        <div id="roomHeader-right">
          <button id="toggleLobbyBtn">é¡¯ç¤º / éš±è—æˆ¿é–“è¨­å®š</button>
        </div>
      </div>

      <div id="roomMainLayout">
        <!-- å·¦ï¼šç©å®¶æ’åº -->
        <aside id="playersPanel" class="panel">
          <div class="panel-header">
            <span>ç©å®¶æ’åº</span>
            <button id="lockBtn" class="btn-primary" disabled>é–å®š</button>
          </div>
          <div class="text-muted" style="font-size:12px;margin-bottom:4px;">
            åªæœ‰æˆ¿ä¸»å¯é»æ“Šç©å®¶è¡Œä¾†è¨­å®šé †åºï¼›å†æ¬¡é»æ“Šå¯å–æ¶ˆæ’åºã€‚
          </div>
          <div id="playersList"></div>
          <div id="playersPanel-footer">
            <button id="clearOrderBtn">æ¸…é™¤æ’åº</button>
            <button id="refreshCardBtn">åˆ·æ–°æˆ‘çš„å¡ç‰‡</button>
          </div>
        </aside>

        <!-- ä¸­ï¼šå…¬å…±è™Ÿç¢¼ + æˆ‘çš„å¡ç‰‡ -->
        <main id="centerPanel">
          <div id="turnIndicator">è«‹å…ˆå»ºç«‹æˆ¿é–“ä¸¦é–å®šé–‹å§‹éŠæˆ²</div>

          <div id="publicBoard-title">
            <span>å…¬å…±è™Ÿç¢¼ï¼ˆ1â€“50ï¼‰</span>
          </div>
          <div id="publicBoard"></div>

          <div id="myCardHeader">
            <button id="bragBtn" disabled>ç‚«è€€</button>
            <span id="bingoCountLabel">ç›®å‰ BINGOï¼š0 æ¢</span>
          </div>
          <div id="myCard"></div>
        </main>

        <!-- å³ï¼šæ—¥èªŒ -->
        <aside id="logPanel" class="panel">
          <div class="panel-header">
            <span>æ—¥èªŒ</span>
          </div>
          <pre id="logContent"></pre>
        </aside>
      </div>
    </section>
  </div>

  <script type="module">
    "use strict";

    /**************** Firebase åˆå§‹åŒ– ***************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
      update,
      push,
      serverTimestamp,
      onDisconnect,
      get,
      child,
      remove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB4IBPbuGxztyzd8E3YTitMoTt8L19MSG0",
      authDomain: "company-bingo.firebaseapp.com",
      databaseURL: "https://company-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "company-bingo",
      storageBucket: "company-bingo.firebasestorage.app",
      messagingSenderId: "844173689886",
      appId: "1:844173689886:web:ac2f1888f542b138861a0f",
      measurementId: "G-WGDVJPKMEH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /**************** DOM æŠ“å– ***************/
    const nicknameModalBackdrop = document.getElementById("nicknameModalBackdrop");
    const nicknameInput = document.getElementById("nicknameInput");
    const nicknameConfirmBtn = document.getElementById("nicknameConfirmBtn");
    const nicknameDisplay = document.getElementById("nicknameDisplay");
    const scrollToRoomBtn = document.getElementById("scrollToRoomBtn");

    const lobby = document.getElementById("lobby");
    const roomSection = document.getElementById("roomSection");

    const roomIdInput = document.getElementById("roomIdInput");
    const roomPwdInput = document.getElementById("roomPwdInput");
    const createRoomBtn = document.getElementById("createRoomBtn");
    const joinRoomBtn = document.getElementById("joinRoomBtn");
    const roomList = document.getElementById("roomList");

    const currentRoomIdLabel = document.getElementById("currentRoomIdLabel");
    const currentNicknameLabel = document.getElementById("currentNicknameLabel");
    const toggleLobbyBtn = document.getElementById("toggleLobbyBtn");

    const playersList = document.getElementById("playersList");
    const lockBtn = document.getElementById("lockBtn");
    const clearOrderBtn = document.getElementById("clearOrderBtn");
    const refreshCardBtn = document.getElementById("refreshCardBtn");

    const publicBoard = document.getElementById("publicBoard");
    const myCardContainer = document.getElementById("myCard");
    const turnIndicator = document.getElementById("turnIndicator");
    const bingoCountLabel = document.getElementById("bingoCountLabel");
    const bragBtn = document.getElementById("bragBtn");

    const logContent = document.getElementById("logContent");

    const readyModalBackdrop = document.getElementById("readyModalBackdrop");
    const readyStatusText = document.getElementById("readyStatusText");
    const readyPlayerList = document.getElementById("readyPlayerList");
    const readyOkBtn = document.getElementById("readyOkBtn");
    const readyCancelBtn = document.getElementById("readyCancelBtn");

    /**************** å…¨å±€ç‹€æ…‹ ***************/
    let uid = localStorage.getItem("company-bingo-uid");
    if (!uid) {
      uid = "u_" + Math.random().toString(36).slice(2);
      localStorage.setItem("company-bingo-uid", uid);
    }

    let nickname = localStorage.getItem("company-bingo-nickname") || "";
    let currentRoomId = null;
    let currentRoomUnsub = null;
    let currentRoomData = null;
    let myCardNumbers = [];        // 25 å€‹æ•¸å­—
    let boardSelected = {};        // { num: true }
    let bragLinesLast = 0;
    let bragTimesAtThisLines = 0;  // åŒæ¢æ•¸å·²ç‚«è€€å¹¾æ¬¡

    const numButtons = new Map();  // å…¬å…±è™Ÿç¢¼æŒ‰éˆ•
    const cardButtons = new Map(); // è‡ªå·±å¡ç‰‡æŒ‰éˆ• (ç”¨ number ç•¶ key)

    /**************** å·¥å…· ***************/
    function showNicknameModal() {
      nicknameModalBackdrop.classList.remove("hidden");
      nicknameInput.value = nickname || "";
      nicknameInput.focus();
    }

    function hideNicknameModal() {
      nicknameModalBackdrop.classList.add("hidden");
    }

    function ensureNickname() {
      nicknameDisplay.textContent = nickname ? `ç›®å‰æš±ç¨±ï¼š${nickname}` : "å°šæœªè¨­å®šæš±ç¨±";
      if (!nickname) {
        showNicknameModal();
      }
    }

    function pushLog(text) {
      if (!currentRoomId) return;
      const logsRef = ref(db, `rooms/${currentRoomId}/logs`);
      push(logsRef, {
        text,
        time: serverTimestamp()
      });
    }

    function formatTime(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      const ss = String(d.getSeconds()).padStart(2, "0");
      return `${hh}:${mm}:${ss}`;
    }

    function randomCardNumbers() {
      const arr = [];
      for (let i = 1; i <= 50; i++) arr.push(i);
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr.slice(0, 25);
    }

    function countBingoLines(cardNums, selectedMap) {
      if (!cardNums || cardNums.length !== 25) return 0;
      const grid = [];
      for (let r = 0; r < 5; r++) {
        grid[r] = [];
        for (let c = 0; c < 5; c++) {
          grid[r][c] = selectedMap[cardNums[r * 5 + c]] ? 1 : 0;
        }
      }
      let lines = 0;
      // rows
      for (let r = 0; r < 5; r++) {
        if (grid[r].every(v => v === 1)) lines++;
      }
      // cols
      for (let c = 0; c < 5; c++) {
        let ok = true;
        for (let r = 0; r < 5; r++) if (!grid[r][c]) ok = false;
        if (ok) lines++;
      }
      // diag 1
      let ok = true;
      for (let i = 0; i < 5; i++) if (!grid[i][i]) ok = false;
      if (ok) lines++;
      // diag 2
      ok = true;
      for (let i = 0; i < 5; i++) if (!grid[i][4 - i]) ok = false;
      if (ok) lines++;
      return lines;
    }

    function renderBingoAndBrag() {
      const lines = countBingoLines(myCardNumbers, boardSelected);
      bingoCountLabel.textContent = `ç›®å‰ BINGOï¼š${lines} æ¢`;

      if (lines <= 0) {
        bragBtn.disabled = true;
        bragLinesLast = 0;
        bragTimesAtThisLines = 0;
        return;
      }

      if (lines !== bragLinesLast) {
        // æ¢æ•¸è®Šå¤šäº†ï¼Œé‡ç½®ç‚«è€€æ¬¡æ•¸
        bragLinesLast = lines;
        bragTimesAtThisLines = 0;
      }
      // æœ‰æ¢æ•¸å°±å¯æŒ‰ï¼Œä½†è‹¥å·²è¶…é 3 æ¬¡å°±ç¦ç”¨
      bragBtn.disabled = bragTimesAtThisLines >= 3;
    }

    function setRoomSectionVisible(visible) {
      if (visible) {
        roomSection.classList.remove("hidden");
        scrollToRoomBtn.classList.remove("hidden");
      } else {
        roomSection.classList.remove("hidden");
        // é è¨­å…ˆé¡¯ç¤ºï¼Œæ²’åŠ å…¥æˆ¿å°±åªæ˜¯ç©ºæ®¼
      }
    }

    /**************** å…¬å…±è™Ÿç¢¼ & æˆ‘çš„å¡ç‰‡ UI åˆå§‹åŒ– ***************/
    function initPublicBoardUI() {
      publicBoard.innerHTML = "";
      numButtons.clear();
      for (let i = 1; i <= 50; i++) {
        const btn = document.createElement("button");
        btn.className = "num-btn";
        btn.textContent = String(i);
        btn.dataset.number = String(i);
        btn.disabled = true; // ä¸€é–‹å§‹ä¸èƒ½é»
        btn.addEventListener("click", () => handleNumberClick(i));
        publicBoard.appendChild(btn);
        numButtons.set(i, btn);
      }
    }

    function initMyCardUI() {
      myCardContainer.innerHTML = "";
      cardButtons.clear();
      if (!myCardNumbers || myCardNumbers.length !== 25) return;
      for (let i = 0; i < 25; i++) {
        const num = myCardNumbers[i];
        const btn = document.createElement("button");
        btn.className = "card-btn";
        btn.textContent = String(num);
        btn.dataset.number = String(num);
        btn.disabled = true;
        btn.addEventListener("click", () => handleNumberClick(num));
        myCardContainer.appendChild(btn);
        cardButtons.set(num, btn);
      }
    }

    function updateBoardButtonsDisabled() {
      const playing = currentRoomData && currentRoomData.gameState === "playing";
      const enabled = !!(playing && currentRoomData.locked);
      for (const btn of numButtons.values()) {
        btn.disabled = !enabled;
      }
      for (const btn of cardButtons.values()) {
        btn.disabled = !enabled;
      }
    }

    function syncBoardSelectionUI() {
      // boardSelected ä¾†è‡ª currentRoomData.board
      for (let i = 1; i <= 50; i++) {
        const selected = !!boardSelected[i];
        const btn = numButtons.get(i);
        if (btn) {
          btn.classList.toggle("selected", selected);
        }
        const cbtn = cardButtons.get(i);
        if (cbtn) {
          cbtn.classList.toggle("selected", selected);
        }
      }
    }

    /**************** è™•ç†è™Ÿç¢¼é»æ“Š ***************/
    function handleNumberClick(number) {
      if (!currentRoomId || !currentRoomData) return;
      const playing = currentRoomData.gameState === "playing" && currentRoomData.locked;
      if (!playing) return;

      const already = !!boardSelected[number];
      const text = already ? `${nickname}:å–æ¶ˆ${number}` : `${nickname}:${number}`;

      const newVal = {...boardSelected};
      if (already) {
        delete newVal[number];
      } else {
        newVal[number] = true;
      }

      update(ref(db, `rooms/${currentRoomId}`), {
        board: newVal
      });
      pushLog(text);
    }

    /**************** æˆ¿é–“è³‡æ–™ç›£è½ & æ¸²æŸ“ ***************/
    function subscribeRoom(roomId) {
      if (currentRoomUnsub) currentRoomUnsub();
      currentRoomId = roomId;
      currentRoomIdLabel.textContent = roomId;
      currentNicknameLabel.textContent = nickname;

      const roomRef = ref(db, `rooms/${roomId}`);
      const off = onValue(roomRef, snap => {
        const data = snap.val();
        if (!data) {
          // æˆ¿é–“è¢«åˆªé™¤
          currentRoomData = null;
          turnIndicator.textContent = "æˆ¿é–“å·²ä¸å­˜åœ¨ã€‚è«‹å›å¤§å»³é‡æ–°å»ºç«‹ã€‚";
          return;
        }
        currentRoomData = data;

        // ç©å®¶åˆ—è¡¨ / æ’åº / æˆ¿ä¸»
        renderPlayersPanel();

        // Board è³‡è¨Š
        boardSelected = data.board || {};
        syncBoardSelectionUI();
        renderBingoAndBrag();
        updateBoardButtonsDisabled();

        // Turn æç¤ºï¼ˆåƒ…å±•ç¤ºèª°æ˜¯â‘ â‘¡â‘¢ï¼Œä¸å¼·åˆ¶ï¼‰
        if (data.gameState === "playing") {
          const players = getOrderedPlayers();
          if (players.length > 0) {
            const currentOrder = data.currentTurnOrder || 1;
            const p = players.find(p => p.order === currentOrder) || players[0];
            const orderLabel = "â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©".charAt((p.order || 1) - 1) || `ç¬¬${p.order}ä½`;
            turnIndicator.textContent = `${p.nickname}ï¼ˆ${orderLabel}ï¼‰ï¼Œè«‹é¸è™Ÿï¼`;
          } else {
            turnIndicator.textContent = "éŠæˆ²ä¸­ï¼Œå°šæœªæœ‰æ’åºè³‡è¨Šã€‚";
          }
        } else if (data.gameState === "readyCheck") {
          turnIndicator.textContent = "éŠæˆ²æº–å‚™ä¸­ï¼Œè«‹åœ¨å½ˆçª—å…§æŒ‰ã€Œæº–å‚™ã€æˆ–ã€Œå–æ¶ˆã€ã€‚";
        } else {
          turnIndicator.textContent = "è«‹ç”±æˆ¿ä¸»è¨­å®šæ’åºä¸¦é–å®šå¾Œé–‹å§‹éŠæˆ²ã€‚";
        }

        // æ—¥èªŒ
        renderLogs(data.logs || {});

        // æº–å‚™ä¸­ modal é¡¯ç¤ºèˆ‡å¦
        renderReadyModal();
      });
      currentRoomUnsub = () => off();
    }

    function getPlayersMap() {
      return (currentRoomData && currentRoomData.players) || {};
    }

    function getOrderedPlayers() {
      const players = [];
      const map = getPlayersMap();
      for (const pid in map) {
        players.push({ uid: pid, ...map[pid] });
      }
      players.sort((a, b) => {
        const oa = a.order || 0;
        const ob = b.order || 0;
        if (oa === 0 && ob === 0) return a.nickname.localeCompare(b.nickname);
        if (oa === 0) return 1;
        if (ob === 0) return -1;
        return oa - ob;
      });
      return players;
    }

    function renderPlayersPanel() {
      const data = currentRoomData;
      const players = getOrderedPlayers();
      const hostUid = data.hostUid;
      const amHost = hostUid === uid;

      lockBtn.disabled = !amHost;
      clearOrderBtn.disabled = !amHost;
      refreshCardBtn.disabled = !!(data.locked); // é–å®šå¾Œä¸èƒ½å†åˆ·æ–°

      lockBtn.textContent = data.locked ? "å–æ¶ˆé–å®š" : "é–å®š";

      playersList.innerHTML = "";
      const playersMap = getPlayersMap();
      const allPlayers = [];
      for (const pid in playersMap) {
        allPlayers.push({ uid: pid, ...playersMap[pid] });
      }
      // ä¾ç…§ render çš„æ’åº
      for (const p of players) {
        const row = document.createElement("div");
        row.className = "player-row";
        if (p.order) row.classList.add("order-assigned");
        row.dataset.uid = p.uid;

        const namePart = document.createElement("div");
        namePart.className = "player-name";
        const icon = document.createElement("span");
        icon.textContent = p.uid === hostUid ? "ğŸ‘‘" : "ğŸ‘¤";
        icon.className = "icon-host";
        const nameText = document.createElement("span");
        nameText.textContent = p.nickname || "(æœªå‘½å)";
        namePart.appendChild(icon);
        namePart.appendChild(nameText);

        const orderSpan = document.createElement("span");
        orderSpan.className = "player-order";
        if (p.order) {
          const idx = p.order - 1;
          const nums = "â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©";
          orderSpan.textContent = nums[idx] || `ç¬¬${p.order}`;
        } else {
          orderSpan.textContent = "";
        }

        row.appendChild(namePart);
        row.appendChild(orderSpan);

        if (amHost) {
          row.addEventListener("click", () => togglePlayerOrder(p.uid));
        }

        playersList.appendChild(row);
      }
    }

    function renderLogs(logsObj) {
      const entries = [];
      for (const key in logsObj) {
        const item = logsObj[key];
        entries.push({ key, ...item });
      }
      entries.sort((a, b) => (a.time || 0) - (b.time || 0));
      const lines = entries.map(e => {
        const t = formatTime(e.time);
        return t ? `[${t}] ${e.text}` : e.text;
      });
      logContent.textContent = lines.join("\n");
      logContent.scrollTop = logContent.scrollHeight;
    }

    function renderReadyModal() {
      const data = currentRoomData;
      if (!data) {
        readyModalBackdrop.classList.add("hidden");
        return;
      }
      if (data.gameState !== "readyCheck") {
        readyModalBackdrop.classList.add("hidden");
        return;
      }
      readyModalBackdrop.classList.remove("hidden");

      const players = getOrderedPlayers();
      readyPlayerList.innerHTML = "";
      for (const p of players) {
        const ready = !!p.ready;
        const div = document.createElement("div");
        div.textContent = `${p.uid === data.hostUid ? "ğŸ‘‘" : "ğŸ‘¤"}${p.nickname}ï¼š${ready ? "å·²æº–å‚™" : "ç­‰å€™æº–å‚™"}`;
        readyPlayerList.appendChild(div);
      }
    }

    function togglePlayerOrder(targetUid) {
      if (!currentRoomId || !currentRoomData) return;
      const players = getPlayersMap();
      const meIsHost = currentRoomData.hostUid === uid;
      if (!meIsHost) return;

      const current = players[targetUid];
      if (!current) return;

      const allOrders = Object.values(players)
        .map(p => p.order || 0)
        .filter(o => o > 0)
        .sort((a, b) => a - b);
      const maxOrder = allOrders.length ? allOrders[allOrders.length - 1] : 0;

      let newOrder = null;
      if (!current.order) {
        newOrder = maxOrder + 1;
      } else {
        newOrder = null; // å–æ¶ˆæ’åº
      }
      update(ref(db, `rooms/${currentRoomId}/players/${targetUid}`), {
        order: newOrder
      });
    }

    /**************** æº–å‚™æµç¨‹ & é–å®š ***************/
    function handleLockClick() {
      if (!currentRoomId || !currentRoomData) return;
      const amHost = currentRoomData.hostUid === uid;
      if (!amHost) return;

      if (!currentRoomData.locked) {
        // æº–å‚™é–å®šï¼šæª¢æŸ¥æ‰€æœ‰ç©å®¶æ˜¯å¦éƒ½æœ‰ order
        const players = getPlayersMap();
        const list = Object.values(players);
        if (!list.length) {
          alert("ç›®å‰æˆ¿é–“æ²’æœ‰ç©å®¶ã€‚");
          return;
        }
        const anyoneNoOrder = list.some(p => !p.order);
        if (anyoneNoOrder) {
          alert("è«‹å…ˆç‚ºæ‰€æœ‰ç©å®¶è¨­å®šå·¦å´é †ä½æ’åºå¾Œï¼Œå†é–å®šã€‚");
          return;
        }

        // é€²å…¥ readyCheck ç‹€æ…‹ï¼Œæ‰€æœ‰ ready æ¸…é™¤
        const updates = {};
        for (const pid in players) {
          updates[`players/${pid}/ready`] = false;
        }
        updates["locked"] = true;
        updates["gameState"] = "readyCheck";
        update(ref(db, `rooms/${currentRoomId}`), updates);
        pushLog(`${nickname}: ç™¼èµ·é–å®šï¼Œè«‹å¤§å®¶æº–å‚™ã€‚`);
      } else {
        // å–æ¶ˆé–å®šï¼šçµæŸæœ¬å±€ä¸¦æ¸…ç©ºå…¬å…±è™Ÿç¢¼
        const ok = confirm("ç¢ºå®šè¦å–æ¶ˆé–å®šä¸¦çµæŸæœ¬å±€å—ï¼Ÿå…¬å…±è™Ÿç¢¼å°‡å…¨éƒ¨æ¸…é™¤ã€‚");
        if (!ok) return;
        update(ref(db, `rooms/${currentRoomId}`), {
          locked: false,
          gameState: "waiting",
          board: null,
          currentTurnOrder: null
        });
        pushLog(`${nickname}: å–æ¶ˆé–å®šï¼ŒçµæŸæœ¬å±€ã€‚`);
      }
    }

    function handleReadyOk() {
      if (!currentRoomId || !currentRoomData) return;
      update(ref(db, `rooms/${currentRoomId}/players/${uid}`), {
        ready: true
      });
      pushLog(`${nickname}: å·²æº–å‚™`);
      // è‹¥æ‰€æœ‰äººæº–å‚™å¥½ï¼Œç”±æˆ¿ä¸»å•Ÿå‹•éŠæˆ²
      maybeStartGameWhenAllReady();
    }

    function handleReadyCancel() {
      if (!currentRoomId || !currentRoomData) return;
      // ä»»ä¸€äººå–æ¶ˆ -> å›åˆ° waiting
      update(ref(db, `rooms/${currentRoomId}`), {
        locked: false,
        gameState: "waiting"
      });
      pushLog(`${nickname}: ä½ å€‘å…ˆåˆ¥æ€¥`);
    }

    function maybeStartGameWhenAllReady() {
      if (!currentRoomData) return;
      const amHost = currentRoomData.hostUid === uid;
      if (!amHost) return;
      if (currentRoomData.gameState !== "readyCheck") return;

      const players = getPlayersMap();
      const list = Object.values(players);
      if (!list.length) return;

      const allReady = list.every(p => !!p.ready);
      if (!allReady) return;

      // æ‰€æœ‰äººéƒ½æº–å‚™å¥½ï¼Œé–‹å§‹éŠæˆ²
      const ordered = getOrderedPlayers();
      const firstOrder = ordered.length ? (ordered[0].order || 1) : 1;
      update(ref(db, `rooms/${currentRoomId}`), {
        gameState: "playing",
        locked: true,
        currentTurnOrder: firstOrder
      });
      pushLog("æ‰€æœ‰äººéƒ½å·²æº–å‚™ï¼ŒéŠæˆ²é–‹å§‹ï¼");
    }

    /**************** ç‚«è€€ ***************/
    function handleBragClick() {
      if (!currentRoomId) return;
      const lines = countBingoLines(myCardNumbers, boardSelected);
      if (lines <= 0) return;

      if (lines !== bragLinesLast) {
        // ç†è«–ä¸Š renderBingoAndBrag å·²è™•ç†ï¼Œä¸éå†é˜²å‘†ä¸€æ¬¡
        bragLinesLast = lines;
        bragTimesAtThisLines = 0;
      }
      if (bragTimesAtThisLines >= 3) {
        alert("ä½èª¿!ä½èª¿! ğŸ¤«");
        bragBtn.disabled = true;
        return;
      }

      bragTimesAtThisLines++;
      pushLog(`${nickname}: æˆ‘ç¾åœ¨æœ‰ ${lines} æ¢ BINGOï¼`);

      if (bragTimesAtThisLines >= 3) {
        // ç¬¬ä¸‰æ¬¡ä¹‹å¾Œä¸‹ä¸€æ¬¡å°±æœƒè¢«æ“‹
        // ä¸ç«‹åˆ»ç¦ç”¨ï¼Œè®“ä»–æŒ‰åˆ°ç¬¬ 4 æ¬¡æ‰çœ‹åˆ°æç¤º
      }
    }

    /**************** å»ºç«‹ / åŠ å…¥æˆ¿é–“ ***************/
    async function handleCreateRoom() {
      if (!nickname) {
        alert("è«‹å…ˆè¨­å®šæš±ç¨±ã€‚");
        showNicknameModal();
        return;
      }
      const roomId = roomIdInput.value.trim();
      if (!roomId) {
        alert("è«‹è¼¸å…¥æˆ¿è™Ÿã€‚");
        return;
      }
      const pwd = roomPwdInput.value.trim();

      const roomRef = ref(db, `rooms/${roomId}`);
      const snap = await get(roomRef);
      if (snap.exists()) {
        alert("æ­¤æˆ¿è™Ÿå·²å­˜åœ¨ï¼Œè«‹æ”¹ç”¨å…¶ä»–æˆ¿è™Ÿæˆ–ç›´æ¥åŠ å…¥ã€‚");
        return;
      }

      const card = randomCardNumbers();
      myCardNumbers = card;
      initMyCardUI();

      await set(roomRef, {
        createdAt: serverTimestamp(),
        locked: false,
        gameState: "waiting",
        password: pwd || null,
        hostUid: uid,
        board: null,
        currentTurnOrder: null,
        players: {
          [uid]: {
            nickname,
            order: 1,
            ready: false
          }
        },
        cards: {
          [uid]: card
        }
      });

      pushLog(`æˆ¿ä¸» ${nickname} å»ºç«‹æˆ¿é–“ã€‚`);
      subscribeRoom(roomId);
      setRoomSectionVisible(true);

      // onDisconnect ç§»é™¤ç©å®¶ & è‹¥å·²ç„¡ç©å®¶å¯è€ƒæ…®åˆªæˆ¿ï¼Œç‚ºç°¡åŒ–æš«åªç§»é™¤ç©å®¶
      const playerRef = ref(db, `rooms/${roomId}/players/${uid}`);
      onDisconnect(playerRef).remove();

      const cardRef = ref(db, `rooms/${roomId}/cards/${uid}`);
      onDisconnect(cardRef).remove();

      scrollToRoom();
    }

    async function handleJoinRoom(specifiedRoomId, specifiedPwd) {
      if (!nickname) {
        alert("è«‹å…ˆè¨­å®šæš±ç¨±ã€‚");
        showNicknameModal();
        return;
      }
      const roomId = specifiedRoomId || roomIdInput.value.trim();
      if (!roomId) {
        alert("è«‹è¼¸å…¥æˆ¿è™Ÿæˆ–å¾åˆ—è¡¨é¸æ“‡æˆ¿é–“ã€‚");
        return;
      }
      const pwdInput = specifiedPwd != null ? specifiedPwd : roomPwdInput.value.trim();

      const roomRef = ref(db, `rooms/${roomId}`);
      const snap = await get(roomRef);
      if (!snap.exists()) {
        alert("æ­¤æˆ¿é–“ä¸å­˜åœ¨ã€‚");
        return;
      }
      const data = snap.val();
      if (data.password && data.password !== pwdInput) {
        alert("æˆ¿é–“å¯†ç¢¼éŒ¯èª¤ã€‚");
        return;
      }

      // å¡ç‰‡ï¼šè‹¥å·²æœ‰å°±æ²¿ç”¨ï¼Œå¦å‰‡æ–°ç”Ÿæˆ
      const cardRef = child(roomRef, `cards/${uid}`);
      const cardSnap = await get(cardRef);
      if (cardSnap.exists()) {
        myCardNumbers = cardSnap.val();
      } else {
        const card = randomCardNumbers();
        myCardNumbers = card;
        await set(cardRef, card);
      }
      initMyCardUI();

      // å¯«å…¥ç©å®¶è³‡è¨Šï¼ˆè‹¥å·²åœ¨æˆ¿è£¡å‰‡æ›´æ–°æš±ç¨±ï¼‰
      const players = data.players || {};
      let defaultOrder = null;
      if (!players[uid]) {
        // æ–°ç©å®¶ -> é è¨­æŠŠä»–æ’åˆ°æœ€å¾Œ
        const orders = Object.values(players)
          .map(p => p.order || 0)
          .filter(o => o > 0)
          .sort((a, b) => a - b);
        const maxOrder = orders.length ? orders[orders.length - 1] : 0;
        defaultOrder = maxOrder + 1;
      }

      await update(ref(db, `rooms/${roomId}/players/${uid}`), {
        nickname,
        order: defaultOrder,
        ready: false
      });

      pushLog(`${nickname} åŠ å…¥æˆ¿é–“`);
      subscribeRoom(roomId);
      setRoomSectionVisible(true);

      const playerRef = ref(db, `rooms/${roomId}/players/${uid}`);
      onDisconnect(playerRef).remove();
      const myCardRef = ref(db, `rooms/${roomId}/cards/${uid}`);
      onDisconnect(myCardRef).remove();

      scrollToRoom();
    }

    /**************** æˆ¿é–“åˆ—è¡¨ ***************/
    function subscribeRoomList() {
      const roomsRef = ref(db, "rooms");
      onValue(roomsRef, snap => {
        const data = snap.val() || {};
        const entries = [];
        for (const id in data) {
          const r = data[id];
          const playersCount = r.players ? Object.keys(r.players).length : 0;
          entries.push({
            id,
            locked: !!r.password,
            playersCount
          });
        }
        entries.sort((a, b) => a.id.localeCompare(b.id));
        roomList.innerHTML = "";
        for (const r of entries) {
          const row = document.createElement("div");
          row.className = "room-row";
          const span = document.createElement("span");
          span.textContent = `${r.id}ï¼ˆç©å®¶ï¼š${r.playersCount}ï¼‰`;
          if (r.locked) {
            const lockSpan = document.createElement("span");
            lockSpan.textContent = "ğŸ”’";
            lockSpan.className = "badge-lock";
            span.appendChild(document.createTextNode(" "));
            span.appendChild(lockSpan);
          }

          const btn = document.createElement("button");
          btn.textContent = "åŠ å…¥";
          btn.addEventListener("click", () => {
            const pwd = r.locked
              ? window.prompt(`æˆ¿é–“ ${r.id} æœ‰è¨­å®šå¯†ç¢¼ï¼Œè«‹è¼¸å…¥ï¼š`) || ""
              : "";
            handleJoinRoom(r.id, pwd);
          });

          row.appendChild(span);
          row.appendChild(btn);
          roomList.appendChild(row);
        }
      });
    }

    /**************** äº‹ä»¶ç¶å®š ***************/
    nicknameConfirmBtn.addEventListener("click", () => {
      const v = nicknameInput.value.trim();
      if (!v) {
        alert("æš±ç¨±ä¸èƒ½æ˜¯ç©ºçš„ã€‚");
        return;
      }
      nickname = v;
      localStorage.setItem("company-bingo-nickname", nickname);
      nicknameDisplay.textContent = `ç›®å‰æš±ç¨±ï¼š${nickname}`;
      hideNicknameModal();
    });

    nicknameInput.addEventListener("keydown", e => {
      if (e.key === "Enter") nicknameConfirmBtn.click();
    });

    createRoomBtn.addEventListener("click", handleCreateRoom);
    joinRoomBtn.addEventListener("click", () => handleJoinRoom(null, null));

    toggleLobbyBtn.addEventListener("click", () => {
      const display = lobby.style.display;
      lobby.style.display = display === "none" ? "block" : "none";
    });

    scrollToRoomBtn.addEventListener("click", scrollToRoom);

    function scrollToRoom() {
      roomSection.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    clearOrderBtn.addEventListener("click", () => {
      if (!currentRoomId || !currentRoomData) return;
      if (currentRoomData.hostUid !== uid) return;
      const players = getPlayersMap();
      const updates = {};
      for (const pid in players) {
        updates[`players/${pid}/order`] = null;
      }
      update(ref(db, `rooms/${currentRoomId}`), updates);
    });

    refreshCardBtn.addEventListener("click", async () => {
      if (!currentRoomId || !currentRoomData) return;
      if (currentRoomData.locked) return;
      const card = randomCardNumbers();
      myCardNumbers = card;
      initMyCardUI();
      await set(ref(db, `rooms/${currentRoomId}/cards/${uid}`), card);
      pushLog(`${nickname}: åˆ·æ–°äº†è‡ªå·±çš„å¡ç‰‡`);
    });

    lockBtn.addEventListener("click", handleLockClick);

    readyOkBtn.addEventListener("click", handleReadyOk);
    readyCancelBtn.addEventListener("click", handleReadyCancel);

    bragBtn.addEventListener("click", handleBragClick);

    /**************** åˆå§‹åŒ– ***************/
    ensureNickname();
    initPublicBoardUI();

    if (nickname) {
      nicknameDisplay.textContent = `ç›®å‰æš±ç¨±ï¼š${nickname}`;
    }

    subscribeRoomList();

    // é è¨­é¡¯ç¤ºæˆ¿é–“å€å¡Šï¼ˆæ²’åŠ å…¥åªæ˜¯ç©ºï¼‰ï¼Œå°‡ä¾†åŠ å…¥å¾Œç›´æ¥çœ‹åˆ°
    setRoomSectionVisible(true);
  </script>
</body>
</html>
