<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Company Bingo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f5f5f5;
    }
    header {
      background: #3f51b5;
      color: white;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header span {
      font-size: 14px;
    }
    .container {
      max-width: 1100px;
      margin: 16px auto 40px;
      padding: 0 12px;
    }
    h2 {
      margin-top: 20px;
      margin-bottom: 8px;
      font-size: 18px;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 12px 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    label {
      font-size: 14px;
    }
    input, button {
      font-family: inherit;
      font-size: 14px;
    }
    input[type="text"], input[type="password"] {
      padding: 4px 6px;
      margin: 2px 0 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      min-width: 0;
    }
    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #3f51b5;
      color: white;
    }
    button.secondary {
      background: #777;
    }
    button.small {
      padding: 4px 8px;
      font-size: 12px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .flex {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .flex-middle {
      align-items: center;
    }
    .numbers-grid, .board-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      margin-top: 8px;
    }
    .board-grid {
      grid-template-columns: repeat(5, 1fr);
      max-width: 320px;
    }
    .num-cell {
      border-radius: 4px;
      background: #eee;
      padding: 6px 0;
      text-align: center;
      cursor: pointer;
      user-select: none;
      font-size: 14px;
    }
    .num-cell.called {
      background: #3f51b5;
      color: white;
      font-weight: bold;
    }
    .num-cell.mine {
      border: 1px solid #3f51b5;
    }
    .num-cell.called.mine {
      background: #ff7043;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      background: #eee;
      margin-left: 6px;
    }
    .badge.lock {
      background: #fdd835;
    }
    .room-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 220px;
      overflow-y: auto;
    }
    .room-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .room-name {
      font-weight: 500;
    }
    .log-panel {
      background: #111;
      color: #eee;
      font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      border-radius: 6px;
      padding: 6px 8px;
      max-height: 220px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .log-line {
      margin: 1px 0;
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal {
      background: white;
      padding: 16px 18px;
      border-radius: 8px;
      max-width: 320px;
      width: calc(100% - 40px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .modal h2 {
      margin-top: 0;
      font-size: 18px;
    }
    .muted {
      color: #777;
      font-size: 12px;
    }
    .current-room {
      font-size: 14px;
    }
    .current-room span {
      margin-right: 6px;
    }
    .bingo-count {
      font-weight: bold;
      color: #d32f2f;
    }
    @media (max-width: 600px) {
      .numbers-grid {
        grid-template-columns: repeat(5, 1fr);
      }
    }
  </style>
</head>
<body>
<header>
  <h1>Company Bingo</h1>
  <span id="headerUser"></span>
</header>

<!-- æš±ç¨±è¼¸å…¥ -->
<div id="nicknameOverlay" class="overlay" style="display:none;">
  <div class="modal">
    <h2>å…ˆå–å€‹æš±ç¨± ğŸ‘‹</h2>
    <label>æš±ç¨±ï¼ˆæœƒé¡¯ç¤ºåœ¨æ—¥èªŒï¼‰ï¼š</label><br>
    <input id="nicknameInput" type="text" maxlength="16" style="width:100%;" />
    <p class="muted">åªæœƒå­˜åˆ°é€™å°é›»è…¦ï¼ˆlocalStorageï¼‰ã€‚</p>
    <button id="saveNicknameBtn" style="width:100%;">é€²å…¥</button>
  </div>
</div>

<main class="container" id="app" style="display:none;">

  <!-- æˆ¿é–“ç®¡ç† -->
  <section class="card">
    <h2>æˆ¿é–“</h2>

    <div class="flex flex-middle" style="margin-bottom:8px;">
      <div class="current-room" id="currentRoomInfo" style="display:none;">
        <span>ç›®å‰æˆ¿é–“ï¼š<strong id="currentRoomName"></strong></span>
        <span>IDï¼š<code id="currentRoomId"></code></span>
        <button id="leaveRoomBtn" class="small secondary">é›¢é–‹æˆ¿é–“</button>
      </div>
      <div id="noRoomInfo" class="muted">å°šæœªåŠ å…¥ä»»ä½•æˆ¿é–“</div>
    </div>

    <div class="flex">
      <!-- å»ºç«‹æˆ¿é–“ -->
      <div style="min-width:260px;flex:1;">
        <h3 style="margin:4px 0 4px;">å»ºç«‹æˆ¿é–“</h3>
        <label>æˆ¿é–“åç¨±</label><br>
        <input id="createRoomName" type="text" maxlength="20" style="width:100%;" /><br>
        <label>æˆ¿é–“å¯†ç¢¼ï¼ˆå¯ç•™ç©ºï¼‰</label><br>
        <input id="createRoomPassword" type="password" maxlength="20" style="width:100%;" /><br>
        <button id="createRoomBtn" style="margin-top:4px;">å»ºç«‹æˆ¿é–“</button>
      </div>

      <!-- å·²å»ºæˆ¿é–“åˆ—è¡¨ -->
      <div style="min-width:260px;flex:1;">
        <h3 style="margin:4px 0 4px;">å·²å»ºç«‹æˆ¿é–“</h3>
        <ul id="roomList" class="room-list">
          <!-- å‹•æ…‹å¡«å…¥ -->
        </ul>
        <p class="muted">æœ‰ ğŸ”’ çš„ä»£è¡¨è¨­å®šäº†å¯†ç¢¼ï¼ŒåŠ å…¥æ™‚æœƒå†è©¢å•ä¸€æ¬¡ã€‚</p>
      </div>
    </div>
  </section>

  <!-- éŠæˆ²å€åŸŸ -->
  <section class="card" id="gameSection" style="display:none;">
    <h2>å…¬å…±è™Ÿç¢¼ï¼ˆ1â€“50ï¼‰</h2>
    <p class="muted">ä»»ä½•äººé»è‡ªå·±å¡ç‰‡ä¸Šçš„è™Ÿç¢¼ï¼ŒæœƒåŒæ­¥æ›´æ–°é€™è£¡ï¼Œæ‰€æœ‰äººéƒ½æœƒçœ‹åˆ°ã€‚</p>
    <div id="calledNumbersGrid" class="numbers-grid"></div>

    <h2>æˆ‘çš„å¡ç‰‡</h2>
    <p class="muted">
      é»æ“Šæ–¹æ ¼ = å®£å‘Š / å–æ¶ˆè©²è™Ÿç¢¼ã€‚<br>
      ç›®å‰ BINGO æ¢æ•¸ï¼š<span id="bingoCount" class="bingo-count">0</span>
    </p>
    <div id="myBoardGrid" class="board-grid"></div>
  </section>

  <!-- æ´»å‹•ç´€éŒ„ -->
  <section class="card" id="logSection" style="display:none;">
    <h2>æ—¥èªŒ</h2>
    <div id="logPanel" class="log-panel"></div>
  </section>
</main>

<script type="module">
  /********** 1. Firebase åˆå§‹åŒ– **********/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    set,
    update,
    get,
    onValue,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // âš ï¸ é€™è£¡æ”¹æˆä½ åœ¨ Firebase æ§åˆ¶å°ç”¢ç”Ÿçš„è¨­å®šï¼ˆæ•´å€‹ç‰©ä»¶è²¼éä¾†ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyB4IBPbuGxztyzd8E3YTitMoTt8L19MSG0",
    authDomain: "company-bingo.firebaseapp.com",
    databaseURL: "https://company-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "company-bingo",
    storageBucket: "company-bingo.firebasestorage.app",
    messagingSenderId: "844173689886",
    appId: "1:844173689886:web:ac2f1888f542b138861a0f",
    measurementId: "G-WGDVJPKMEH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  /********** 2. ä¸€äº›ç°¡å–®çš„ç‹€æ…‹ **********/
  const headerUserEl      = document.getElementById("headerUser");
  const appEl             = document.getElementById("app");
  const nicknameOverlay   = document.getElementById("nicknameOverlay");
  const nicknameInput     = document.getElementById("nicknameInput");
  const saveNicknameBtn   = document.getElementById("saveNicknameBtn");

  const roomListEl        = document.getElementById("roomList");
  const createRoomNameEl  = document.getElementById("createRoomName");
  const createRoomPwdEl   = document.getElementById("createRoomPassword");
  const createRoomBtn     = document.getElementById("createRoomBtn");

  const currentRoomInfoEl = document.getElementById("currentRoomInfo");
  const noRoomInfoEl      = document.getElementById("noRoomInfo");
  const currentRoomNameEl = document.getElementById("currentRoomName");
  const currentRoomIdEl   = document.getElementById("currentRoomId");
  const leaveRoomBtn      = document.getElementById("leaveRoomBtn");

  const gameSectionEl     = document.getElementById("gameSection");
  const logSectionEl      = document.getElementById("logSection");
  const calledGridEl      = document.getElementById("calledNumbersGrid");
  const myBoardGridEl     = document.getElementById("myBoardGrid");
  const bingoCountEl      = document.getElementById("bingoCount");
  const logPanelEl        = document.getElementById("logPanel");

  // ä¼ºæœå™¨ä¸Šçš„è³‡æ–™è·¯å¾‘ï¼š
  // rooms/{roomId}
  //   name
  //   hasPassword
  //   password (ç°¡å–®å­—ä¸²ï¼Œåªæ˜¯é˜²é¬§ï¼Œä¸æ˜¯é«˜å®‰å…¨ç­‰ç´š)
  //   createdAt
  //   createdBy
  //   calledNumbers/{num} : { by, at }
  //   logs/{autoId} : { ts, text }
  //   boards/{userId} : [25 å€‹æ•¸å­—]

  let currentRoomId   = null;
  let currentRoomName = null;
  let nickname        = null;
  let userId          = null;  // æˆ‘å€‘è‡ªå·±ç”Ÿæˆä¸€å€‹ç°¡å–® id å­˜åœ¨ localStorage
  let myBoardNumbers  = [];    // é•·åº¦ 25
  let numberPosMap    = {};    // num -> {row,col,index}

  let calledNumsCache = {};    // {num: true}
  let roomsListener   = null;
  let calledListener  = null;
  let logsListener    = null;

  /********** 3. æš±ç¨±èˆ‡æœ¬æ©Ÿä½¿ç”¨è€… **********/
  function initUser() {
    const savedNick = localStorage.getItem("bingoNickname");
    const savedId   = localStorage.getItem("bingoUserId");

    if (savedId) {
      userId = savedId;
    } else {
      userId = "u_" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("bingoUserId", userId);
    }

    if (savedNick && savedNick.trim()) {
      nickname = savedNick.trim();
      headerUserEl.textContent = "æš±ç¨±ï¼š" + nickname;
      nicknameOverlay.style.display = "none";
      appEl.style.display = "block";
    } else {
      nicknameOverlay.style.display = "flex";
      appEl.style.display = "none";
    }
  }

  saveNicknameBtn.addEventListener("click", () => {
    const name = nicknameInput.value.trim();
    if (!name) {
      alert("æš±ç¨±ä¸èƒ½ç©ºç™½");
      return;
    }
    nickname = name;
    localStorage.setItem("bingoNickname", nickname);
    headerUserEl.textContent = "æš±ç¨±ï¼š" + nickname;
    nicknameOverlay.style.display = "none";
    appEl.style.display = "block";
  });

  /********** 4. æˆ¿é–“åˆ—è¡¨ç›£è½ **********/
  function listenRooms() {
    const roomsRef = ref(db, "rooms");
    onValue(roomsRef, (snap) => {
      const val = snap.val() || {};
      roomListEl.innerHTML = "";

      const entries = Object.entries(val);
      if (!entries.length) {
        const li = document.createElement("li");
        li.textContent = "ç›®å‰æ²’æœ‰æˆ¿é–“ï¼Œè«‹å…ˆå»ºç«‹ä¸€å€‹ã€‚";
        roomListEl.appendChild(li);
        return;
      }

      // ç…§å»ºç«‹æ™‚é–“æ’åº
      entries.sort((a, b) => (a[1].createdAt || 0) - (b[1].createdAt || 0));

      for (const [roomId, room] of entries) {
        const li = document.createElement("li");

        const left = document.createElement("div");
        const nameSpan = document.createElement("span");
        nameSpan.className = "room-name";
        nameSpan.textContent = room.name || "(æœªå‘½å)";
        left.appendChild(nameSpan);

        if (room.hasPassword) {
          const lock = document.createElement("span");
          lock.className = "badge lock";
          lock.textContent = "ğŸ”’ æœ‰å¯†ç¢¼";
          left.appendChild(lock);
        }

        const right = document.createElement("div");
        const idSpan = document.createElement("span");
        idSpan.className = "muted";
        idSpan.textContent = roomId.slice(0, 6);
        right.appendChild(idSpan);

        const joinBtn = document.createElement("button");
        joinBtn.textContent = "åŠ å…¥";
        joinBtn.className = "small";
        joinBtn.style.marginLeft = "6px";
        joinBtn.addEventListener("click", () => joinRoomFlow(roomId, room));
        right.appendChild(joinBtn);

        li.appendChild(left);
        li.appendChild(right);
        roomListEl.appendChild(li);
      }
    });
  }

  async function joinRoomFlow(roomId, roomData) {
    if (currentRoomId === roomId) return; // å·²åœ¨æ­¤æˆ¿

    let pwdInput = "";
    if (roomData.hasPassword) {
      pwdInput = prompt("æ­¤æˆ¿é–“æœ‰è¨­å®šå¯†ç¢¼ï¼Œè«‹è¼¸å…¥ï¼š") || "";
      if (pwdInput !== (roomData.password || "")) {
        alert("å¯†ç¢¼éŒ¯èª¤");
        return;
      }
    }

    await enterRoom(roomId);
  }

  /********** 5. å»ºç«‹æˆ¿é–“ **********/
  createRoomBtn.addEventListener("click", async () => {
    const name = (createRoomNameEl.value || "").trim() || "æœªå‘½åæˆ¿é–“";
    const pwd  = (createRoomPwdEl.value || "").trim();

    const roomsRef = ref(db, "rooms");
    const newRoomRef = push(roomsRef);

    const roomId = newRoomRef.key;
    await set(newRoomRef, {
      name,
      hasPassword: !!pwd,
      password: pwd || null,
      createdAt: Date.now(),
      createdBy: nickname || "unknown"
    });

    createRoomNameEl.value = "";
    createRoomPwdEl.value  = "";

    await enterRoom(roomId);
  });

  /********** 6. é€²å…¥ / é›¢é–‹æˆ¿é–“ **********/
  async function enterRoom(roomId) {
    // å…ˆè®€æˆ¿é–“è³‡æ–™ï¼ˆç¢ºèªå­˜åœ¨ï¼‰
    const roomSnap = await get(ref(db, "rooms/" + roomId));
    if (!roomSnap.exists()) {
      alert("æˆ¿é–“ä¸å­˜åœ¨");
      return;
    }
    const room = roomSnap.val();
    currentRoomId   = roomId;
    currentRoomName = room.name || "æœªå‘½åæˆ¿é–“";

    currentRoomNameEl.textContent = currentRoomName;
    currentRoomIdEl.textContent   = roomId;
    currentRoomInfoEl.style.display = "inline-block";
    noRoomInfoEl.style.display      = "none";
    gameSectionEl.style.display     = "block";
    logSectionEl.style.display      = "block";

    // åŠ å…¥æˆ¿é–“çš„ log
    await push(ref(db, `rooms/${roomId}/logs`), {
      ts: serverTimestamp(),
      text: `${nickname} åŠ å…¥æˆ¿é–“`
    });

    // å»ºå‡ºæˆ‘çš„æ¿å­ï¼ˆå¦‚å°šæœªæœ‰ï¼‰
    await ensureMyBoard(roomId);

    // è¨­å®šç›£è½ï¼šcalled numbers / logs
    setupCalledNumbersListener(roomId);
    setupLogsListener(roomId);
  }

  leaveRoomBtn.addEventListener("click", async () => {
    if (!currentRoomId) return;

    const tmpRoomId = currentRoomId;
    const tmpName   = currentRoomName;

    // log é›¢é–‹
    await push(ref(db, `rooms/${tmpRoomId}/logs`), {
      ts: serverTimestamp(),
      text: `${nickname} é›¢é–‹æˆ¿é–“`
    });

    // ç§»é™¤ç›£è½
    calledNumsCache = {};
    myBoardNumbers  = [];
    numberPosMap    = {};
    calledGridEl.innerHTML = "";
    myBoardGridEl.innerHTML = "";
    logPanelEl.innerHTML   = "";

    currentRoomId   = null;
    currentRoomName = null;

    currentRoomInfoEl.style.display = "none";
    noRoomInfoEl.style.display      = "block";
    gameSectionEl.style.display     = "none";
    logSectionEl.style.display      = "none";
  });

  /********** 7. å»ºç«‹ / è®€å–æˆ‘çš„ Bingo å¡ **********/
  async function ensureMyBoard(roomId) {
    const boardRef = ref(db, `rooms/${roomId}/boards/${userId}`);
    const snap = await get(boardRef);
    if (snap.exists()) {
      myBoardNumbers = snap.val() || [];
    } else {
      // ç”¢ç”Ÿ 1~50 ä¸­çš„ 25 å€‹ä¸é‡è¤‡æ•¸å­—
      const all = [];
      for (let i = 1; i <= 50; i++) all.push(i);
      for (let i = all.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [all[i], all[j]] = [all[j], all[i]];
      }
      myBoardNumbers = all.slice(0, 25);
      await set(boardRef, myBoardNumbers);
    }

    buildMyBoardGrid();
    buildNumbersGrid(); // å…¬å…±è™Ÿç¢¼ä¹Ÿé †ä¾¿ç•«å¥½
  }

  function buildMyBoardGrid() {
    myBoardGridEl.innerHTML = "";
    numberPosMap = {};
    myBoardNumbers.forEach((num, idx) => {
      const cell = document.createElement("div");
      cell.className = "num-cell mine";
      cell.textContent = num;
      cell.dataset.num = String(num);
      cell.dataset.index = String(idx);
      cell.addEventListener("click", () => toggleNumber(num));
      myBoardGridEl.appendChild(cell);

      const row = Math.floor(idx / 5);
      const col = idx % 5;
      numberPosMap[num] = { row, col, idx };
    });

    updateBoardHighlight();
  }

  function buildNumbersGrid() {
    calledGridEl.innerHTML = "";
    for (let num = 1; num <= 50; num++) {
      const cell = document.createElement("div");
      cell.className = "num-cell";
      cell.textContent = num;
      cell.dataset.num = String(num);
      // ä¹Ÿå…è¨±ç›´æ¥é»å…¬å…±æŒ‰éˆ•
      cell.addEventListener("click", () => toggleNumber(num));
      calledGridEl.appendChild(cell);
    }
    updateNumbersGrid();
  }

  /********** 8. è™Ÿç¢¼åˆ‡æ› + å¯«å…¥ DB + æ—¥èªŒ **********/
  async function toggleNumber(num) {
    if (!currentRoomId) {
      alert("è«‹å…ˆåŠ å…¥æˆ¿é–“");
      return;
    }
    num = Number(num);
    const alreadyCalled = !!calledNumsCache[num];

    const numRef = ref(db, `rooms/${currentRoomId}/calledNumbers/${num}`);
    if (alreadyCalled) {
      // å–æ¶ˆ
      await set(numRef, null);
      await push(ref(db, `rooms/${currentRoomId}/logs`), {
        ts: serverTimestamp(),
        text: `${nickname}: å–æ¶ˆ ${num}`
      });
    } else {
      await set(numRef, {
        by: nickname,
        at: serverTimestamp()
      });
      await push(ref(db, `rooms/${currentRoomId}/logs`), {
        ts: serverTimestamp(),
        text: `${nickname}: ${num}`
      });
    }
  }

  /********** 9. calledNumbers ç›£è½ & ç•«é¢åŒæ­¥ **********/
  function setupCalledNumbersListener(roomId) {
    if (calledListener) {
      // Realtime DB æ²’æœ‰ç›´æ¥ç§»é™¤é€™å€‹ onValue çš„ referenceï¼Œ
      // ä¸éæˆ‘å€‘é‡æ–°æŒ‡æ´¾è¦†è“‹å°±å¥½ï¼ˆå–®é é¢ï¼‰ã€‚
    }

    const roomCalledRef = ref(db, `rooms/${roomId}/calledNumbers`);
    onValue(roomCalledRef, (snap) => {
      const val = snap.val() || {};
      calledNumsCache = {};
      Object.keys(val).forEach((k) => {
        calledNumsCache[Number(k)] = true;
      });
      updateNumbersGrid();
      updateBoardHighlight();
      updateBingoCount();
    });
  }

  function updateNumbersGrid() {
    const cells = calledGridEl.querySelectorAll(".num-cell");
    cells.forEach((cell) => {
      const num = Number(cell.dataset.num);
      if (calledNumsCache[num]) {
        cell.classList.add("called");
      } else {
        cell.classList.remove("called");
      }
    });
  }

  function updateBoardHighlight() {
    const cells = myBoardGridEl.querySelectorAll(".num-cell");
    cells.forEach((cell) => {
      const num = Number(cell.dataset.num);
      if (calledNumsCache[num]) {
        cell.classList.add("called");
      } else {
        cell.classList.remove("called");
      }
    });
  }

  function updateBingoCount() {
    if (!myBoardNumbers.length) {
      bingoCountEl.textContent = "0";
      return;
    }

    const hit = myBoardNumbers.map((num) => !!calledNumsCache[num]);
    let lines = 0;

    // æ©«å‘
    for (let r = 0; r < 5; r++) {
      let ok = true;
      for (let c = 0; c < 5; c++) {
        if (!hit[r * 5 + c]) { ok = false; break; }
      }
      if (ok) lines++;
    }
    // ç›´å‘
    for (let c = 0; c < 5; c++) {
      let ok = true;
      for (let r = 0; r < 5; r++) {
        if (!hit[r * 5 + c]) { ok = false; break; }
      }
      if (ok) lines++;
    }
    // æ–œç·š
    let ok = true;
    for (let i = 0; i < 5; i++) {
      if (!hit[i * 5 + i]) { ok = false; break; }
    }
    if (ok) lines++;

    ok = true;
    for (let i = 0; i < 5; i++) {
      if (!hit[i * 5 + (4 - i)]) { ok = false; break; }
    }
    if (ok) lines++;

    bingoCountEl.textContent = String(lines);
  }

  /********** 10. æ—¥èªŒç›£è½ **********/
  function setupLogsListener(roomId) {
    const logsRef = ref(db, `rooms/${roomId}/logs`);
    onValue(logsRef, (snap) => {
      const val = snap.val() || {};
      const entries = Object.entries(val);
      entries.sort((a,b) => (a[1].ts || 0) - (b[1].ts || 0));
      logPanelEl.innerHTML = "";

      for (const [, log] of entries) {
        const div = document.createElement("div");
        div.className = "log-line";
        const ts = log.ts ? new Date(log.ts).toLocaleTimeString() : "";
        div.textContent = ts ? `[${ts}] ${log.text}` : log.text;
        logPanelEl.appendChild(div);
      }
      logPanelEl.scrollTop = logPanelEl.scrollHeight;
    });
  }

  /********** 11. å•Ÿå‹• **********/
  initUser();
  listenRooms();
</script>
</body>
</html>
