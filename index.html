<!DOCTYPE html>
<html lang="zh-Hant">
<head>
Â  <meta charset="UTF-8" />
Â  <title>å…¬å¸ Bingo å¤§å»³</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <style>
Â  Â  * {
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
Â  Â  Â  Â  "PingFang TC", "Microsoft JhengHei", sans-serif;
Â  Â  }

Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  background: #f5f5f5;
Â  Â  Â  color: #333;
Â  Â  }

Â  Â  .container {
Â  Â  Â  max-width: 1200px;
Â  Â  Â  margin: 0 auto;
Â  Â  Â  padding: 16px;
Â  Â  }

Â  Â  header {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  margin-bottom: 12px;
Â  Â  }

Â  Â  header h1 {
Â  Â  Â  margin: 0;
Â  Â  Â  font-size: 20px;
Â  Â  }

Â  Â  .small-hint {
Â  Â  Â  font-size: 12px;
Â  Â  Â  color: #777;
Â  Â  }

Â  Â  .btn {
Â  Â  Â  display: inline-block;
Â  Â  Â  padding: 6px 12px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  border: 1px solid transparent;
Â  Â  Â  background: #0d6efd;
Â  Â  Â  color: #fff;
Â  Â  Â  font-size: 14px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background 0.15s, border-color 0.15s, opacity 0.15s;
Â  Â  }
Â  Â  .btn:disabled {
Â  Â  Â  cursor: not-allowed;
Â  Â  Â  opacity: 0.6;
Â  Â  }
Â  Â  .btn-secondary {
Â  Â  Â  background: #6c757d;
Â  Â  }
Â  Â  .btn-danger {
Â  Â  Â  background: #dc3545;
Â  Â  }
Â  Â  .btn-outline {
Â  Â  Â  background: #fff;
Â  Â  Â  color: #0d6efd;
Â  Â  Â  border-color: #0d6efd;
Â  Â  }

Â  Â  input, select {
Â  Â  Â  padding: 4px 8px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  }

Â  Â  /* layout ä¸»é«”ä¸‰æ¬„ */
Â  Â  .layout {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: 260px 1fr 320px;
Â  Â  Â  gap: 12px;
Â  Â  Â  align-items: start;
Â  Â  }

Â  Â  .card {
Â  Â  Â  background: #fff;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  padding: 10px 12px;
Â  Â  Â  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
Â  Â  }

Â  Â  .card-title-row {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 8px;
Â  Â  }

Â  Â  .card-title {
Â  Â  Â  margin: 0;
Â  Â  Â  font-size: 15px;
Â  Â  Â  font-weight: 600;
Â  Â  }

Â  Â  /* æˆ¿é–“å¤§å»³ */
Â  Â  #lobby {
Â  Â  Â  margin-top: 8px;
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  padding: 10px 12px;
Â  Â  Â  background: #fff8e1;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  border: 1px solid #ffe082;
Â  Â  }

Â  Â  #room-list {
Â  Â  Â  margin-top: 6px;
Â  Â  Â  border-top: 1px solid #eee;
Â  Â  Â  padding-top: 6px;
Â  Â  Â  max-height: 120px;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  font-size: 13px;
Â  Â  }

Â  Â  .room-row {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 2px 0;
Â  Â  }

Â  Â  .room-lock {
Â  Â  Â  margin-right: 4px;
Â  Â  Â  color: #ff9800;
Â  Â  }

Â  Â  /* ç©å®¶æ¸…å–® */
Â  Â  .player-list {
Â  Â  Â  border: 1px solid #eee;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  max-height: 260px;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  padding: 4px;
Â  Â  Â  font-size: 13px;
Â  Â  }
Â  Â  .player-row {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  padding: 2px 4px;
Â  Â  }

Â  Â  /* æ ¼å­ç›¸é—œ */
Â  Â  .grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(10, 1fr);
Â  Â  Â  gap: 4px;
Â  Â  }

Â  Â  .grid-5 {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(5, 1fr);
Â  Â  Â  gap: 4px;
Â  Â  }

Â  Â  .num-btn {
Â  Â  Â  padding: 4px 0;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  font-size: 13px;
Â  Â  Â  text-align: center;
Â  Â  Â  cursor: pointer;
Â  Â  Â  background: #f8f9fa;
Â  Â  Â  user-select: none;
Â  Â  Â  transition: background 0.15s, color 0.15s, border-color 0.15s;
Â  Â  }
Â  Â  .num-btn.selected {
Â  Â  Â  background: #3f51b5;
Â  Â  Â  color: #fff;
Â  Â  Â  border-color: #3f51b5;
Â  Â  }
Â  Â  .num-btn.disabled {
Â  Â  Â  cursor: not-allowed;
Â  Â  Â  background: #eee;
Â  Â  Â  color: #aaa;
Â  Â  }

Â  Â  .num-btn-mycard {
Â  Â  Â  padding: 14px 0;
Â  Â  }

Â  Â  .center {
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  .hint-text {
Â  Â  Â  font-size: 13px;
Â  Â  Â  color: #777;
Â  Â  }

Â  Â  .bingo-highlight {
Â  Â  Â  color: #d32f2f;
Â  Â  Â  font-weight: 700;
Â  Â  }

Â  Â  /* å³å´ æ—¥èªŒç™½æ¡†å’Œé»‘æ¡† */
Â  Â  #log-wrapper {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 6px;
Â  Â  Â  height: 100%;
Â  Â  }

Â  Â  #room-info {
Â  Â  Â  font-size: 13px;
Â  Â  Â  line-height: 1.5;
Â  Â  }

Â  Â  #log-box {
Â  Â  Â  flex: 1;
Â  Â  Â  min-height: 260px; /* ç¢ºä¿è‡³å°‘æœ‰ä¸€å®šé«˜åº¦ */
Â  Â  Â  max-height: 400px; /* å›ºå®šé«˜åº¦ï¼Œèˆ‡ä¸­é–“å¡ç‰‡å·®ä¸å¤š */
Â  Â  Â  border-radius: 4px;
Â  Â  Â  background: #111;
Â  Â  Â  color: #eee;
Â  Â  Â  padding: 6px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  overflow-y: auto; /* æ»¾å‹•æ¢ */
Â  Â  Â  white-space: pre-wrap;
Â  Â  }

Â  Â  /* æš±ç¨±è¼¸å…¥å½ˆçª— */
Â  Â  #nickname-modal-backdrop {
Â  Â  Â  position: fixed;
Â  Â  Â  inset: 0;
Â  Â  Â  background: rgba(0,0,0,0.4);
Â  Â  Â  display: none;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  z-index: 999;
Â  Â  }

Â  Â  #nickname-modal {
Â  Â  Â  background: #fff;
Â  Â  Â  padding: 16px 20px;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  width: 280px;
Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
Â  Â  }

Â  Â  #nickname-modal h2 {
Â  Â  Â  margin: 0 0 8px;
Â  Â  Â  font-size: 18px;
Â  Â  }

Â  Â  #nickname-modal p {
Â  Â  Â  margin: 0 0 8px;
Â  Â  Â  font-size: 13px;
Â  Â  Â  color: #555;
Â  Â  }

Â  Â  /* ä¸€äº›å°æ±è¥¿ */
Â  Â  .mt-4 { margin-top: 4px; }
Â  Â  .mt-6 { margin-top: 6px; }
Â  Â  .mt-8 { margin-top: 8px; }
Â  Â  .mt-10 { margin-top: 10px; }

Â  Â  .text-small {
Â  Â  Â  font-size: 12px;
Â  Â  Â  color: #777;
Â  Â  }

Â  Â  .lock-btn-unlock {
Â  Â  Â  background: #0d6efd;
Â  Â  }
Â  Â  /* é–å®šæ™‚ åç´… */
Â  Â  .lock-btn-locked {
Â  Â  Â  background: #dc3545;
Â  Â  }

Â  Â  .pointer-forbidden {
Â  Â  Â  cursor: not-allowed !important;
Â  Â  }
Â  </style>
</head>
<body>
<div class="container">
Â  <header>
Â  Â  <div>
Â  Â  Â  <h1>å…¬å¸ Bingo å¤§å»³</h1>
Â  Â  Â  <div class="small-hint">ä½¿ç”¨åŒä¸€ç¶²å€ï¼ŒåŒä¸€ Firebaseï¼Œå°±èƒ½å¤§å®¶ä¸€èµ·ç©ã€‚</div>
Â  Â  </div>
Â  Â  Â  </header>

Â  Â  <div id="lobby">
Â  Â  <div>
Â  Â  Â  <label>æˆ¿è™Ÿï¼š</label>
Â  Â  Â  <input id="room-id-input" type="text" placeholder="ä¾‹å¦‚ï¼š101" style="width:100px;" />
Â  Â  Â  <button id="create-room-btn" class="btn">å»ºç«‹æˆ¿é–“</button>
Â  Â  Â  <button id="join-room-btn" class="btn btn-outline">åŠ å…¥æˆ¿é–“</button>
Â  Â  </div>
Â  Â  <div id="room-list"></div>
Â  </div>

Â  Â  <div class="layout">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  <div class="card-title-row">
Â  Â  Â  Â  <h3 class="card-title">æ§åˆ¶ / ç©å®¶</h3>
Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="lock-btn" class="btn lock-btn-unlock" style="width:100%; margin-bottom:6px;">
Â  Â  Â  Â  é–å®šé–‹å§‹æœ¬å±€
Â  Â  Â  </button>
Â  Â  Â  <div class="card-title-row" style="margin-top:4px;">
Â  Â  Â  Â  <span class="card-title" style="font-size:14px;">ç©å®¶åˆ—è¡¨</span>
Â  Â  Â  </div>
Â  Â  Â  <div id="player-list" class="player-list"></div>

Â  Â  Â  <button id="refresh-card-btn" class="btn btn-outline mt-8" style="width:100%;">
Â  Â  Â  Â  é‡æ–°æŠ½æˆ‘çš„å¡ç‰‡
Â  Â  Â  </button>
Â  Â  Â  <div class="text-small mt-4">
Â  Â  Â  Â  â€» æœªé–å®šæ™‚ï¼Œæ‰€æœ‰è™Ÿç¢¼éƒ½ä¸èƒ½é»ã€‚é–å®šå¾Œæ‰é–‹å§‹éŠæˆ²ã€‚
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="card">
Â  Â  Â  <div class="card-title-row">
Â  Â  Â  Â  <h3 class="card-title center" style="flex:1; text-align:center;">
Â  Â  Â  Â  Â  å…¬å…±è™Ÿç¢¼ï¼ˆ1â€“50ï¼‰
Â  Â  Â  Â  </h3>
Â  Â  Â  </div>
Â  Â  Â  <div id="turn-hint" class="center hint-text mt-4">
Â  Â  Â  Â  å°šæœªé–å®šï¼Œè«‹æˆ¿ä¸»å…ˆé–å®šé–‹å§‹ã€‚
Â  Â  Â  </div>
Â  Â  Â  <div id="public-grid" class="grid mt-4"></div>

Â  Â  Â  <div class="card-title-row mt-10">
Â  Â  Â  Â  <h3 class="card-title" style="flex:1; text-align:center;">
Â  Â  Â  Â  Â  æˆ‘çš„å¡ç‰‡ã€€<span id="bingo-count-label">ç›®å‰ BINGOï¼š0 æ¢</span>
Â  Â  Â  Â  </h3>
Â  Â  Â  Â  <button id="brag-btn" class="btn btn-outline" style="margin-left:6px; font-size:13px;">
Â  Â  Â  Â  Â  ç‚«è€€
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â  Â  Â  <div class="center hint-text">
Â  Â  Â  Â  é»æ“Šè™Ÿç¢¼ = è¨­ç‚ºé¸ä¸­ / å–æ¶ˆé¸ä¸­ï¼ˆé–å®šå¾Œæ‰å¯æ“ä½œï¼‰
Â  Â  Â  </div>
Â  Â  Â  <div id="mycard-grid" class="grid-5 mt-4"></div>
Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="card" style="height:100%;">
Â  Â  Â  <div id="log-wrapper">
Â  Â  Â  Â  <div id="room-info">
Â  Â  Â  Â  Â  æˆ¿è™Ÿï¼š<span id="room-info-id">-</span><br/>
Â  Â  Â  Â  Â  æš±ç¨±ï¼š<span id="room-info-nick">-</span> Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="log-box"></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<div id="nickname-modal-backdrop">
Â  <div id="nickname-modal">
Â  Â  <h2>è¼¸å…¥æš±ç¨±</h2>
Â  Â  <p>ç¬¬ä¸€æ¬¡ä½¿ç”¨è«‹å…ˆè¨­å®šæš±ç¨±ï¼Œä¹‹å¾ŒåŒä¸€å°é›»è…¦æœƒè‡ªå‹•è¨˜ä½ã€‚</p>
Â  Â  <input id="nickname-input" type="text" placeholder="ä¾‹å¦‚ï¼šGARY" style="width:100%;"/>
Â  Â  <button id="nickname-confirm-btn" class="btn mt-8" style="width:100%;">ç¢ºå®š</button>
Â  </div>
</div>

<script type="module">
Â  // ===== Firebase åˆå§‹åŒ– (ç•¥) =====
Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
Â  import {
Â  Â  getDatabase,
Â  Â  ref,
Â  Â  child,
Â  Â  get,
Â  Â  set,
Â  Â  update,
Â  Â  push,
Â  Â  onValue,
Â  Â  serverTimestamp,
Â  Â  remove
Â  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyB4IBPbuGxztyzd8E3YTitMoTt8L19MSG0",
Â  Â  authDomain: "company-bingo.firebaseapp.com",
Â  Â  databaseURL: "https://company-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
Â  Â  projectId: "company-bingo",
Â  Â  storageBucket: "company-bingo.firebasestorage.app",
Â  Â  messagingSenderId: "844173689886",
Â  Â  appId: "1:844173689886:web:ac2f1888f542b138861a0f",
Â  Â  measurementId: "G-WGDVJPKMEH"
Â  };

Â  const app = initializeApp(firebaseConfig);
Â  const dbÂ  = getDatabase(app);

Â  // ====== ä¸€äº› DOM è®Šæ•¸ (ç•¥) ======
Â  const lobbyElÂ  Â  Â  Â  Â  Â = document.getElementById("lobby");
Â  const roomIdInputÂ  Â  Â  Â = document.getElementById("room-id-input");
Â  const createRoomBtnÂ  Â  Â = document.getElementById("create-room-btn");
Â  const joinRoomBtnÂ  Â  Â  Â = document.getElementById("join-room-btn");
Â  const roomListElÂ  Â  Â  Â  = document.getElementById("room-list");

Â  const lockBtnÂ  Â  Â  Â  Â  Â = document.getElementById("lock-btn");
Â  const playerListElÂ  Â  Â  = document.getElementById("player-list");
Â  const refreshCardBtnÂ  Â  = document.getElementById("refresh-card-btn");

Â  const publicGridElÂ  Â  Â  = document.getElementById("public-grid");
Â  const myCardGridElÂ  Â  Â  = document.getElementById("mycard-grid");
Â  const turnHintElÂ  Â  Â  Â  = document.getElementById("turn-hint");

Â  const bingoCountLabelEl = document.getElementById("bingo-count-label");
Â  const bragBtnÂ  Â  Â  Â  Â  Â = document.getElementById("brag-btn");

Â  const roomInfoIdElÂ  Â  Â  = document.getElementById("room-info-id");
Â  const roomInfoNickElÂ  Â  = document.getElementById("room-info-nick");
Â  const logBoxElÂ  Â  Â  Â  Â  = document.getElementById("log-box");

Â  // æš±ç¨± modal
Â  const nicknameModalBackdrop = document.getElementById("nickname-modal-backdrop");
Â  const nicknameInputÂ  Â  Â  Â  Â = document.getElementById("nickname-input");
Â  const nicknameConfirmBtnÂ  Â  = document.getElementById("nickname-confirm-btn");

Â  // ====== ç‹€æ…‹ (ç•¥) ======
Â  let myUid = null;
Â  let myNickname = null;
Â  let currentRoomId = null;
Â  let isRoomHost = false;
Â  let isLocked = false;
Â  let myCardNumbers = []; // 25 numbers
Â  let myCardSelected = new Set(); // é¸ä¸­çš„è™Ÿç¢¼
Â  let bragState = {
Â  Â  lastLines: 0,
Â  Â  count: 0
Â  };

Â  // ç”¢ç”Ÿ / å–å¾— uid (ç•¥)
Â  function ensureMyUid() {
Â  Â  let uid = localStorage.getItem("company-bingo-uid");
Â  Â  if (!uid) {
Â  Â  Â  uid = "u_" + Math.random().toString(36).slice(2, 10);
Â  Â  Â  localStorage.setItem("company-bingo-uid", uid);
Â  Â  }
Â  Â  myUid = uid;
Â  }

Â  // å–å¾— / è¨­å®šæš±ç¨± (ç•¥)
Â  function ensureNickname() {
Â  Â  const nick = localStorage.getItem("company-bingo-nick");
Â  Â  if (!nick) {
Â  Â  Â  nicknameModalBackdrop.style.display = "flex";
Â  Â  Â  nicknameInput.focus();
Â  Â  } else {
Â  Â  Â  myNickname = nick;
Â  Â  Â  roomInfoNickEl.textContent = myNickname || "-";
Â  Â  }
Â  }

Â  nicknameConfirmBtn.addEventListener("click", () => {
Â  Â  const v = nicknameInput.value.trim();
Â  Â  if (!v) {
Â  Â  Â  alert("æš±ç¨±ä¸èƒ½ç©ºç™½");
Â  Â  Â  return;
Â  Â  }
Â  Â  myNickname = v;
Â  Â  localStorage.setItem("company-bingo-nick", v);
Â  Â  roomInfoNickEl.textContent = v;
Â  Â  nicknameModalBackdrop.style.display = "none";
Â  });

Â  nicknameInput.addEventListener("keydown", (e) => {
Â  Â  if (e.key === "Enter") {
Â  Â  Â  nicknameConfirmBtn.click();
Â  Â  }
Â  });

Â  // ====== å·¥å…· (ç•¥) ======

Â  function timeString() {
Â  Â  const d = new Date();
Â  Â  const hh = String(d.getHours()).padStart(2,"0");
Â  Â  const mm = String(d.getMinutes()).padStart(2,"0");
Â  Â  const ss = String(d.getSeconds()).padStart(2,"0");
Â  Â  return `${hh}:${mm}:${ss}`;
Â  }

Â  function appendLog(text) {
Â  Â  const line = `[${timeString()}] ${text}`;
Â  Â  logBoxEl.textContent += (logBoxEl.textContent ? "\n" : "") + line;
Â  Â  logBoxEl.scrollTop = logBoxEl.scrollHeight; // ç¢ºä¿æ»¾å‹•åˆ°åº•éƒ¨
Â  }

Â  function firebasePushLog(roomId, text) {
Â  Â  const logsRef = ref(db, `rooms/${roomId}/logs`);
Â  Â  push(logsRef, {
Â  Â  Â  t: serverTimestamp(),
Â  Â  Â  msg: text
Â  Â  });
Â  }

Â  // ç›£è½ logs æ›´æ–°
Â  function listenLogs(roomId) {
Â  Â  const logsRef = ref(db, `rooms/${roomId}/logs`);
Â  Â  onValue(logsRef, (snap) => {
Â  Â  Â  const val = snap.val() || {};
Â  Â  Â  const lines = Object.values(val)
Â  Â  Â  Â  .sort((a,b)=> (a.t||0) - (b.t||0))
Â  Â  Â  Â  .map(v => v.msg);
Â  Â  Â  logBoxEl.textContent = lines.join("\n");
Â  Â  Â  logBoxEl.scrollTop = logBoxEl.scrollHeight; // ç¢ºä¿æ»¾å‹•åˆ°åº•éƒ¨
Â  Â  });
Â  }

Â  // ====== å¤§å»³ï¼šæˆ¿é–“åˆ—è¡¨ (ç•¥) ======
Â  function listenRoomList() {
Â  Â  const roomsRef = ref(db, "rooms");
Â  Â  onValue(roomsRef, (snap) => {
Â  Â  Â  const val = snap.val() || {};
Â  Â  Â  const rows = Object.entries(val).map(([rid, room]) => {
Â  Â  Â  Â  const players = room.players ? Object.keys(room.players).length : 0;
Â  Â  Â  Â  const locked = !!room.locked;
Â  Â  Â  Â  return { rid, players, locked };
Â  Â  Â  });
Â  Â  Â  roomListEl.innerHTML = rows.length
Â  Â  Â  Â  ? "<div style='font-size:13px;margin-bottom:4px;'>å·²å»ºç«‹æˆ¿é–“ï¼š</div>"
Â  Â  Â  Â  : "<div style='font-size:13px;color:#777;'>ç›®å‰å°šç„¡æˆ¿é–“</div>";

Â  Â  Â  rows.forEach(r => {
Â  Â  Â  Â  const row = document.createElement("div");
Â  Â  Â  Â  row.className = "room-row";
Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  ${r.locked ? "<span class='room-lock'>ğŸ”’</span>" : ""}
Â  Â  Â  Â  Â  Â  æˆ¿è™Ÿ ${r.rid}ï¼ˆç©å®¶ï¼š${r.players}ï¼‰
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  const btn = document.createElement("button");
Â  Â  Â  Â  btn.className = "btn btn-outline";
Â  Â  Â  Â  btn.textContent = "åŠ å…¥";
Â  Â  Â  Â  btn.onclick = () => {
Â  Â  Â  Â  Â  roomIdInput.value = r.rid;
Â  Â  Â  Â  Â  joinRoomBtn.click();
Â  Â  Â  Â  };
Â  Â  Â  Â  row.appendChild(btn);
Â  Â  Â  Â  roomListEl.appendChild(row);
Â  Â  Â  });
Â  Â  });
Â  }

Â  // å»ºç«‹æˆ¿é–“ (ç•¥)
Â  async function createRoom(roomId) {
Â  Â  const roomRef = ref(db, `rooms/${roomId}`);
Â  Â  const snap = await get(roomRef);
Â  Â  if (snap.exists()) {
Â  Â  Â  alert("æ­¤æˆ¿è™Ÿå·²å­˜åœ¨ï¼Œè«‹æ”¹ç”¨åŠ å…¥æˆ–æ›ä¸€å€‹æˆ¿è™Ÿã€‚");
Â  Â  Â  return;
Â  Â  }
Â  Â  await set(roomRef, {
Â  Â  Â  info: {
Â  Â  Â  Â  createdAt: serverTimestamp(),
Â  Â  Â  Â  host: myUid
Â  Â  Â  },
Â  Â  Â  locked: false
Â  Â  });
Â  Â  return joinRoom(roomId, true);
Â  }

Â  // åŠ å…¥æˆ¿é–“ (ç•¥)
Â  async function joinRoom(roomId, createdNow = false) {
Â  Â  if (!myNickname) {
Â  Â  Â  alert("è«‹å…ˆè¨­å®šæš±ç¨±");
Â  Â  Â  ensureNickname();
Â  Â  Â  return;
Â  Â  }
Â  Â  const roomRef = ref(db, `rooms/${roomId}`);
Â  Â  const snap = await get(roomRef);
Â  Â  if (!snap.exists()) {
Â  Â  Â  alert("æˆ¿é–“ä¸å­˜åœ¨ï¼Œè«‹å…ˆå»ºç«‹æˆ–ç¢ºèªæˆ¿è™Ÿã€‚");
Â  Â  Â  return;
Â  Â  }

Â  Â  const room = snap.val() || {};
Â  Â  const host = room.info?.host;

Â  Â  isRoomHost = !host || host === myUid; // æ²’ host æˆ– host æ˜¯è‡ªå·±ï¼Œå°±ç•¶ host
Â  Â  if (!host) {
Â  Â  Â  await update(roomRef.child ? roomRef.child("info") : child(roomRef,"info"), {
Â  Â  Â  Â  host: myUid
Â  Â  Â  }).catch(()=>{});
Â  Â  }

Â  Â  currentRoomId = roomId;

Â  Â  // ç©å®¶è¨»å†Š
Â  Â  const playerRef = ref(db, `rooms/${roomId}/players/${myUid}`);
Â  Â  await set(playerRef, {
Â  Â  Â  nickname: myNickname,
Â  Â  Â  joinedAt: serverTimestamp()
Â  Â  });

Â  Â  // å¦‚æœæ²’æœ‰è‡ªå·±çš„å¡ç‰‡ï¼Œç”¢ä¸€å¼µ
Â  Â  await ensureMyCard(roomId);

Â  Â  // UI èª¿æ•´
Â  Â  lobbyEl.style.display = "none";
Â  Â  roomInfoIdEl.textContent = roomId;
Â  Â  roomInfoNickEl.textContent = myNickname;

Â  Â  listenRoomState(roomId);
Â  Â  listenPlayers(roomId);
Â  Â  listenLogs(roomId);

Â  Â  firebasePushLog(roomId, `${myNickname} åŠ å…¥æˆ¿é–“`);
Â  }

Â  // ç›£è½æˆ¿é–“é–å®š / å…¬å…±è™Ÿç¢¼ / å¡ç‰‡ç­‰ (ç•¥)
Â  function listenRoomState(roomId) {
Â  Â  const roomRef = ref(db, `rooms/${roomId}`);
Â  Â  onValue(roomRef, (snap) => {
Â  Â  Â  const val = snap.val() || {};
Â  Â  Â  isLocked = !!val.locked;
Â  Â  Â  updateLockButtonUI();

Â  Â  Â  // å…¬å…±è™Ÿç¢¼é¡¯ç¤º
Â  Â  Â  const pubSelected = new Set();
Â  Â  Â  if (val.publicNumbers) {
Â  Â  Â  Â  Object.keys(val.publicNumbers).forEach(num => {
Â  Â  Â  Â  Â  if (val.publicNumbers[num]) pubSelected.add(Number(num));
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  renderPublicGrid(pubSelected);

Â  Â  Â  // æ›´æ–°å›åˆæç¤ºï¼ˆç°¡åŒ–ç‰ˆï¼Œåƒ…é¡¯ç¤ºæ˜¯å¦é–å®šï¼‰
Â  Â  Â  if (!isLocked) {
Â  Â  Â  Â  turnHintEl.textContent = "å°šæœªé–å®šï¼Œè«‹æˆ¿ä¸»å…ˆé–å®šé–‹å§‹ã€‚";
Â  Â  Â  } else {
Â  Â  Â  Â  turnHintEl.textContent = "éŠæˆ²å·²é–å®šï¼Œå¤§å®¶å¯ä»¥é–‹å§‹é¸è™Ÿã€‚";
Â  Â  Â  }
Â  Â  Â  updateAllButtonsEnabled();
Â  Â  });
Â  }

Â  function listenPlayers(roomId) {
Â  Â  const playersRef = ref(db, `rooms/${roomId}/players`);
Â  Â  onValue(playersRef, (snap) => {
Â  Â  Â  const val = snap.val() || {};
Â  Â  Â  const list = Object.entries(val)
Â  Â  Â  Â  .map(([uid,obj]) => ({
Â  Â  Â  Â  Â  uid, nick: obj.nickname || "ï¼ˆæœªå‘½åï¼‰"
Â  Â  Â  Â  }))
Â  Â  Â  Â  .sort((a,b)=> a.nick.localeCompare(b.nick,"zh-Hant"));
Â  Â  Â  renderPlayerList(list);
Â  Â  });
Â  }

Â  // ====== å…¬å…±è™Ÿç¢¼ã€æˆ‘çš„å¡ç‰‡ (ç•¥) ======

Â  // ç”¢ç”Ÿå¡ç‰‡ (ç•¥)
Â  async function ensureMyCard(roomId) {
Â  Â  const cardRef = ref(db, `rooms/${roomId}/cards/${myUid}`);
Â  Â  const snap = await get(cardRef);
Â  Â  let nums;
Â  Â  if (snap.exists()) {
Â  Â  Â  nums = snap.val();
Â  Â  } else {
Â  Â  Â  const pool = [];
Â  Â  Â  for (let i=1;i<=50;i++) pool.push(i);
Â  Â  Â  pool.sort(()=>Math.random()-0.5);
Â  Â  Â  nums = pool.slice(0,25);
Â  Â  Â  await set(cardRef, nums);
Â  Â  }
Â  Â  myCardNumbers = nums;
Â  Â  myCardSelected = new Set();
Â  Â  renderMyCardGrid();
Â  Â  updateBingoCount();
Â  }

Â  function renderPublicGrid(selectedSet = new Set()) {
Â  Â  publicGridEl.innerHTML = "";
Â  Â  for (let i=1;i<=50;i++) {
Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  div.className = "num-btn";
Â  Â  Â  div.textContent = i;
Â  Â  Â  div.dataset.num = String(i);
Â  Â  Â  if (selectedSet.has(i)) div.classList.add("selected");
Â  Â  Â  if (!isLocked) {
Â  Â  Â  Â  div.classList.add("pointer-forbidden");
Â  Â  Â  }
Â  Â  Â  publicGridEl.appendChild(div);
Â  Â  }
Â  }

Â  function renderMyCardGrid() {
Â  Â  myCardGridEl.innerHTML = "";
Â  Â  myCardNumbers.forEach(num => {
Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  div.className = "num-btn num-btn-mycard";
Â  Â  Â  div.textContent = num;
Â  Â  Â  div.dataset.num = String(num);
Â  Â  Â  if (myCardSelected.has(num)) div.classList.add("selected");
Â  Â  Â  myCardGridEl.appendChild(div);
Â  Â  });
Â  Â  updateAllButtonsEnabled();
Â  }

Â  function updateAllButtonsEnabled() {
Â  Â  // å…¬å…±è™Ÿç¢¼ï¼šåªèƒ½é¡¯ç¤ºï¼Œç¦æ­¢ç›´æ¥é» (ä¿æŒåŸæ¨£)
Â  Â  publicGridEl.querySelectorAll(".num-btn").forEach(btn => {
Â  Â  Â  if (!isLocked) {
Â  Â  Â  Â  btn.classList.add("pointer-forbidden");
Â  Â  Â  } else {
Â  Â  Â  Â  btn.classList.remove("pointer-forbidden");
Â  Â  Â  }
Â  Â  });

Â  Â  // æˆ‘çš„å¡ç‰‡ï¼šé–å®šå‰ä¸èƒ½é» (ä¿æŒåŸæ¨£)
Â  Â  myCardGridEl.querySelectorAll(".num-btn").forEach(btn => {
Â  Â  Â  if (!isLocked) {
Â  Â  Â  Â  btn.classList.add("disabled","pointer-forbidden");
Â  Â  Â  } else {
Â  Â  Â  Â  btn.classList.remove("disabled","pointer-forbidden");
Â  Â  Â  }
Â  Â  });

Â  Â  // åˆ·æ–°æŒ‰éˆ•ï¼šé–å®šå¾Œå°±é–ä½é¿å…ä½œå¼Š (ä¿æŒåŸæ¨£)
Â  Â  refreshCardBtn.disabled = isLocked;

Â  Â  // é–å®šæŒ‰éˆ•åªæœ‰æˆ¿ä¸»å¯ä»¥æŒ‰ (ä¿æŒåŸæ¨£)
Â  Â  if (!isRoomHost || !currentRoomId) {
Â  Â  Â  lockBtn.disabled = true;
Â  Â  } else {
Â  Â  Â  lockBtn.disabled = false;
Â  Â  }
Â  }

Â  function updateLockButtonUI() {
Â  Â  if (isLocked) {
Â  Â  Â  lockBtn.textContent = "å–æ¶ˆé–å®šï¼ˆçµæŸæœ¬å±€ï¼‰";
Â  Â  Â  lockBtn.classList.remove("lock-btn-unlock");
Â  Â  Â  lockBtn.classList.add("lock-btn-locked"); // é–å®šæ™‚åç´…
Â  Â  } else {
Â  Â  Â  lockBtn.textContent = "é–å®šé–‹å§‹æœ¬å±€";
Â  Â  Â  lockBtn.classList.remove("lock-btn-locked");
Â  Â  Â  lockBtn.classList.add("lock-btn-unlock");
Â  Â  }
Â  }

Â  // è¨ˆç®— BINGO æ¢æ•¸ï¼ˆè‡ªå·±å¡ç‰‡ï¼‰(ç•¥)
Â  function computeBingoLines() {
Â  Â  const marked = new Set(myCardSelected);
Â  Â  let lines = 0;
Â  Â  // 5x5
Â  Â  const getNum = (r,c)=> myCardNumbers[r*5 + c];

Â  Â  // row
Â  Â  for (let r=0;r<5;r++) {
Â  Â  Â  let ok = true;
Â  Â  Â  for (let c=0;c<5;c++) {
Â  Â  Â  Â  if (!marked.has(getNum(r,c))) { ok=false; break; }
Â  Â  Â  }
Â  Â  Â  if (ok) lines++;
Â  Â  }
Â  Â  // col
Â  Â  for (let c=0;c<5;c++) {
Â  Â  Â  let ok = true;
Â  Â  Â  for (let r=0;r<5;r++) {
Â  Â  Â  Â  if (!marked.has(getNum(r,c))) { ok=false; break; }
Â  Â  Â  }
Â  Â  Â  if (ok) lines++;
Â  Â  }
Â  Â  // diag 1
Â  Â  let ok1 = true;
Â  Â  for (let i=0;i<5;i++) {
Â  Â  Â  if (!marked.has(getNum(i,i))) { ok1=false; break; }
Â  Â  }
Â  Â  if (ok1) lines++;
Â  Â  // diag 2
Â  Â  let ok2 = true;
Â  Â  for (let i=0;i<5;i++) {
Â  Â  Â  if (!marked.has(getNum(i,4-i))) { ok2=false; break; }
Â  Â  }
Â  Â  if (ok2) lines++;
Â  Â  return lines;
Â  }

Â  function updateBingoCount() {
Â  Â  const lines = computeBingoLines();
Â  Â  bingoCountLabelEl.textContent = `ç›®å‰ BINGOï¼š${lines} æ¢`;
Â  Â  if (lines > 0) {
Â  Â  Â  bingoCountLabelEl.classList.add("bingo-highlight");
Â  Â  } else {
Â  Â  Â  bingoCountLabelEl.classList.remove("bingo-highlight");
Â  Â  }

Â  Â  // æ›´æ–°ç‚«è€€ç‹€æ…‹ï¼ˆå¦‚æœæ¢æ•¸å¢åŠ å°±é‡ç½®æ¬¡æ•¸ï¼‰(ç•¥)
Â  Â  if (lines > bragState.lastLines) {
Â  Â  Â  bragState.lastLines = lines;
Â  Â  Â  bragState.count = 0;
Â  Â  Â  bragBtn.disabled = lines === 0;
Â  Â  } else if (lines === 0) {
Â  Â  Â  bragState.lastLines = 0;
Â  Â  Â  bragState.count = 0;
Â  Â  Â  bragBtn.disabled = true;
Â  Â  } else {
Â  Â  Â  // æ¢æ•¸æ²’è®Šï¼šç¶­æŒåŸæœ‰ countï¼Œä½†å¦‚æœå·²é–æ­»å°±ä¿æŒ disabled
Â  Â  Â  if (bragState.count >= 3) {
Â  Â  Â  Â  bragBtn.disabled = true;
Â  Â  Â  } else {
Â  Â  Â  Â  bragBtn.disabled = false;
Â  Â  Â  }
Â  Â  }
Â  }

Â  // ====== æ¸²æŸ“ç©å®¶åˆ—è¡¨ (ç•¥) ======
Â  function renderPlayerList(list) {
Â  Â  playerListEl.innerHTML = "";
Â  Â  list.forEach(p => {
Â  Â  Â  const row = document.createElement("div");
Â  Â  Â  row.className = "player-row";
Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  <div>${p.uid === myUid ? "ğŸ‘¤" : "ğŸ§‘"} ${p.nick}</div>
Â  Â  Â  Â  ${p.uid === myUid ? "<span style='font-size:11px;color:#ff9800;'>(ä½ )</span>" : ""}
Â  Â  Â  `;
Â  Â  Â  playerListEl.appendChild(row);
Â  Â  });
Â  }

Â  // ====== äº‹ä»¶ç¶å®š (ç•¥) ======

Â  // å»ºç«‹æˆ¿é–“ (ç•¥)
Â  createRoomBtn.addEventListener("click", async () => {
Â  Â  const roomId = roomIdInput.value.trim();
Â  Â  if (!roomId) {
Â  Â  Â  alert("è«‹è¼¸å…¥æˆ¿è™Ÿ");
Â  Â  Â  return;
Â  Â  }
Â  Â  await createRoom(roomId);
Â  });

Â  // åŠ å…¥æˆ¿é–“ (ç•¥)
Â  joinRoomBtn.addEventListener("click", async () => {
Â  Â  const roomId = roomIdInput.value.trim();
Â  Â  if (!roomId) {
Â  Â  Â  alert("è«‹è¼¸å…¥æˆ¿è™Ÿ");
Â  Â  Â  return;
Â  Â  }
Â  Â  await joinRoom(roomId, false);
Â  });

Â  // é–å®š / è§£é– (ç•¥)
Â  lockBtn.addEventListener("click", async () => {
Â  Â  if (!currentRoomId || !isRoomHost) return;

Â  Â  const newLocked = !isLocked;
Â  Â  if (!newLocked) {
Â  Â  Â  // è§£é™¤é–å®šæ™‚å•ä¸€ä¸‹
Â  Â  Â  if (!confirm("ç¢ºå®šè¦çµæŸæ­¤å±€ä¸¦è§£é™¤é–å®šï¼Ÿ\nå…¬å…±è™Ÿç¢¼æœƒæ¸…é™¤ï¼Œä½†å„è‡ªå¡ç‰‡çš„å‹¾é¸ä¸æœƒè¢«åˆªé™¤ã€‚")) {
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  // æ¸…ç©ºå…¬å…±è™Ÿç¢¼
Â  Â  Â  await remove(ref(db, `rooms/${currentRoomId}/publicNumbers`));
Â  Â  Â  firebasePushLog(currentRoomId, `${myNickname} å–æ¶ˆé–å®šï¼ŒçµæŸæœ¬å±€ã€‚`);
Â  Â  } else {
Â  Â  Â  firebasePushLog(currentRoomId, `${myNickname} é–å®šé–‹å§‹æœ¬å±€ã€‚`);
Â  Â  }

Â  Â  await update(ref(db, `rooms/${currentRoomId}`), {
Â  Â  Â  locked: newLocked
Â  Â  });
Â  });

Â  // é‡æ–°æŠ½å¡ç‰‡ï¼ˆåªèƒ½åœ¨æœªé–å®šæ™‚ï¼‰(ç•¥)
Â  refreshCardBtn.addEventListener("click", async () => {
Â  Â  if (!currentRoomId) return;
Â  Â  if (isLocked) return;
Â  Â  if (!confirm("ç¢ºå®šè¦é‡æ–°æŠ½å¡ç‰‡ï¼Ÿ")) return;

Â  Â  const pool = [];
Â  Â  for (let i=1;i<=50;i++) pool.push(i);
Â  Â  pool.sort(()=>Math.random()-0.5);
Â  Â  const nums = pool.slice(0,25);
Â  Â  await set(ref(db, `rooms/${currentRoomId}/cards/${myUid}`), nums);

Â  Â  myCardNumbers = nums;
Â  Â  myCardSelected.clear();
Â  Â  renderMyCardGrid();
Â  Â  updateBingoCount();

Â  Â  firebasePushLog(currentRoomId, `${myNickname} é‡æ–°æŠ½å¡ç‰‡`);
Â  });

Â  // é»ã€Œæˆ‘çš„å¡ç‰‡ã€ä¸Šçš„è™Ÿç¢¼
Â  myCardGridEl.addEventListener("click", async (e) => {
Â  Â  const target = e.target.closest(".num-btn");
Â  Â  if (!target || !currentRoomId) return;
Â  Â  if (!isLocked) return; // é–å®šå‰ä¸èƒ½é»
Â  Â  if (target.classList.contains("disabled")) return;

Â  Â  const num = Number(target.dataset.num);
Â  Â  const isSelected = myCardSelected.has(num);

Â  Â  if (isSelected) {
Â  Â  Â  myCardSelected.delete(num);
Â  Â  Â  target.classList.remove("selected");
Â  Â  Â  firebasePushLog(currentRoomId, `${myNickname}: å–æ¶ˆ ${num}`);
Â  Â  Â  // ä¾æ“šè¦æ±‚ 1ï¼šåƒ…éœ€è™•ç†è¼ªæ›æç¤ºï¼Œä¸ç”¨é€²è¡Œè™Ÿç¢¼é–å®šï¼ˆä¸æ›´æ–°å…¬å…±è™Ÿç¢¼ï¼‰
Â  Â  Â  // await update(ref(db, `rooms/${currentRoomId}/publicNumbers`), {
Â  Â  Â  // Â  [num]: false
Â  Â  Â  // });
Â  Â  } else {
Â  Â  Â  myCardSelected.add(num);
Â  Â  Â  target.classList.add("selected");
Â  Â  Â  firebasePushLog(currentRoomId, `${myNickname}: ${num}`);
Â  Â  Â  // ä¾æ“šè¦æ±‚ 1ï¼šåƒ…éœ€è™•ç†è¼ªæ›æç¤ºï¼Œä¸ç”¨é€²è¡Œè™Ÿç¢¼é–å®šï¼ˆä¸æ›´æ–°å…¬å…±è™Ÿç¢¼ï¼‰
Â  Â  Â  // await update(ref(db, `rooms/${currentRoomId}/publicNumbers`), {
Â  Â  Â  // Â  [num]: true
Â  Â  Â  // });
Â  Â  }
Â  Â  updateBingoCount();
Â  });

Â  // ç‚«è€€æŒ‰éˆ• (ç•¥)
Â  bragBtn.addEventListener("click", () => {
Â  Â  const lines = computeBingoLines();
Â  Â  if (lines <= 0) return;

Â  Â  // æ¢æ•¸æ²’è®Šæ‰æª¢æŸ¥æ¬¡æ•¸
Â  Â  if (lines === bragState.lastLines) {
Â  Â  Â  if (bragState.count >= 3) {
Â  Â  Â  Â  bragBtn.disabled = true;
Â  Â  Â  Â  alert("ä½èª¿ï¼ä½èª¿ï¼");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  bragState.count++;
Â  Â  } else {
Â  Â  Â  // æ¢æ•¸æ”¹è®Š
Â  Â  Â  bragState.lastLines = lines;
Â  Â  Â  bragState.count = 1;
Â  Â  }

Â  Â  if (!currentRoomId) return;
Â  Â  firebasePushLog(currentRoomId, `${myNickname} ç‚«è€€ï¼ç›®å‰ BINGO ${lines} æ¢ï½`);
Â  });

Â  // ====== åˆå§‹åŒ– (ç•¥) ======
Â  ensureMyUid();
Â  ensureNickname();
Â  listenRoomList();

Â  // å¦‚æœæš±ç¨±å½ˆçª—é‚„æ²’é—œï¼Œé˜»æ­¢ç›´æ¥å»ºç«‹ / åŠ å…¥ (ç•¥)
Â  [createRoomBtn, joinRoomBtn].forEach(btn => {
Â  Â  btn.addEventListener("click", (e) => {
Â  Â  Â  if (!myNickname) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  alert("è«‹å…ˆè¨­å®šæš±ç¨±");
Â  Â  Â  Â  ensureNickname();
Â  Â  Â  }
Â  Â  }, { capture:true });
Â  });
</script>
</body>
</html>
