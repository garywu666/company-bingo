<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å…¬å¸ Bingo å¤§å»³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }
    h1, h2, h3, h4, h5 {
      margin: 0;
      font-weight: 600;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 14px;
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
    input {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 12px 32px;
    }

    /* é ‚éƒ¨å€åŸŸ */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .top-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .top-title {
      font-size: 20px;
      font-weight: 700;
    }
    .top-sub {
      font-size: 13px;
      color: #666;
    }

    .room-panel {
      background: #fff;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 10px;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.06);
    }
    .room-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .room-panel-header h3 {
      font-size: 15px;
    }
    .room-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 8px;
    }
    .room-actions label {
      font-size: 13px;
      color: #444;
    }
    .room-actions input {
      min-width: 140px;
    }
    .room-actions button {
      background: #1976d2;
      color: #fff;
    }
    .toggle-room-panel-btn {
      font-size: 12px;
      background: #eee;
      color: #444;
      padding: 4px 8px;
    }

    .room-list {
      margin-top: 6px;
      max-height: 160px;
      overflow-y: auto;
      border-top: 1px dashed #ddd;
      padding-top: 6px;
      font-size: 13px;
    }
    .room-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #f1f1f1;
    }
    .room-row:last-child {
      border-bottom: none;
    }
    .room-info {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .room-lock {
      font-size: 14px;
    }
    .room-id {
      font-weight: 600;
    }
    .room-meta {
      color: #777;
      font-size: 12px;
    }
    .room-row button {
      background: #4caf50;
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
    }

    /* ä¸»å…§å®¹å¸ƒå±€ */
    .main-area {
      display: none; /* æœªé€²æˆ¿å‰éš±è— */
      margin-top: 6px;
      display: none;
    }
    .main-area.visible {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .panel {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.06);
      padding: 10px;
    }

    /* å·¦å´ï¼šç©å®¶æ’åº */
    .left-panel {
      width: 220px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .lock-btn {
      width: 100%;
      background: #ff9800;
      color: #fff;
      font-weight: 600;
    }
    .lock-btn.locked {
      background: #9e9e9e;
    }
    .player-sort-panel {
      flex: 1;
    }
    .player-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 14px;
      font-weight: 600;
    }
    .player-list {
      border: 1px solid #ddd;
      border-radius: 4px;
      max-height: 260px;
      overflow-y: auto;
    }
    .player-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px;
      border-bottom: 1px solid #f5f5f5;
      font-size: 13px;
    }
    .player-row:last-child {
      border-bottom: none;
    }
    .player-main {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .player-icon {
      font-size: 14px;
    }
    .player-name {
      max-width: 110px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .player-order {
      min-width: 22px;
      text-align: center;
      font-size: 12px;
      border-radius: 12px;
      padding: 1px 5px;
      background: #eee;
      color: #333;
    }
    .player-order.none {
      background: #fafafa;
      color: #aaa;
    }
    .player-row button {
      font-size: 11px;
      padding: 2px 6px;
      background: #e0e0e0;
      color: #333;
    }
    .player-row.disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    .refresh-card-btn {
      width: 100%;
      background: #2196f3;
      color: #fff;
    }

    /* ä¸­é–“ï¼šéŠæˆ²å€ */
    .center-panel {
      flex: 1.5;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .turn-hint {
      text-align: center;
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 15px;
    }
    .turn-hint span {
      color: #1976d2;
    }

    .numbers-panel {
      padding: 8px;
    }
    .panel-title-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .panel-title-row h3 {
      font-size: 15px;
    }

    .numbers-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
    }
    .numbers-grid button {
      padding: 4px 0;
      font-size: 13px;
      background: #e0e0e0;
      color: #333;
    }
    .numbers-grid button.selected {
      background: #3f51b5;
      color: #fff;
    }

    .my-card-panel {
      padding: 8px;
    }
    .my-card-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .my-card-header h3 {
      font-size: 15px;
    }
    .bingo-info {
      font-size: 15px;
      font-weight: 600;
    }
    .bingo-info span {
      color: #e91e63;
    }
    .my-card-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      max-width: 260px;
      margin: 0 auto;
    }
    .my-card-grid button {
      width: 100%;
      padding: 12px 0;
      background: #eeeeee;
    }
    .my-card-grid button.selected {
      background: #3f51b5;
      color: #fff;
    }
    .my-card-grid button.disabled {
      cursor: not-allowed;
    }
    .brag-btn {
      margin-left: 8px;
      background: #ff4081;
      color: #fff;
      font-size: 13px;
    }

    /* å³å´ï¼šæ—¥èªŒ */
    .right-panel {
      width: 280px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }
    .log-header {
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 600;
    }
    .log-meta {
      font-size: 13px;
      margin-bottom: 4px;
      color: #555;
    }
    .log-box {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #111;
      color: #eee;
      padding: 6px;
      font-family: Consolas, monospace;
      font-size: 12px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    /* å°è¢å¹• */
    @media (max-width: 960px) {
      .main-area.visible {
        flex-direction: column;
      }
      .left-panel, .right-panel {
        width: 100%;
      }
      .right-panel {
        height: 220px;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="top-bar">
    <div class="top-left">
      <div class="top-title">å…¬å¸ Bingo å¤§å»³</div>
      <div class="top-sub">ä½¿ç”¨åŒä¸€ç¶²å€ã€åŒä¸€ Firebaseï¼Œå°±èƒ½å¤§å®¶ä¸€èµ·ç©ã€‚</div>
    </div>
    <div id="nicknameDisplay" class="top-sub"></div>
  </div>

  <!-- æˆ¿é–“è¨­å®š -->
  <div class="room-panel" id="roomPanel">
    <div class="room-panel-header">
      <h3>æˆ¿é–“ç®¡ç†</h3>
      <button class="toggle-room-panel-btn" id="toggleRoomPanelBtn">éš±è—æˆ¿é–“è¨­å®š</button>
    </div>

    <div class="room-actions">
      <label>æˆ¿è™Ÿï¼š</label>
      <input id="roomIdInput" placeholder="ä¾‹å¦‚ï¼šA01 æˆ–è‡ªè¡Œå‘½å">
      <label>æš±ç¨±ï¼š</label>
      <input id="nicknameEdit" placeholder="æš±ç¨±" style="width:100px;">
      <button id="createRoomBtn">å»ºç«‹æˆ¿é–“</button>
      <button id="joinRoomBtn">åŠ å…¥æˆ¿é–“</button>
    </div>

    <div style="font-size:13px;color:#666;margin-bottom:4px;">å·²å»ºç«‹æˆ¿é–“ï¼š</div>
    <div class="room-list" id="roomList"></div>
  </div>

  <!-- ä¸»å…§å®¹ -->
  <div class="main-area" id="mainArea">
    <!-- å·¦å´ -->
    <div class="left-panel">
      <button class="lock-btn" id="lockBtn">é–å®šä¸¦é–‹å§‹æœ¬å±€</button>

      <div class="panel player-sort-panel">
        <div class="player-list-header">
          <span>ç©å®¶æ’åº</span>
          <span style="font-size:12px;color:#999;">é»æ“Šç©å®¶åˆ—è¨­å®š / å–æ¶ˆæ’åº</span>
        </div>
        <div class="player-list" id="playerList"></div>
      </div>

      <button class="refresh-card-btn" id="refreshCardBtn">é‡æ–°æŠ½æˆ‘çš„å¡ç‰‡</button>
    </div>

    <!-- ä¸­é–“ -->
    <div class="center-panel">
      <div class="panel numbers-panel">
        <div class="turn-hint" id="turnHint">å°šæœªé–å®šï¼Œè«‹æˆ¿ä¸»å…ˆè¨­å®šå·¦å´é †ä½ä¸¦é–å®šé–‹å§‹ã€‚</div>
        <div class="panel-title-row">
          <h3>å…¬å…±è™Ÿç¢¼ï¼ˆ1â€“50ï¼‰</h3>
        </div>
        <div class="numbers-grid" id="publicNumbersGrid"></div>
      </div>

      <div class="panel my-card-panel">
        <div class="my-card-header">
          <h3>æˆ‘çš„å¡ç‰‡</h3>
          <div class="bingo-info">ç›®å‰ BINGOï¼š<span id="bingoCount">0</span> æ¢</div>
          <button class="brag-btn" id="bragBtn" disabled>ç‚«è€€</button>
        </div>
        <div class="my-card-grid" id="myCardGrid"></div>
      </div>
    </div>

    <!-- å³å´ -->
    <div class="right-panel">
      <div class="panel" style="flex:1;display:flex;flex-direction:column;">
        <div class="log-header">æˆ¿é–“ / æ—¥èªŒ</div>
        <div class="log-meta" id="roomIdMeta">æˆ¿è™Ÿï¼š</div>
        <div class="log-meta" id="nicknameMeta">æš±ç¨±ï¼š</div>
        <div class="log-box" id="logBox"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // ===== Firebase åˆå§‹åŒ– =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getDatabase, ref, onValue, set, update, push, remove,
    runTransaction, get, child
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB4IBPbuGxztyzd8E3YTitMoTt8L19MSG0",
    authDomain: "company-bingo.firebaseapp.com",
    databaseURL: "https://company-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "company-bingo",
    storageBucket: "company-bingo.firebasestorage.app",
    messagingSenderId: "844173689886",
    appId: "1:844173689886:web:ac2f1888f542b138861a0f",
    measurementId: "G-WGDVJPKMEH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ===== DOM åƒç…§ =====
  const nicknameDisplay = document.getElementById('nicknameDisplay');
  const roomPanel = document.getElementById('roomPanel');
  const toggleRoomPanelBtn = document.getElementById('toggleRoomPanelBtn');
  const roomIdInput = document.getElementById('roomIdInput');
  const nicknameEdit = document.getElementById('nicknameEdit');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const roomList = document.getElementById('roomList');

  const mainArea = document.getElementById('mainArea');
  const lockBtn = document.getElementById('lockBtn');
  const playerListEl = document.getElementById('playerList');
  const refreshCardBtn = document.getElementById('refreshCardBtn');

  const publicNumbersGrid = document.getElementById('publicNumbersGrid');
  const myCardGrid = document.getElementById('myCardGrid');
  const turnHint = document.getElementById('turnHint');
  const bingoCountEl = document.getElementById('bingoCount');
  const bragBtn = document.getElementById('bragBtn');

  const roomIdMeta = document.getElementById('roomIdMeta');
  const nicknameMeta = document.getElementById('nicknameMeta');
  const logBox = document.getElementById('logBox');

  // ===== ä½¿ç”¨è€…è³‡è¨Š =====
  let myUid = localStorage.getItem('bingo_uid');
  if (!myUid) {
    myUid = 'u_' + Math.random().toString(36).slice(2, 10);
    localStorage.setItem('bingo_uid', myUid);
  }

  function askNicknameIfNeeded() {
    let name = localStorage.getItem('bingo_nickname');
    while (!name || !name.trim()) {
      name = prompt('è«‹è¼¸å…¥ä½ çš„æš±ç¨±ï¼š');
      if (name === null) name = ''; // é˜²æ­¢å–æ¶ˆè®Š null
    }
    name = name.trim();
    localStorage.setItem('bingo_nickname', name);
    return name;
  }

  let myNickname = localStorage.getItem('bingo_nickname') || askNicknameIfNeeded();
  nicknameDisplay.textContent = `ç›®å‰æš±ç¨±ï¼š${myNickname}`;
  nicknameEdit.value = myNickname;

  nicknameEdit.addEventListener('change', () => {
    const v = nicknameEdit.value.trim();
    if (!v) return;
    myNickname = v;
    localStorage.setItem('bingo_nickname', v);
    nicknameDisplay.textContent = `ç›®å‰æš±ç¨±ï¼š${myNickname}`;
    nicknameMeta.textContent = `æš±ç¨±ï¼š${myNickname}`;
    // è‹¥å·²åœ¨æˆ¿é–“ï¼Œæ›´æ–° players åç¨±
    if (currentRoomId && currentRoomId !== '') {
      update(ref(db, `rooms/${currentRoomId}/players/${myUid}`), { name: myNickname });
    }
  });

  // ===== ç‹€æ…‹ =====
  let currentRoomId = null;
  let currentRoomRef = null;
  let players = {};          // uid -> { name, order }
  let publicNumbers = {};    // number -> true
  let myBoardNumbers = [];   // [25]
  let roomLocked = false;
  let roomHostUid = null;
  let currentTurnIndex = 0;  // æ•´æ•¸ï¼›æŒ‡å‘æ’åºå¾Œç©å®¶é™£åˆ— index

  // ç‚«è€€æ§åˆ¶
  let myBingoLines = 0;
  let lastBragLines = 0;
  let bragClicksForCurrentLines = 0;
  let bragLocked = false;

  // ===== å·¥å…· =====
  function logToBox(line) {
    logBox.textContent += line + "\n";
    logBox.scrollTop = logBox.scrollHeight;
  }

  function addLog(roomId, text) {
    const logsRef = ref(db, `rooms/${roomId}/logs`);
    const now = new Date();
    const hh = now.getHours().toString().padStart(2, '0');
    const mm = now.getMinutes().toString().padStart(2, '0');
    const ss = now.getSeconds().toString().padStart(2, '0');
    const timeStr = `${hh}:${mm}:${ss}`;
    push(logsRef, { time: timeStr, text });
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function generateBoardNumbers() {
    const nums = [];
    for (let i = 1; i <= 50; i++) nums.push(i);
    shuffle(nums);
    return nums.slice(0, 25);
  }

  function isMyTurn() {
    if (!roomLocked) return false;
    const ordered = getOrderedPlayers();
    if (ordered.length === 0) return false;
    const idx = currentTurnIndex % ordered.length;
    return ordered[idx] && ordered[idx].uid === myUid;
  }

  function getOrderedPlayers() {
    const arr = Object.entries(players)
      .map(([uid, p]) => ({ uid, name: p.name || '', order: p.order ?? null }));
    const withOrder = arr.filter(p => p.order != null).sort((a, b) => a.order - b.order);
    return withOrder;
  }

  function recalcBingoLines() {
    if (myBoardNumbers.length !== 25) return 0;
    const chosenSet = publicNumbers;
    let lines = 0;

    // row
    for (let r = 0; r < 5; r++) {
      let ok = true;
      for (let c = 0; c < 5; c++) {
        const n = myBoardNumbers[r * 5 + c];
        if (!chosenSet[n]) { ok = false; break; }
      }
      if (ok) lines++;
    }
    // col
    for (let c = 0; c < 5; c++) {
      let ok = true;
      for (let r = 0; r < 5; r++) {
        const n = myBoardNumbers[r * 5 + c];
        if (!chosenSet[n]) { ok = false; break; }
      }
      if (ok) lines++;
    }
    // diag 1
    let ok1 = true;
    for (let i = 0; i < 5; i++) {
      const n = myBoardNumbers[i * 5 + i];
      if (!chosenSet[n]) { ok1 = false; break; }
    }
    if (ok1) lines++;
    // diag 2
    let ok2 = true;
    for (let i = 0; i < 5; i++) {
      const n = myBoardNumbers[i * 5 + (4 - i)];
      if (!chosenSet[n]) { ok2 = false; break; }
    }
    if (ok2) lines++;

    myBingoLines = lines;
    bingoCountEl.textContent = String(lines);

    // ç‚«è€€æ§åˆ¶
    if (lines > lastBragLines) {
      lastBragLines = lines;
      bragClicksForCurrentLines = 0;
      bragLocked = false;
    }
    updateBragButtonState();
  }

  function updateBragButtonState() {
    if (myBingoLines <= 0 || bragLocked) {
      bragBtn.disabled = true;
    } else {
      bragBtn.disabled = false;
    }
  }

  // ===== æˆ¿é–“åˆ—è¡¨ & æ¸…æˆ¿é–“ =====
  function renderRoomList(snapshot) {
    const data = snapshot.val() || {};
    roomList.innerHTML = '';
    const entries = Object.entries(data);
    if (entries.length === 0) {
      roomList.textContent = 'ç›®å‰æ²’æœ‰æˆ¿é–“ï¼Œè«‹å»ºç«‹ä¸€å€‹å§ã€‚';
      return;
    }
    entries.forEach(([roomId, r]) => {
      const row = document.createElement('div');
      row.className = 'room-row';

      const info = document.createElement('div');
      info.className = 'room-info';

      const lock = document.createElement('span');
      lock.className = 'room-lock';
      lock.textContent = r.locked ? 'ğŸ”’' : 'ğŸ”“';

      const idSpan = document.createElement('span');
      idSpan.className = 'room-id';
      idSpan.textContent = roomId;

      const meta = document.createElement('span');
      meta.className = 'room-meta';
      const playerCount = r.players ? Object.keys(r.players).length : 0;
      meta.textContent = `ç©å®¶ï¼š${playerCount}`;

      info.appendChild(lock);
      info.appendChild(idSpan);
      info.appendChild(meta);

      const joinBtn = document.createElement('button');
      joinBtn.textContent = 'åŠ å…¥';
      joinBtn.onclick = () => joinRoom(roomId);

      row.appendChild(info);
      row.appendChild(joinBtn);
      roomList.appendChild(row);
    });
  }

  function cleanupEmptyRoomsOnce() {
    const roomsRef = ref(db, 'rooms');
    get(roomsRef).then(snap => {
      const data = snap.val() || {};
      const now = Date.now();
      const toDelete = [];
      for (const [roomId, r] of Object.entries(data)) {
        const playerCount = r.players ? Object.keys(r.players).length : 0;
        const lastActive = r.lastActive || 0;
        if (playerCount === 0 && now - lastActive > 5 * 60 * 1000) {
          toDelete.push(roomId);
        }
      }
      toDelete.forEach(id => remove(ref(db, 'rooms/' + id)));
    });
  }

  // å•Ÿå‹•æ™‚åŠæ¯ 5 åˆ†é˜æ¸…ä¸€æ¬¡
  cleanupEmptyRoomsOnce();
  setInterval(cleanupEmptyRoomsOnce, 5 * 60 * 1000);

  onValue(ref(db, 'rooms'), snapshot => {
    renderRoomList(snapshot);
  });

  // ===== åŠ å…¥ / å»ºç«‹ æˆ¿é–“ =====
  createRoomBtn.onclick = () => {
    const id = roomIdInput.value.trim() || Math.random().toString(36).slice(2, 6).toUpperCase();
    createRoom(id);
  };
  joinRoomBtn.onclick = () => {
    const id = roomIdInput.value.trim();
    if (!id) {
      alert('è«‹å…ˆè¼¸å…¥æˆ¿è™Ÿï¼Œæˆ–å¾ä¸‹æ–¹åˆ—è¡¨é¸æ“‡æˆ¿é–“ã€‚');
      return;
    }
    joinRoom(id);
  };

  function createRoom(roomId) {
    const roomsRef = ref(db, `rooms/${roomId}`);
    get(roomsRef).then(snap => {
      if (snap.exists()) {
        alert('æ­¤æˆ¿è™Ÿå·²å­˜åœ¨ï¼Œè«‹æ”¹ç”¨ã€ŒåŠ å…¥æˆ¿é–“ã€æˆ–æ›ä¸€å€‹æˆ¿è™Ÿã€‚');
        return;
      }
      const board = generateBoardNumbers();
      const roomData = {
        createdAt: Date.now(),
        lastActive: Date.now(),
        locked: false,
        hostUid: myUid,
        state: { turnIndex: 0 },
        players: {
          [myUid]: {
            name: myNickname,
            order: 1
          }
        },
        boards: {
          [myUid]: board
        },
        publicNumbers: null
      };
      set(roomsRef, roomData).then(() => {
        addLog(roomId, `${myNickname} å»ºç«‹æˆ¿é–“`);
        joinRoom(roomId, true);
      });
    });
  }

  function joinRoom(roomId, alreadyCreated = false) {
    const roomsRef = ref(db, `rooms/${roomId}`);
    get(roomsRef).then(snap => {
      if (!snap.exists()) {
        if (!alreadyCreated) {
          alert('æ‰¾ä¸åˆ°é€™å€‹æˆ¿è™Ÿï¼Œè«‹ç¢ºèªæ˜¯å¦è¼¸å…¥éŒ¯èª¤ã€‚');
        }
        return;
      }
      const r = snap.val();
      const updates = {};
      // è‹¥æ²’æœ‰ board å°±å¹«è‡ªå·±ç”Ÿæˆ
      if (!r.boards || !r.boards[myUid]) {
        updates[`boards/${myUid}`] = generateBoardNumbers();
      }
      // åŠ å…¥ players
      const existingPlayers = r.players || {};
      if (!existingPlayers[myUid]) {
        updates[`players/${myUid}`] = {
          name: myNickname,
          order: null
        };
        addLog(roomId, `${myNickname} åŠ å…¥æˆ¿é–“`);
      }
      updates['lastActive'] = Date.now();
      update(roomsRef, updates).then(() => {
        enterRoom(roomId);
      });
    });
  }

  function leaveRoom() {
    if (!currentRoomId) return;
    const roomId = currentRoomId;
    const roomRef = ref(db, `rooms/${roomId}`);
    get(roomRef).then(snap => {
      if (!snap.exists()) {
        currentRoomId = null;
        currentRoomRef = null;
        mainArea.classList.remove('visible');
        return;
      }
      const r = snap.val();
      const updates = {};
      if (r.players && r.players[myUid]) {
        updates[`players/${myUid}`] = null;
        updates[`boards/${myUid}`] = null;
        addLog(roomId, `${myNickname} é›¢é–‹æˆ¿é–“`);
      }
      // è‹¥æˆ‘æ˜¯æˆ¿ä¸»ä¸”é‚„æœ‰å…¶ä»–äºº â†’ å°‡ host ç§»çµ¦ç¬¬ä¸€ä½ç©å®¶
      let nextHostUid = null;
      if (r.hostUid === myUid && r.players) {
        const remaining = Object.keys(r.players).filter(uid => uid !== myUid);
        if (remaining.length > 0) {
          nextHostUid = remaining[0];
          updates['hostUid'] = nextHostUid;
        }
      }
      updates['lastActive'] = Date.now();
      update(roomRef, updates).then(() => {
        if (nextHostUid) {
          const name = (r.players[nextHostUid] && r.players[nextHostUid].name) || 'ç©å®¶';
          addLog(roomId, `ç³»çµ±: éšŠé•·å·²è½‰ç§» ${name}`);
        }
      });
    });

    // æœ¬åœ°æ¸…ç†
    currentRoomId = null;
    currentRoomRef = null;
    players = {};
    publicNumbers = {};
    myBoardNumbers = [];
    roomLocked = false;
    roomHostUid = null;
    currentTurnIndex = 0;

    mainArea.classList.remove('visible');
    roomIdMeta.textContent = 'æˆ¿è™Ÿï¼š';
    nicknameMeta.textContent = `æš±ç¨±ï¼š${myNickname}`;
    logBox.textContent = '';
  }

  window.addEventListener('beforeunload', () => {
    // é€™åªåœ¨ä½¿ç”¨è€…æ­£å¸¸é—œé æ™‚æ‰æœ‰æ©ŸæœƒåŸ·è¡Œï¼›éä¿è­‰
    leaveRoom();
  });

  // ===== é€²å…¥æˆ¿é–“å¾Œï¼Œç¶å®šå„ç¨®ç›£è½ =====
  let roomListeners = [];

  function clearRoomListeners() {
    roomListeners.forEach(unsub => unsub && unsub());
    roomListeners = [];
  }

  function enterRoom(roomId) {
    if (currentRoomId === roomId) return;
    clearRoomListeners();

    currentRoomId = roomId;
    currentRoomRef = ref(db, `rooms/${roomId}`);

    roomIdMeta.textContent = `æˆ¿è™Ÿï¼š${roomId}`;
    nicknameMeta.textContent = `æš±ç¨±ï¼š${myNickname}`;
    mainArea.classList.add('visible');
    // åŠ å…¥å¾Œè‡ªå‹•éš±è—æˆ¿é–“è¨­å®šå€å¡Š
    roomPanel.style.display = 'none';
    toggleRoomPanelBtn.textContent = 'é¡¯ç¤ºæˆ¿é–“è¨­å®š';

    // ç›£è½æ•´å€‹æˆ¿é–“
    roomListeners.push(
      onValue(currentRoomRef, snapshot => {
        const r = snapshot.val();
        if (!r) {
          // æˆ¿é–“è¢«åˆªé™¤
          alert('æˆ¿é–“å·²é—œé–‰');
          leaveRoom();
          return;
        }
        players = r.players || {};
        publicNumbers = r.publicNumbers || {};
        myBoardNumbers = (r.boards && r.boards[myUid]) ? r.boards[myUid] : [];
        roomLocked = !!r.locked;
        roomHostUid = r.hostUid || null;
        currentTurnIndex = (r.state && typeof r.state.turnIndex === 'number')
          ? r.state.turnIndex : 0;

        renderPlayerList();
        renderPublicNumbers();
        renderMyCard();
        updateLockBtnUI();
        updateTurnHint();
        recalcBingoLines();
      })
    );

    // æ—¥èªŒ
    roomListeners.push(
      onValue(ref(db, `rooms/${roomId}/logs`), snapshot => {
        const data = snapshot.val() || {};
        const lines = Object.values(data).map(l => `[${l.time}] ${l.text}`);
        logBox.textContent = lines.join('\n');
        logBox.scrollTop = logBox.scrollHeight;
      })
    );
  }

  // ===== UIï¼šæˆ¿é–“è¨­å®šæ‘ºç–Š =====
  toggleRoomPanelBtn.onclick = () => {
    if (roomPanel.style.display === 'none') {
      roomPanel.style.display = 'block';
      toggleRoomPanelBtn.textContent = 'éš±è—æˆ¿é–“è¨­å®š';
    } else {
      roomPanel.style.display = 'none';
      toggleRoomPanelBtn.textContent = 'é¡¯ç¤ºæˆ¿é–“è¨­å®š';
    }
  };

  // ===== æ¸²æŸ“ï¼šç©å®¶æ’åº =====
  function renderPlayerList() {
    playerListEl.innerHTML = '';
    const entries = Object.entries(players);
    if (entries.length === 0) {
      playerListEl.innerHTML = '<div style="padding:6px;font-size:13px;color:#666;">å°šç„¡ç©å®¶ã€‚</div>';
      return;
    }

    const roomLockedLocal = roomLocked;
    const isHost = (roomHostUid === myUid);

    const arr = entries.map(([uid, p]) => ({ uid, ...p }));
    // æˆ¿ä¸»å„ªå…ˆé¡¯ç¤º
    arr.sort((a, b) => {
      if (a.uid === roomHostUid) return -1;
      if (b.uid === roomHostUid) return 1;
      const ao = a.order ?? 999;
      const bo = b.order ?? 999;
      if (ao !== bo) return ao - bo;
      return a.name.localeCompare(b.name);
    });

    arr.forEach(p => {
      const row = document.createElement('div');
      row.className = 'player-row';

      const main = document.createElement('div');
      main.className = 'player-main';

      const icon = document.createElement('span');
      icon.className = 'player-icon';
      icon.textContent = (p.uid === roomHostUid) ? 'ğŸ‘‘' : 'ğŸ‘¤';

      const name = document.createElement('span');
      name.className = 'player-name';
      name.textContent = p.name || '(æœªå‘½å)';

      const orderSpan = document.createElement('span');
      orderSpan.className = 'player-order';
      if (p.order == null) {
        orderSpan.classList.add('none');
        orderSpan.textContent = 'â€”';
      } else {
        orderSpan.textContent = String(p.order);
      }

      main.appendChild(icon);
      main.appendChild(name);
      main.appendChild(orderSpan);

      const btn = document.createElement('button');
      btn.textContent = (p.order == null) ? 'çµ¦é †ä½' : 'å–æ¶ˆ';
      if (!isHost || roomLockedLocal) {
        row.classList.add('disabled');
      } else {
        // é»æ•´åˆ— or æŒ‰éˆ•éƒ½å¯ä»¥
        const handler = () => togglePlayerOrder(p.uid);
        btn.onclick = handler;
        row.onclick = (evt) => {
          if (evt.target.tagName === 'BUTTON') return; // å·²è™•ç†
          handler();
        };
      }

      row.appendChild(main);
      row.appendChild(btn);
      playerListEl.appendChild(row);
    });
  }

  function togglePlayerOrder(uid) {
    if (!currentRoomId) return;
    if (roomHostUid !== myUid) return;
    if (roomLocked) return;

    const roomRef = currentRoomRef;
    get(roomRef).then(snap => {
      if (!snap.exists()) return;
      const r = snap.val();
      const playersObj = r.players || {};
      if (!playersObj[uid]) return;

      const currOrder = playersObj[uid].order;
      const updates = {};

      if (currOrder == null) {
        // çµ¦æ–°é †ä½ï¼šæœ€å¤§ + 1
        let max = 0;
        for (const p of Object.values(playersObj)) {
          if (typeof p.order === 'number' && p.order > max) max = p.order;
        }
        updates[`players/${uid}/order`] = max + 1;
      } else {
        // å–æ¶ˆé †ä½ï¼Œä¸¦æŠŠå…¶ä»–äººå£“ç·Š
        const ordered = Object.entries(playersObj)
          .filter(([k, p]) => p.order != null && k !== uid)
          .sort((a, b) => a[1].order - b[1].order);
        let n = 1;
        ordered.forEach(([k]) => {
          updates[`players/${k}/order`] = n++;
        });
        updates[`players/${uid}/order`] = null;
      }
      updates['lastActive'] = Date.now();
      update(roomRef, updates);
    });
  }

  // ===== æ¸²æŸ“ï¼šå…¬å…±è™Ÿç¢¼ =====
  function renderPublicNumbers() {
    publicNumbersGrid.innerHTML = '';
    for (let num = 1; num <= 50; num++) {
      const btn = document.createElement('button');
      btn.textContent = num;
      if (publicNumbers[num]) btn.classList.add('selected');

      const canClick = roomLocked && isMyTurn();
      btn.disabled = !canClick;
      if (!canClick) {
        btn.style.cursor = 'not-allowed';
      }

      btn.onclick = () => {
        handleNumberClick(num);
      };

      publicNumbersGrid.appendChild(btn);
    }
  }

  // ===== æ¸²æŸ“ï¼šæˆ‘çš„å¡ç‰‡ =====
  function renderMyCard() {
    myCardGrid.innerHTML = '';
    if (!myBoardNumbers || myBoardNumbers.length !== 25) {
      myCardGrid.innerHTML = '<div style="font-size:13px;color:#666;text-align:center;padding:6px;">å°šæœªæœ‰å¡ç‰‡ï¼Œè«‹ç¨ç­‰æˆ–é‡æ–°æ•´ç†ã€‚</div>';
      return;
    }
    const canClick = roomLocked && isMyTurn();

    for (let i = 0; i < 25; i++) {
      const num = myBoardNumbers[i];
      const btn = document.createElement('button');
      btn.textContent = num;
      if (publicNumbers[num]) btn.classList.add('selected');
      if (!canClick) {
        btn.disabled = true;
        btn.classList.add('disabled');
      }
      btn.onclick = () => {
        handleNumberClick(num);
      };
      myCardGrid.appendChild(btn);
    }
  }

  // ===== é»æ“Šè™Ÿç¢¼ï¼ˆå…¬å…± / æˆ‘çš„å¡ç‰‡å…±ç”¨ï¼‰ =====
  function handleNumberClick(num) {
    if (!currentRoomId) return;
    if (!roomLocked) return;
    if (!isMyTurn()) {
      alert('ç¾åœ¨ä¸æ˜¯ä½ é¸è™Ÿçš„å›åˆå–”ï¼');
      return;
    }

    const roomId = currentRoomId;
    const roomRef = currentRoomRef;

    get(roomRef).then(snap => {
      if (!snap.exists()) return;
      const r = snap.val();
      const nums = r.publicNumbers || {};
      const has = !!nums[num];
      const updates = {};
      if (has) {
        updates[`publicNumbers/${num}`] = null;
        addLog(roomId, `${myNickname}: å–æ¶ˆ ${num}`);
      } else {
        updates[`publicNumbers/${num}`] = true;
        addLog(roomId, `${myNickname}: ${num}`);
      }

      // å›åˆ +1
      runTransaction(ref(db, `rooms/${roomId}/state/turnIndex`), (curr) => {
        if (typeof curr !== 'number') curr = 0;
        const playerArr = getOrderedPlayersFromSnapshot(r);
        if (playerArr.length === 0) return curr;
        return (curr + 1) % playerArr.length;
      });

      updates['lastActive'] = Date.now();
      update(roomRef, updates);
    });
  }

  function getOrderedPlayersFromSnapshot(roomSnapshotVal) {
    const playersObj = roomSnapshotVal.players || {};
    return Object.entries(playersObj)
      .filter(([uid, p]) => p.order != null)
      .map(([uid, p]) => ({ uid, name: p.name, order: p.order }))
      .sort((a, b) => a.order - b.order);
  }

  // ===== é–å®šæŒ‰éˆ• & å›åˆæç¤º =====
  function updateLockBtnUI() {
    if (!currentRoomId) {
      lockBtn.textContent = 'é–å®šä¸¦é–‹å§‹æœ¬å±€';
      lockBtn.classList.remove('locked');
      lockBtn.disabled = true;
      refreshCardBtn.disabled = true;
      return;
    }
    const isHost = (roomHostUid === myUid);
    lockBtn.disabled = !isHost;
    refreshCardBtn.disabled = roomLocked; // é–å®šå¾Œä¸èƒ½é‡æŠ½å¡ç‰‡

    if (roomLocked) {
      lockBtn.textContent = 'å–æ¶ˆé–å®š / çµæŸæœ¬å±€';
      lockBtn.classList.add('locked');
    } else {
      lockBtn.textContent = 'é–å®šä¸¦é–‹å§‹æœ¬å±€';
      lockBtn.classList.remove('locked');
    }
  }

  lockBtn.onclick = () => {
    if (!currentRoomId) return;
    if (roomHostUid !== myUid) {
      alert('åªæœ‰æˆ¿ä¸»å¯ä»¥é–å®š / å–æ¶ˆé–å®šã€‚');
      return;
    }

    if (!roomLocked) {
      // æº–å‚™é–å®šï¼šæª¢æŸ¥æ˜¯å¦æ‰€æœ‰ç©å®¶éƒ½å·²æ’é †ä½
      const arr = Object.values(players || {});
      if (arr.length === 0) {
        alert('æˆ¿é–“å…§æ²’æœ‰ç©å®¶ã€‚');
        return;
      }
      const someNoOrder = arr.some(p => p.order == null);
      if (someNoOrder) {
        alert('è«‹å…ˆè¨­å®šå·¦å´æ‰€æœ‰ç©å®¶çš„é †ä½æ’åºï¼ˆä¸èƒ½æœ‰äººæ˜¯ã€Œâ€”ã€ï¼‰ã€‚');
        return;
      }

      const updates = {
        locked: true,
        lastActive: Date.now(),
        'state/turnIndex': 0
      };
      update(currentRoomRef, updates).then(() => {
        addLog(currentRoomId, 'æˆ¿ä¸»é–å®šä¸¦é–‹å§‹æœ¬å±€');
      });
    } else {
      // å–æ¶ˆé–å®šï¼šæ¸…ç©ºå…¬å…±è™Ÿç¢¼
      if (!confirm('ç¢ºå®šè¦å–æ¶ˆé–å®šä¸¦çµæŸæœ¬å±€ï¼Ÿé€™æœƒæ¸…é™¤æ‰€æœ‰å…¬å…±è™Ÿç¢¼ã€‚')) {
        return;
      }
      const updates = {
        locked: false,
        publicNumbers: null,
        lastActive: Date.now(),
        'state/turnIndex': 0
      };
      update(currentRoomRef, updates).then(() => {
        addLog(currentRoomId, 'æˆ¿ä¸»å–æ¶ˆé–å®šä¸¦æ¸…é™¤æœ¬å±€å…¬å…±è™Ÿç¢¼');
      });
    }
  };

  function updateTurnHint() {
    if (!currentRoomId) {
      turnHint.textContent = 'å°šæœªé€²å…¥æˆ¿é–“ã€‚';
      return;
    }
    if (!roomLocked) {
      turnHint.textContent = 'å°šæœªé–å®šï¼Œè«‹æˆ¿ä¸»å…ˆè¨­å®šå·¦å´é †ä½ä¸¦é–å®šé–‹å§‹ã€‚';
      return;
    }
    const ordered = getOrderedPlayers();
    if (ordered.length === 0) {
      turnHint.textContent = 'å°šæœªè¨­å®šé †ä½ï¼Œè«‹æˆ¿ä¸»å…ˆè¨­å®šã€‚';
      return;
    }
    const idx = currentTurnIndex % ordered.length;
    const cur = ordered[idx];
    turnHint.innerHTML = `è¼ªåˆ°ï¼š<span>${cur.name || 'ç©å®¶'}</span> é¸è™Ÿ`;
  }

  // ===== é‡æ–°æŠ½å¡ç‰‡ =====
  refreshCardBtn.onclick = () => {
    if (!currentRoomId) return;
    if (roomLocked) return;
    const board = generateBoardNumbers();
    const updates = {};
    updates[`boards/${myUid}`] = board;
    updates['lastActive'] = Date.now();
    update(currentRoomRef, updates).then(() => {
      addLog(currentRoomId, `${myNickname} é‡æ–°æŠ½å¡ç‰‡`);
    });
  };

  // ===== ç‚«è€€ =====
  bragBtn.onclick = () => {
    if (!currentRoomId) return;
    if (myBingoLines <= 0) return;
    if (bragLocked) return;

    if (bragClicksForCurrentLines < 3) {
      bragClicksForCurrentLines++;
      addLog(currentRoomId, `${myNickname}: ç‚«è€€ï¼ç›®å‰ BINGO ${myBingoLines} æ¢ï½`);
      if (bragClicksForCurrentLines >= 3) {
        // ç¬¬ 3 æ¬¡ä¹‹å¾Œï¼Œä¸‹ä¸€æ¬¡æ‰æœƒé–
      }
    } else {
      // ç¬¬ 4 æ¬¡ï¼ˆæˆ–ä»¥ä¸Šï¼‰æ‰çœŸæ­£é–å®šï¼†æç¤º
      bragLocked = true;
      updateBragButtonState();
      alert('ä½èª¿!ä½èª¿!');
    }
    updateBragButtonState();
  };

  // ===== åˆå§‹åŒ–å…¬å…±è™Ÿç¢¼æ ¼ =====
  // ï¼ˆå¦‚æœå…ˆé€²æˆ¿å‰ DOM æœƒè¢«ä¹‹å¾Œè³‡æ–™è¦†è“‹ï¼Œä¸å½±éŸ¿ï¼‰
  for (let i = 1; i <= 50; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.disabled = true;
    btn.style.cursor = 'not-allowed';
    publicNumbersGrid.appendChild(btn);
  }

</script>
</body>
</html>
