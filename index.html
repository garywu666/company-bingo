<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å…¬å¸ Bingo å¤§å»³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }
    button {
      cursor: pointer;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 14px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    input {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .page-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 10px 30px;
    }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .top-bar-title {
      font-weight: 700;
      font-size: 20px;
    }
    .nickname-badge {
      font-size: 14px;
    }

    /* å¤§å»³å€å¡Š ------------------------------------------------- */
    .lobby-card {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 0 4px rgba(0,0,0,0.08);
      padding: 10px;
      margin-bottom: 12px;
    }
    .lobby-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }
    .lobby-row label {
      font-size: 13px;
      white-space: nowrap;
    }
    .lobby-room-list {
      margin-top: 8px;
      border-top: 1px solid #eee;
      padding-top: 8px;
      max-height: 180px;
      overflow-y: auto;
      font-size: 13px;
    }
    .lobby-room-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px dashed #eee;
    }
    .room-name {
      font-weight: 600;
      margin-right: 8px;
    }
    .room-meta {
      font-size: 12px;
      color: #555;
    }

    .btn-primary {
      background: #007bff;
      color: #fff;
    }
    .btn-secondary {
      background: #6c757d;
      color: #fff;
    }
    .btn-danger {
      background: #e74c3c;
      color: #fff;
    }
    .btn-outline {
      background: #fff;
      color: #007bff;
      border: 1px solid #007bff;
    }

    /* é®ç½©ï¼šæš±ç¨±è¼¸å…¥ ----------------------------------------- */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .overlay-card {
      background: #fff;
      border-radius: 8px;
      padding: 20px 22px 16px;
      width: 320px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .overlay-card h2 {
      margin: 0 0 10px;
      font-size: 18px;
    }
    .overlay-card p {
      margin: 0 0 10px;
      font-size: 14px;
      color: #555;
    }
    .overlay-actions {
      margin-top: 10px;
      text-align: right;
    }

    /* æˆ¿é–“å…§ä¸»ç‰ˆé¢ ------------------------------------------- */
    #room-area {
      display: none;
    }
    .room-grid {
      display: grid;
      grid-template-columns: 260px 1fr 320px;
      gap: 10px;
      align-items: flex-start;
    }
    .panel {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 0 4px rgba(0,0,0,0.08);
      padding: 8px 10px 10px;
    }
    .panel-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* ç©å®¶æ’åº / æ§åˆ¶ ------------------------------------------ */
    #lockButton {
      width: 100%;
      margin-bottom: 6px;
      padding: 8px 10px;
      font-size: 14px;
    }
    #lockButton.locked {
      background: #e74c3c;
      color: #fff;
    }
    #player-order-panel {
      margin-bottom: 6px;
    }
    #player-list {
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 4px;
      min-height: 120px;
      font-size: 13px;
    }
    .player-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px 4px;
      border-bottom: 1px dashed #f0f0f0;
    }
    .player-row:last-child {
      border-bottom: none;
    }
    .player-main {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .player-icon {
      font-size: 14px;
    }
    .player-name {
      max-width: 110px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .player-order-tag {
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 10px;
      background: #eee;
      margin-left: 4px;
    }
    #refreshCardBtn {
      width: 100%;
      margin-top: 6px;
      padding: 8px 10px;
      font-size: 14px;
    }

    /* å…¬å…±è™Ÿç¢¼ ï¼† æˆ‘çš„å¡ç‰‡ -------------------------------------- */
    #turnHint {
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #333;
    }
    #public-board {
      margin-bottom: 8px;
    }
    .number-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      font-size: 13px;
    }
    .num-btn {
      padding: 6px 0;
      border-radius: 4px;
      background: #f1f1f1;
      text-align: center;
      user-select: none;
    }
    .num-btn.active {
      background: #4169e1;
      color: #fff;
    }
    .num-btn.disabled {
      cursor: not-allowed;
      background: #ddd;
      color: #888;
    }

    #bingoHintRow {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 14px;
    }
    #bingoHint {
      font-weight: 700;
      color: #28a745;
    }
    #showoffBtn:disabled {
      cursor: not-allowed;
    }

    #my-card-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
    }
    .card-cell {
      padding: 14px 0;
      text-align: center;
      border-radius: 4px;
      background: #f1f1f1;
      user-select: none;
    }
    .card-cell.marked {
      background: #ff9800;
      color: #fff;
    }
    .card-cell.disabled {
      cursor: not-allowed;
      background: #ddd;
      color: #888;
    }

    /* å³é‚Šï¼šæˆ¿é–“ / æ—¥èªŒ ---------------------------------------- */
    #room-info-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #roomInfoTop {
      font-size: 13px;
      margin-bottom: 4px;
    }
    #logWrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #logTitle {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    #logBoxOuter {
      border-radius: 4px;
      background: #000;
      padding: 4px;
      /* ç™½æ¡†é«˜åº¦èˆ‡æˆ‘çš„å¡ç‰‡åº•å°é½Šï¼šæ•…å¯«æ­»é«˜åº¦ï¼Œå¤§è‡´å°é½Š */
      height: 360px;
      overflow: hidden;
    }
    #logBox {
      font-family: Consolas, Menlo, monospace;
      font-size: 12px;
      color: #0f0;
      max-height: 352px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .muted {
      color: #777;
      font-size: 12px;
    }

    /* ä¸å¯é»ç‹€æ…‹ï¼Œæ»‘é¼ é¡¯ç¤ºç¦æ­¢ --------------------------------- */
    .no-pointer {
      pointer-events: none;
      cursor: not-allowed !important;
    }
  </style>
</head>
<body>
<div class="page-wrapper">
  <div class="top-bar">
    <div class="top-bar-title">å…¬å¸ Bingo å¤§å»³</div>
    <div class="nickname-badge" id="topNickname"></div>
  </div>

  <!-- å¤§å»³ï¼šå»ºç«‹ / åŠ å…¥æˆ¿é–“ -->
  <div id="lobby-area" class="lobby-card">
    <div class="lobby-row">
      <label>æˆ¿é–“åç¨±ï¼š</label>
      <input id="createRoomName" placeholder="ä¾‹å¦‚ï¼šA01 æˆ– è‡ªè¨‚å„ç¨±" style="flex:1;min-width:120px;" />
      <label>æˆ¿é–“å¯†ç¢¼ï¼š</label>
      <input id="createRoomPassword" placeholder="å¯ç•™ç©º" style="width:120px;" />
      <button id="createRoomBtn" class="btn-primary">å»ºç«‹æˆ¿é–“</button>
    </div>
    <div class="lobby-row">
      <label>å·²æœ‰æˆ¿è™Ÿï¼š</label>
      <input id="joinRoomId" placeholder="è¼¸å…¥æˆ¿è™Ÿ" style="width:120px;" />
      <label>æˆ¿é–“å¯†ç¢¼ï¼š</label>
      <input id="joinRoomPassword" placeholder="å¦‚æœ‰è¨­å®š" style="width:120px;" />
      <button id="joinRoomBtn" class="btn-secondary">åŠ å…¥æˆ¿é–“</button>
      <span class="muted">â†’ ä¹Ÿå¯ä»¥ç›´æ¥é»ä¸‹é¢åˆ—è¡¨çš„åŠ å…¥æŒ‰éˆ•</span>
    </div>
    <div class="lobby-room-list" id="roomList"></div>
  </div>

  <!-- æˆ¿é–“å…§ç•«é¢ -------------------------------------------------->
  <div id="room-area">
    <div class="room-grid">
      <!-- å·¦é‚Šï¼šé–å®š + ç©å®¶æ’åº + åˆ·æ–°å¡ç‰‡ -->
      <div>
        <button id="lockButton" class="btn-primary">é–å®šä¸¦é–‹å§‹æœ¬å±€</button>

        <div id="player-order-panel" class="panel">
          <div class="panel-title">
            <span>ç©å®¶æ’åºï¼ˆæˆ¿ä¸»è«‹å¾ä¸Šåˆ°ä¸‹æ’åˆ—ï¼‰</span>
            <button id="clearOrderBtn" class="btn-outline" style="font-size:12px;padding:2px 6px;">æ¸…é™¤æ’åº</button>
          </div>
          <div id="player-list"></div>
        </div>

        <button id="refreshCardBtn" class="btn-secondary">åˆ·æ–°æˆ‘çš„å¡ç‰‡</button>
      </div>

      <!-- ä¸­é–“ï¼šå…¬å…±è™Ÿç¢¼ + è‡ªå·±å¡ç‰‡ -->
      <div class="panel">
        <div id="turnHint">å°šæœªé–å®šï¼Œè«‹å…ˆç”±æˆ¿ä¸»è¨­å®šå·¦å´é †ä½ä¸¦é–å®šé–‹å§‹ã€‚</div>

        <div id="public-board">
          <div class="panel-title" style="justify-content:center;margin-bottom:4px;">å…¬å…±è™Ÿç¢¼ï¼ˆ1â€“50ï¼‰</div>
          <div id="publicNumberGrid" class="number-grid"></div>
        </div>

        <div>
          <div id="bingoHintRow">
            <span>ç›®å‰ BINGO ï¼š</span>
            <span id="bingoHint">0 æ¢</span>
            <button id="showoffBtn" class="btn-outline" disabled>ç‚«è€€</button>
          </div>
          <div id="my-card-grid"></div>
        </div>
      </div>

      <!-- å³é‚Šï¼šæˆ¿è™Ÿ / æš±ç¨± / æ—¥èªŒ -->
      <div id="room-info-panel" class="panel">
        <div id="roomInfoTop"></div>
        <div id="logWrapper">
          <div id="logTitle">æ—¥èªŒ</div>
          <div id="logBoxOuter">
            <div id="logBox"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- æš±ç¨±è¼¸å…¥é®ç½© -------------------------------------------------->
<div id="nickname-overlay" class="overlay" style="display:none;">
  <div class="overlay-card">
    <h2>å…ˆå–å€‹æš±ç¨±å§</h2>
    <p>é€™å€‹æš±ç¨±æœƒç”¨åœ¨æ‰€æœ‰æˆ¿é–“ä¸­ï¼Œä¹‹å¾Œå¯ä»¥å†æ”¹ã€‚</p>
    <input id="nicknameInput" placeholder="ä¾‹å¦‚ï¼šèŠ±èŠ±ã€è³¢ã€GARYâ€¦" style="width:100%;margin-bottom:8px;" />
    <div class="overlay-actions">
      <button id="saveNicknameBtn" class="btn-primary">ç¢ºå®š</button>
    </div>
  </div>
</div>

<script type="module">
  // ---------------------------------------------------------------------------
  // Firebase åˆå§‹åŒ–ï¼ˆä½¿ç”¨ä½ çµ¦çš„è¨­å®šï¼‰
  // ---------------------------------------------------------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase,
    ref,
    child,
    get,
    set,
    update,
    onValue,
    push,
    serverTimestamp,
    onDisconnect,
    remove
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB4IBPbuGxztyzd8E3YTitMoTt8L19MSG0",
    authDomain: "company-bingo.firebaseapp.com",
    databaseURL: "https://company-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "company-bingo",
    storageBucket: "company-bingo.firebasestorage.app",
    messagingSenderId: "844173689886",
    appId: "1:844173689886:web:ac2f1888f542b138861a0f",
    measurementId: "G-WGDVJPKMEH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------------------------------------------------------------------------
  // å·¥å…·
  // ---------------------------------------------------------------------------
  const $ = (id) => document.getElementById(id);

  function randomId() {
    if (crypto.randomUUID) return crypto.randomUUID();
    return "id-" + Math.random().toString(36).slice(2);
  }

  function randomCard() {
    const nums = [];
    while (nums.length < 25) {
      const n = Math.floor(Math.random() * 50) + 1;
      if (!nums.includes(n)) nums.push(n);
    }
    return nums;
  }

  function computeBingo(cardNums, marks) {
    if (!cardNums || cardNums.length !== 25) return 0;
    const markSet = new Set(Object.keys(marks || {}).filter((k) => marks[k]));
    let lines = 0;
    const idx = (r, c) => r * 5 + c;

    // rows
    for (let r = 0; r < 5; r++) {
      let ok = true;
      for (let c = 0; c < 5; c++) {
        const n = cardNums[idx(r, c)];
        if (!markSet.has(String(n))) { ok = false; break; }
      }
      if (ok) lines++;
    }
    // cols
    for (let c = 0; c < 5; c++) {
      let ok = true;
      for (let r = 0; r < 5; r++) {
        const n = cardNums[idx(r, c)];
        if (!markSet.has(String(n))) { ok = false; break; }
      }
      if (ok) lines++;
    }
    // diag 1
    let ok = true;
    for (let i = 0; i < 5; i++) {
      const n = cardNums[idx(i, i)];
      if (!markSet.has(String(n))) { ok = false; break; }
    }
    if (ok) lines++;
    // diag 2
    ok = true;
    for (let i = 0; i < 5; i++) {
      const n = cardNums[idx(i, 4 - i)];
      if (!markSet.has(String(n))) { ok = false; break; }
    }
    if (ok) lines++;

    return lines;
  }

  function formatTime(ts) {
    const d = new Date(ts || Date.now());
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    const ss = String(d.getSeconds()).padStart(2, "0");
    return `[${hh}:${mm}:${ss}]`;
  }

  // ---------------------------------------------------------------------------
  // ç‹€æ…‹
  // ---------------------------------------------------------------------------
  let clientId = localStorage.getItem("bingoClientId") || randomId();
  localStorage.setItem("bingoClientId", clientId);

  let nickname = localStorage.getItem("bingoNickname") || "";
  let currentRoomId = null;
  let isHost = false;
  let myCard = [];
  let myMarks = {};
  let myShowoffCount = 0;

  // ç”¨ä¾†å–æ¶ˆ Firebase listenerï¼ˆç°¡å–®åšä¸€å€‹è¨˜éŒ„ï¼‰
  let roomUnsubscribers = [];

  // ---------------------------------------------------------------------------
  // æš±ç¨±æµç¨‹
  // ---------------------------------------------------------------------------
  const overlay = $("nickname-overlay");
  const nicknameInput = $("nicknameInput");
  const topNickname = $("topNickname");

  function ensureNickname() {
    if (!nickname) {
      overlay.style.display = "flex";
      nicknameInput.value = "";
      nicknameInput.focus();
    } else {
      topNickname.textContent = `ç›®å‰æš±ç¨±ï¼š${nickname}`;
    }
  }

  $("saveNicknameBtn").addEventListener("click", () => {
    const v = nicknameInput.value.trim();
    if (!v) {
      alert("æš±ç¨±ä¸èƒ½æ˜¯ç©ºçš„ã€‚");
      return;
    }
    nickname = v;
    localStorage.setItem("bingoNickname", nickname);
    overlay.style.display = "none";
    topNickname.textContent = `ç›®å‰æš±ç¨±ï¼š${nickname}`;
  });

  ensureNickname();

  // ---------------------------------------------------------------------------
  // å¤§å»³ï¼šæˆ¿é–“åˆ—è¡¨
  // ---------------------------------------------------------------------------
  const roomListEl = $("roomList");

  function renderRoomList(snapshotVal) {
    roomListEl.innerHTML = "";
    const rooms = snapshotVal || {};
    const ids = Object.keys(rooms);
    if (!ids.length) {
      roomListEl.innerHTML = `<div class="muted">ç›®å‰æ²’æœ‰æˆ¿é–“ï¼Œå¿«å»ºç«‹ä¸€å€‹å§ï¼</div>`;
      return;
    }
    ids.sort((a,b) => (rooms[b].createdAt || 0) - (rooms[a].createdAt || 0));
    ids.forEach((id) => {
      const room = rooms[id];
      const div = document.createElement("div");
      div.className = "lobby-room-item";
      const hasPwd = !!room.password;
      const playerCount = room.players ? Object.keys(room.players).length : 0;

      const left = document.createElement("div");
      left.innerHTML =
        `<span class="room-name">${room.name || "(æœªå‘½å)"}</span>` +
        `<span class="room-meta">æˆ¿è™Ÿï¼š${id}ã€€ç©å®¶ï¼š${playerCount}äºº` +
        (hasPwd ? "ã€€ğŸ”’" : "") +
        `</span>`;
      const btn = document.createElement("button");
      btn.className = "btn-secondary";
      btn.textContent = "åŠ å…¥";
      btn.addEventListener("click", () => {
        let pwd = "";
        if (hasPwd) {
          pwd = prompt("æ­¤æˆ¿é–“æœ‰è¨­å®šå¯†ç¢¼ï¼Œè«‹è¼¸å…¥å¯†ç¢¼ï¼š") || "";
        }
        joinRoom(id, pwd);
      });

      div.appendChild(left);
      div.appendChild(btn);
      roomListEl.appendChild(div);
    });
  }

  onValue(ref(db, "rooms"), (snap) => {
    renderRoomList(snap.val());
  });

  // ---------------------------------------------------------------------------
  // å»ºç«‹ / åŠ å…¥æˆ¿é–“
  // ---------------------------------------------------------------------------
  $("createRoomBtn").addEventListener("click", async () => {
    ensureNickname();
    if (!nickname) return;

    const name = $("createRoomName").value.trim() || "æœªå‘½åæˆ¿é–“";
    const pwd = $("createRoomPassword").value.trim();

    const roomRef = push(ref(db, "rooms"));
    const roomId = roomRef.key;

    const now = Date.now();
    await set(roomRef, {
      name,
      password: pwd || "",
      createdAt: now,
      locked: false,
      hostId: clientId,
      turnOrder: {},
      currentTurnIndex: 0,
      publicNumbers: {},
      lastActive: now
    });

    await joinRoom(roomId, pwd);
  });

  $("joinRoomBtn").addEventListener("click", async () => {
    ensureNickname();
    if (!nickname) return;

    const id = $("joinRoomId").value.trim();
    const pwd = $("joinRoomPassword").value.trim();
    if (!id) {
      alert("è«‹å…ˆè¼¸å…¥æˆ¿è™Ÿ");
      return;
    }
    await joinRoom(id, pwd);
  });

  async function joinRoom(roomId, passwordAttempt) {
    ensureNickname();
    if (!nickname) return;

    const snap = await get(ref(db, "rooms/" + roomId));
    if (!snap.exists()) {
      alert("æ‰¾ä¸åˆ°é€™å€‹æˆ¿è™Ÿã€‚");
      return;
    }
    const room = snap.val();
    if (room.password && room.password !== passwordAttempt) {
      alert("å¯†ç¢¼éŒ¯èª¤ã€‚");
      return;
    }

    // å…ˆé›¢é–‹èˆŠæˆ¿é–“
    await leaveRoom(true);

    currentRoomId = roomId;
    isHost = room.hostId === clientId;

    // ç©å®¶ç¯€é»ï¼šè‹¥å·²å­˜åœ¨å°±æ›´æ–°æš±ç¨±ï¼Œä¸é‡ç”Ÿå¡ç‰‡ / æ¨™è¨˜
    const playerRef = ref(db, `rooms/${roomId}/players/${clientId}`);
    const playerSnap = await get(playerRef);

    let card = playerSnap.exists() && playerSnap.val().card
      ? playerSnap.val().card
      : randomCard();

    myCard = card;
    myMarks = (playerSnap.exists() && playerSnap.val().marks) || {};
    myShowoffCount = 0;

    await update(playerRef, {
      nickname,
      card,
      marks: myMarks,
      joinedAt: Date.now()
    });

    // onDisconnectï¼šå¦‚æœå®Œå…¨é›¢ç·šå°±ç§»é™¤æ­¤ç©å®¶
    onDisconnect(playerRef).remove();

    // UI åˆ‡æ›
    $("lobby-area").style.display = "none";
    $("room-area").style.display = "block";

    // é¡¯ç¤ºæˆ¿è™Ÿ / æš±ç¨±åœ¨å³å´ç™½æ¡†è£¡
    $("roomInfoTop").innerHTML =
      `<div>æˆ¿è™Ÿï¼š<strong>${roomId}</strong></div>` +
      `<div>æš±ç¨±ï¼š<strong>${nickname}</strong></div>`;

    // ç”Ÿæˆæ ¼å­ UI
    buildBoards();
    bindRoomListeners(roomId);
    logToRoom(roomId, `${nickname} åŠ å…¥æˆ¿é–“`);
  }

  async function leaveRoom(silent=false) {
    if (!currentRoomId) return;
    const roomId = currentRoomId;

    // ç§»é™¤ listener
    roomUnsubscribers.forEach(fn => fn && fn());
    roomUnsubscribers = [];

    // å¾æˆ¿é–“ç§»é™¤ç©å®¶ç¯€é»ï¼ˆæ­¤è™•é¡¯å¼ç§»é™¤ï¼ŒonDisconnect åªæ˜¯é˜²æ„å¤–ï¼‰
    const playerRef = ref(db, `rooms/${roomId}/players/${clientId}`);
    await remove(playerRef).catch(()=>{});

    if (!silent) {
      logToRoom(roomId, `${nickname} é›¢é–‹æˆ¿é–“`);
    }

    currentRoomId = null;
    isHost = false;
    myCard = [];
    myMarks = {};
    myShowoffCount = 0;

    $("room-area").style.display = "none";
    $("lobby-area").style.display = "block";
  }

  window.addEventListener("beforeunload", () => {
    // ç›¡é‡é€šå‘Šé›¢é–‹ï¼ˆå¯¦å‹™ä¸Š onDisconnect ä¹Ÿæœƒè™•ç†ï¼‰
    leaveRoom(true);
  });

  // ---------------------------------------------------------------------------
  // æˆ¿é–“å…§ï¼šlistener & UI
  // ---------------------------------------------------------------------------
  function bindRoomListeners(roomId) {
    // æˆ¿é–“æœ¬é«”
    const roomRef = ref(db, "rooms/" + roomId);
    const unsubRoom = onValue(roomRef, (snap) => {
      if (!snap.exists()) return;
      const room = snap.val();
      isHost = room.hostId === clientId;

      // é–å®šæŒ‰éˆ•ç‹€æ…‹
      const locked = !!room.locked;
      updateLockButton(locked);

      // è¼ªåˆ°èª°
      const players = room.players || {};
      const orderObj = room.turnOrder || {};
      const orderList = Object.entries(orderObj)
        .sort((a,b)=>a[1]-b[1])
        .map(([pid]) => pid)
        .filter(pid => players[pid]);

      const currentIdx = room.currentTurnIndex || 0;
      const currentPid = orderList.length ? orderList[currentIdx % orderList.length] : null;
      const currentName = currentPid && players[currentPid] ? players[currentPid].nickname : null;

      if (!locked) {
        $("turnHint").textContent = "å°šæœªé–å®šï¼Œè«‹å…ˆç”±æˆ¿ä¸»è¨­å®šå·¦å´é †ä½ä¸¦é–å®šé–‹å§‹ã€‚";
      } else if (currentName) {
        $("turnHint").textContent = `ç›®å‰è¼ªåˆ°ï¼š${currentName} é¸è™Ÿï¼ˆåƒ…ä½œæç¤ºï¼Œæ‰€æœ‰ç©å®¶ä»å¯é»æ“Šï¼‰`;
      } else {
        $("turnHint").textContent = "ç›®å‰å°šæœªè¨­å®šé †ä½ï¼Œè«‹ç”±æˆ¿ä¸»è¨­å®šå·¦å´æ’åºã€‚";
      }

      // å…¬å…±è™Ÿç¢¼
      const publicNumbers = room.publicNumbers || {};
      renderPublicNumbers(publicNumbers, locked);

      // ç©å®¶åˆ—è¡¨ / æ’åºæ¨™ç±¤
      renderPlayerList(players, orderObj, room.hostId);

      // è‹¥æˆ¿ä¸»é›¢é–‹ â†’ è‡ªå‹•è½‰ç§»æ–°çš„ hostï¼ˆä¾ joinedAt æœ€æ—©çš„äººï¼‰
      if (!players[room.hostId]) {
        const entries = Object.entries(players);
        if (entries.length) {
          entries.sort((a,b) => (a[1].joinedAt||0) - (b[1].joinedAt||0));
          const newHostId = entries[0][0];
          if (clientId === newHostId) {
            update(roomRef, { hostId: newHostId });
            logToRoom(roomId, `${nickname} æˆç‚ºæ–°çš„æˆ¿ä¸»`);
          }
        }
      }
    });
    roomUnsubscribers.push(unsubRoom);

    // æ—¥èªŒ
    const logRef = ref(db, `rooms/${roomId}/logs`);
    const unsubLog = onValue(logRef, (snap) => {
      const logs = snap.val() || {};
      const keys = Object.keys(logs).sort((a,b)=> (logs[a].ts||0)-(logs[b].ts||0));
      const lines = keys.map(k => {
        const item = logs[k];
        return `${formatTime(item.ts)} ${item.msg}`;
      });
      $("logBox").textContent = lines.join("\n");
      const box = $("logBox");
      box.scrollTop = box.scrollHeight;
    });
    roomUnsubscribers.push(unsubLog);

    // æˆ‘çš„ç©å®¶ç¯€é»ï¼ˆæ›´æ–° card/marks æ™‚ç”¨ï¼‰
    const myPlayerRef = ref(db, `rooms/${roomId}/players/${clientId}`);
    const unsubMe = onValue(myPlayerRef, (snap) => {
      if (!snap.exists()) return;
      const me = snap.val();
      myCard = me.card || myCard;
      myMarks = me.marks || myMarks;
      renderMyCard();
      updateBingoCount();
    });
    roomUnsubscribers.push(unsubMe);
  }

  function buildBoards() {
    // å…¬å…±è™Ÿç¢¼
    const publicGrid = $("publicNumberGrid");
    publicGrid.innerHTML = "";
    for (let i = 1; i <= 50; i++) {
      const div = document.createElement("div");
      div.className = "num-btn";
      div.textContent = i;
      div.dataset.num = i;
      publicGrid.appendChild(div);
    }

    // æˆ‘çš„å¡ç‰‡
    renderMyCard();
    attachBoardHandlers();
  }

  function attachBoardHandlers() {
    // å…¬å…±è™Ÿç¢¼ï¼šé»æ“Š â†’ toggle å…¬å…±è™Ÿç¢¼ + å¯èƒ½æ¨™è¨˜è‡ªå·±çš„å¡ç‰‡
    $("publicNumberGrid").addEventListener("click", async (e) => {
      const cell = e.target.closest(".num-btn");
      if (!cell || !currentRoomId) return;
      if (cell.classList.contains("disabled")) return;

      const num = cell.dataset.num;
      const roomRef = ref(db, `rooms/${currentRoomId}`);
      const roomSnap = await get(roomRef);
      if (!roomSnap.exists()) return;
      const room = roomSnap.val();

      // è‹¥å°šæœªé–å®šï¼Œç¦æ­¢é»æ“Š
      if (!room.locked) return;

      const publicNumbers = room.publicNumbers || {};
      const prev = !!publicNumbers[num];
      publicNumbers[num] = !prev;

      await update(roomRef, {
        publicNumbers,
        lastActive: Date.now(),
        currentTurnIndex: computeNextTurnIndex(room)
      });

      // logï¼šXXX: num / XXX: å–æ¶ˆ num
      logToRoom(currentRoomId, `${nickname}ï¼š${prev ? "å–æ¶ˆ " : ""}${num}`);

      // åŒæ­¥æ›´æ–°è‡ªå·±å¡ç‰‡ä¸Šè©²æ•¸å­—ï¼ˆå¦‚æœ‰ï¼‰
      await toggleMyMark(num, !prev, false);
    });

    // è‡ªå·±å¡ç‰‡ï¼šé»æ“Š â†’ ç­‰åŒæ“ä½œå…¬å…±è™Ÿç¢¼
    $("my-card-grid").addEventListener("click", async (e) => {
      const cell = e.target.closest(".card-cell");
      if (!cell || !currentRoomId) return;
      if (cell.classList.contains("disabled")) return;

      const num = cell.dataset.num;
      const roomRef = ref(db, `rooms/${currentRoomId}`);
      const roomSnap = await get(roomRef);
      if (!roomSnap.exists()) return;
      const room = roomSnap.val();
      if (!room.locked) return;

      const publicNumbers = room.publicNumbers || {};
      const prev = !!publicNumbers[num];
      publicNumbers[num] = !prev;

      await update(roomRef, {
        publicNumbers,
        lastActive: Date.now(),
        currentTurnIndex: computeNextTurnIndex(room)
      });

      logToRoom(currentRoomId, `${nickname}ï¼š${prev ? "å–æ¶ˆ " : ""}${num}`);
      await toggleMyMark(num, !prev, false);
    });
  }

  // ä¸å†åšã€Œè¼ªåˆ°èª°æ‰èƒ½é¸ã€ï¼Œåªåœ¨æ­¤è¨ˆç®—è¼ªåˆ°çš„ indexï¼ˆç´”æç¤ºç”¨ï¼‰
  function computeNextTurnIndex(room) {
    const obj = room.turnOrder || {};
    const players = room.players || {};
    const orderList = Object.entries(obj)
      .sort((a,b)=>a[1]-b[1])
      .map(([pid]) => pid)
      .filter(pid => players[pid]);

    if (!orderList.length) return 0;
    const cur = room.currentTurnIndex || 0;
    return (cur + 1) % orderList.length;
  }

  async function toggleMyMark(num, shouldMark, logSelf=true) {
    if (!currentRoomId) return;
    const myRef = ref(db, `rooms/${currentRoomId}/players/${clientId}/marks`);
    const marksSnap = await get(myRef);
    const marks = marksSnap.exists() ? marksSnap.val() : {};

    if (shouldMark) {
      marks[num] = true;
    } else {
      delete marks[num];
    }
    await set(myRef, marks);
  }

  function renderPublicNumbers(publicNumbers, locked) {
    const grid = $("publicNumberGrid");
    Array.from(grid.children).forEach((cell) => {
      const n = cell.dataset.num;
      const active = !!publicNumbers[n];
      cell.classList.toggle("active", active);
      // é–å®šå‰ä¸å¯é»
      if (!locked) {
        cell.classList.add("disabled", "no-pointer");
      } else {
        cell.classList.remove("disabled", "no-pointer");
      }
    });
    // æˆ‘çš„å¡ç‰‡ç‹€æ…‹ä¹Ÿä¸€ä½µæ›´æ–° disabled ç‹€æ…‹
    const cardGrid = $("my-card-grid");
    Array.from(cardGrid.children).forEach((cell) => {
      if (!locked) {
        cell.classList.add("disabled", "no-pointer");
      } else {
        cell.classList.remove("disabled", "no-pointer");
      }
    });
  }

  function renderMyCard() {
    const grid = $("my-card-grid");
    grid.innerHTML = "";
    if (!myCard || !myCard.length) {
      grid.innerHTML = `<div class="muted" style="grid-column:1/6;text-align:center;">å°šæœªç”¢ç”Ÿå¡ç‰‡</div>`;
      return;
    }
    myCard.forEach((num) => {
      const div = document.createElement("div");
      div.className = "card-cell";
      div.dataset.num = num;
      div.textContent = num;
      if (myMarks && myMarks[num]) {
        div.classList.add("marked");
      }
      grid.appendChild(div);
    });
    updateBingoCount();
  }

  function updateBingoCount() {
    const count = computeBingo(myCard, myMarks);
    $("bingoHint").textContent = `${count} æ¢`;
    // ç‚«è€€æŒ‰éˆ•ï¼šè‡³å°‘ 1 æ¢æ‰å¯æŒ‰
    $("showoffBtn").disabled = count <= 0;
  }

  // ç©å®¶åˆ—è¡¨ï¼ˆå«æ’åºï¼‰
  function renderPlayerList(players, orderObj, hostId) {
    const listEl = $("player-list");
    listEl.innerHTML = "";
    const entries = Object.entries(players || {});

    if (!entries.length) {
      listEl.innerHTML = `<div class="muted">ç›®å‰æ²’æœ‰ç©å®¶ã€‚</div>`;
      return;
    }

    // ä¾ç…§æ’åºï¼ˆorderObjï¼‰ï¼Œæœªæ’åºè€…æ’åœ¨å¾Œé¢
    const ordered = entries.slice().sort((a,b) => {
      const oa = orderObj[a[0]];
      const ob = orderObj[b[0]];
      if (oa == null && ob == null) return (a[1].joinedAt||0)-(b[1].joinedAt||0);
      if (oa == null) return 1;
      if (ob == null) return -1;
      return oa - ob;
    });

    ordered.forEach(([pid, p]) => {
      const row = document.createElement("div");
      row.className = "player-row";

      const main = document.createElement("div");
      main.className = "player-main";

      const icon = document.createElement("span");
      icon.className = "player-icon";
      icon.textContent = pid === hostId ? "ğŸ‘‘" : "ğŸ™‚";

      const nameSpan = document.createElement("span");
      nameSpan.className = "player-name";
      nameSpan.textContent = p.nickname || "(æœªå‘½å)";

      const orderTag = document.createElement("span");
      orderTag.className = "player-order-tag";
      const orderNum = orderObj[pid];
      orderTag.textContent = orderNum != null ? `ç¬¬ ${orderNum} æ‰‹` : "æœªæ’";

      main.appendChild(icon);
      main.appendChild(nameSpan);
      main.appendChild(orderTag);

      row.appendChild(main);

      // åªæœ‰æˆ¿ä¸»å¯ä»¥èª¿æ•´æ’åº
      if (isHost) {
        const btn = document.createElement("button");
        btn.className = "btn-outline";
        btn.style.fontSize = "11px";
        btn.style.padding = "1px 6px";
        btn.textContent = orderNum != null ? "å–æ¶ˆæ’åº" : "æ’åº";
        btn.addEventListener("click", async () => {
          const roomRef = ref(db, `rooms/${currentRoomId}`);
          const snap = await get(roomRef);
          if (!snap.exists()) return;
          const room = snap.val();
          if (room.locked) return; // å·²é–å®šæ™‚ä¸å¯æ›´å‹•

          const curOrders = room.turnOrder || {};
          if (curOrders[pid] != null) {
            // å–æ¶ˆ
            delete curOrders[pid];
          } else {
            // æ–°å¢ â†’ å¾ 1,2,3... æ‰¾å‡ºå°šæœªä½¿ç”¨çš„æœ€å°æ•¸å­—
            const taken = new Set(Object.values(curOrders));
            let n = 1;
            while (taken.has(n)) n++;
            curOrders[pid] = n;
          }
          await update(roomRef, { turnOrder: curOrders });
        });
        row.appendChild(btn);
      }

      listEl.appendChild(row);
    });
  }

  // é–å®šæŒ‰éˆ•
  function updateLockButton(locked) {
    const btn = $("lockButton");
    if (locked) {
      btn.textContent = "å–æ¶ˆé–å®š / çµæŸæœ¬å±€";
      btn.classList.add("locked");
      btn.classList.remove("btn-primary");
    } else {
      btn.textContent = "é–å®šä¸¦é–‹å§‹æœ¬å±€";
      btn.classList.remove("locked");
      btn.classList.add("btn-primary");
    }
  }

  $("lockButton").addEventListener("click", async () => {
    if (!currentRoomId) return;
    const roomRef = ref(db, `rooms/${currentRoomId}`);
    const snap = await get(roomRef);
    if (!snap.exists()) return;

    const room = snap.val();
    if (!isHost) {
      alert("åªæœ‰æˆ¿ä¸»å¯ä»¥é–å®š / å–æ¶ˆé–å®šã€‚");
      return;
    }

    const locked = !!room.locked;
    if (!locked) {
      // è¦é–å®šï¼šç¢ºèªæ‰€æœ‰ç©å®¶éƒ½æœ‰æ’åº
      const players = room.players || {};
      const orders = room.turnOrder || {};
      const pIds = Object.keys(players);
      const missing = pIds.filter(pid => orders[pid] == null);
      if (missing.length) {
        alert("è«‹å…ˆç‚ºæ‰€æœ‰ç©å®¶è¨­å®šé †ä½æ’åºï¼ˆå·¦å´åˆ—è¡¨ï¼‰ã€‚");
        return;
      }
      if (!confirm("é–å®šå¾Œå°‡é–‹å§‹æœ¬å±€ï¼Œä¸¦ç¦æ­¢æ›´æ”¹æ’åºèˆ‡åˆ·æ–°å¡ç‰‡ã€‚ç¢ºå®šï¼Ÿ")) return;

      await update(roomRef, {
        locked: true,
        lastActive: Date.now(),
        currentTurnIndex: 0   // å¾ç¬¬ä¸€é †ä½é–‹å§‹
      });
      logToRoom(currentRoomId, `${nickname} é–‹å§‹æœ¬å±€ä¸¦é–å®šã€‚`);
    } else {
      // è¦å–æ¶ˆé–å®šï¼ˆçµæŸæœ¬å±€ï¼‰
      if (!confirm("ç¢ºå®šè¦å–æ¶ˆé–å®šä¸¦çµæŸæ­¤å±€ï¼Ÿå…¬å…±è™Ÿç¢¼èˆ‡å¡ç‰‡æ¨™è¨˜å°‡è¢«ä¿ç•™ï¼Œä½†å¯é‡æ–°èª¿æ•´æ’åºèˆ‡åˆ·æ–°å¡ç‰‡ã€‚")) return;
      await update(roomRef, {
        locked: false,
        lastActive: Date.now()
      });
      logToRoom(currentRoomId, `${nickname} è§£é™¤é–å®šä¸¦çµæŸæœ¬å±€ã€‚`);
    }
  });

  // æ¸…é™¤æ’åºï¼ˆæˆ¿ä¸»ï¼‰
  $("clearOrderBtn").addEventListener("click", async () => {
    if (!currentRoomId) return;
    if (!isHost) {
      alert("åªæœ‰æˆ¿ä¸»å¯ä»¥æ¸…é™¤æ’åºã€‚");
      return;
    }
    if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç©å®¶æ’åºå—ï¼Ÿ")) return;
    const roomRef = ref(db, `rooms/${currentRoomId}`);
    await update(roomRef, { turnOrder: {} });
  });

  // åˆ·æ–°å¡ç‰‡ï¼ˆæˆ¿ä¸»é–å®šå¾Œæœƒè¢«ç¦æ­¢ï¼‰
  $("refreshCardBtn").addEventListener("click", async () => {
    if (!currentRoomId) return;
    const roomRef = ref(db, `rooms/${currentRoomId}`);
    const snap = await get(roomRef);
    if (!snap.exists()) return;
    const room = snap.val();
    if (room.locked) {
      alert("æœ¬å±€å·²é–å®šï¼Œç„¡æ³•åˆ·æ–°å¡ç‰‡ã€‚");
      return;
    }
    const newCard = randomCard();
    myCard = newCard;
    myMarks = {};
    myShowoffCount = 0;
    await update(ref(db, `rooms/${currentRoomId}/players/${clientId}`), {
      card: newCard,
      marks: {}
    });
    logToRoom(currentRoomId, `${nickname} é‡æ–°æŠ½å¡ç‰‡`);
  });

  // ç‚«è€€æŒ‰éˆ•ï¼šåŒæ¢æ•¸æœ€å¤š 3 æ¬¡ï¼Œç¬¬ 4 æ¬¡ä¸”æ¢æ•¸æœªå¢åŠ  â†’ é–å®šä¸¦æç¤ºã€Œä½èª¿ï¼ä½èª¿ï¼ã€
  $("showoffBtn").addEventListener("click", () => {
    if (!currentRoomId) return;
    const count = computeBingo(myCard, myMarks);
    if (count <= 0) return;

    const prevCount = $("showoffBtn").dataset.lastCount
      ? parseInt($("showoffBtn").dataset.lastCount,10)
      : 0;

    if (prevCount !== count) {
      // æ¢æ•¸æœ‰è®Š â†’ é‡ç½®æ¬¡æ•¸
      myShowoffCount = 0;
      $("showoffBtn").dataset.lastCount = String(count);
    }

    myShowoffCount++;
    if (myShowoffCount <= 3) {
      logToRoom(currentRoomId, `${nickname}ï¼šç‚«è€€ä¸€ä¸‹ï¼Œç›®å‰ BINGO ${count} æ¢ï½`);
    } else {
      $("showoffBtn").disabled = true;
      alert("ä½èª¿ï¼ä½èª¿ï¼(åŒæ¢æ•¸ç‚«è€€å¤ªå¤šæ¬¡å•¦ï½)");
      logToRoom(currentRoomId, `${nickname}ï¼šè¢«ç³»çµ±åˆ¶æ­¢ç‚«è€€ï¼Œè«‹ä½èª¿ï¼`);
    }
  });

  // ---------------------------------------------------------------------------
  // æ—¥èªŒ
  // ---------------------------------------------------------------------------
  function logToRoom(roomId, msg) {
    if (!roomId) return;
    const logRef = ref(db, `rooms/${roomId}/logs`);
    push(logRef, {
      msg,
      ts: Date.now()
    });
  }

</script>
</body>
</html>
