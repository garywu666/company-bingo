<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Company Bingo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    button {
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      padding: 4px 10px;
      background: #fff;
      font-size: 14px;
    }
    button.primary {
      background: #2563eb;
      border-color: #1d4ed8;
      color: #fff;
    }
    button.danger {
      background: #ef4444;
      border-color: #b91c1c;
      color: #fff;
    }
    button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .hidden { display: none !important; }

    .top-bar {
      background: #111827;
      color: #e5e7eb;
      padding: 6px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .room-toggle {
      cursor: pointer;
      font-size: 14px;
      color: #93c5fd;
      text-decoration: underline;
    }

    .room-panel {
      background: #1f2937;
      color: #e5e7eb;
      padding: 10px 12px 14px;
    }
    .room-panel label {
      font-size: 13px;
      display: block;
      margin-top: 6px;
      margin-bottom: 2px;
    }
    .room-panel input {
      width: 200px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #6b7280;
      background: #111827;
      color: #e5e7eb;
    }
    .room-panel small {
      font-size: 12px;
      color: #9ca3af;
    }

    .room-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .main-layout {
      display: flex;
      gap: 10px;
      padding: 10px;
      align-items: flex-start;
    }

    .col-left, .col-center, .col-right {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 10px;
    }

    .col-left {
      width: 180px;
      min-width: 180px;
    }
    .col-center {
      flex: 1;
      min-width: 0;
    }
    .col-right {
      width: 330px;
      min-width: 260px;
    }

    h2, h3 {
      margin: 0 0 6px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sub-title {
      font-size: 14px;
      color: #6b7280;
    }

    .flex-row-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .grid-10, .grid-5 {
      display: grid;
      gap: 4px;
      margin-top: 4px;
    }
    .grid-10 { grid-template-columns: repeat(10, 1fr); }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }

    .num-btn {
      padding: 6px 0;
      text-align: center;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 14px;
      user-select: none;
    }
    .num-btn.active {
      background: #2563eb;
      color: #ffffff;
      border-color: #1d4ed8;
    }

    .num-btn.disabled {
      cursor: default;
      opacity: 0.5;
    }

    .section {
      margin-bottom: 10px;
    }

    .bingo-info {
      font-size: 14px;
      color: #374151;
    }

    .log-box {
      border-radius: 4px;
      background: #111827;
      color: #e5e7eb;
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 6px;
      height: 420px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .player-list {
      margin-top: 4px;
    }
    .player-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      padding: 3px 4px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .player-row.me {
      background: #dbeafe;
    }
    .player-row.host .name {
      font-weight: 600;
    }
    .player-row .name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .player-row .badge {
      width: 20px;
      text-align: center;
      font-size: 12px;
      border-radius: 999px;
      padding: 0 4px;
      background: #e5e7eb;
    }

    .icon {
      font-size: 14px;
    }

    .turn-hint {
      font-size: 14px;
      color: #4b5563;
      min-width: 90px;
    }

    /* æº–å‚™è¦–çª— */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #ffffff;
      border-radius: 8px;
      padding: 14px;
      width: 420px;
      max-width: 90vw;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .modal h3 {
      margin-bottom: 8px;
    }
    .modal-player-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      padding: 2px 0;
    }
    .status-ready { color: #16a34a; }
    .status-wait  { color: #f97316; }
    .status-cancel { color:#ef4444; }

    .small-text {
      font-size: 12px;
      color: #6b7280;
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div>
    <span>å…¬å¸ Bingo</span>
  </div>
  <div>
    <span id="currentRoomLabel" class="small-text"></span>
    <span id="roomToggle" class="room-toggle">é¡¯ç¤ºæˆ¿é–“è¨­å®š</span>
  </div>
</div>

<div id="roomPanel" class="room-panel">
  <label>æš±ç¨±</label>
  <input id="nicknameInput" type="text" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" />

  <label>æˆ¿é–“ ID</label>
  <input id="roomIdInput" type="text" placeholder="ä¾‹å¦‚: sales-001" />

  <label>æˆ¿é–“å¯†ç¢¼</label>
  <input id="roomPasswordInput" type="password" />

  <div class="room-actions">
    <button id="createRoomBtn" class="primary">å»ºç«‹æˆ¿é–“</button>
    <button id="joinRoomBtn">åŠ å…¥æˆ¿é–“</button>
    <small id="roomInfoMsg"></small>
  </div>
</div>

<div id="app" class="hidden">
  <div class="main-layout">

    <!-- å·¦å´ï¼šç©å®¶æ’åº -->
    <div class="col-left">
      <div class="flex-row-between">
        <h3>ç©å®¶æ’åº</h3>
      </div>
      <div class="flex-row-between" style="margin-bottom:4px;">
        <small class="small-text">æˆ¿ä¸»é»ç©å®¶å¯è¨­å®š â‘ â‘¡â‘¢â€¦</small>
        <button id="clearOrderBtn" style="font-size:12px;padding:2px 6px;">æ¸…é™¤æ’åº</button>
      </div>
      <div id="playerList" class="player-list"></div>
    </div>

    <!-- ä¸­é–“ï¼šå…¬å…±è™Ÿç¢¼ + æˆ‘çš„å¡ç‰‡ -->
    <div class="col-center">

      <!-- å…¬å…±è™Ÿç¢¼ -->
      <div class="section">
        <div class="flex-row-between">
          <h2>å…¬å…±è™Ÿç¢¼ï¼ˆ1â€“50ï¼‰</h2>
          <div style="display:flex;align-items:center;gap:6px;">
            <span id="turnHint" class="turn-hint"></span>
            <button id="lockBtn" class="primary">é–å®š</button>
          </div>
        </div>
        <div class="sub-title">ä»»ä½•äººé»è‡ªå·±å¡ç‰‡ä¸Šçš„è™Ÿç¢¼ï¼ŒæœƒåŒæ­¥æ›´æ–°é€™è£¡ï¼Œæ‰€æœ‰äººéƒ½çœ‹å¾—åˆ°ã€‚</div>
        <div id="publicGrid" class="grid-10"></div>
      </div>

      <!-- æˆ‘çš„å¡ç‰‡ -->
      <div class="section">
        <div class="flex-row-between">
          <h2>æˆ‘çš„å¡ç‰‡</h2>
          <div style="display:flex;align-items:center;gap:6px;">
            <button id="refreshCardBtn">åˆ·æ–°</button>
            <span class="bingo-info">ç›®å‰ BINGO æ¢æ•¸ï¼š<span id="bingoCount">0</span></span>
          </div>
        </div>
        <div class="sub-title">é»æ•¸å­—ï¼å®£å‘Š / å–æ¶ˆè©²è™Ÿç¢¼ã€‚</div>
        <div id="myCard" class="grid-5"></div>
      </div>

    </div>

    <!-- å³å´ï¼šæ—¥èªŒ -->
    <div class="col-right">
      <div class="flex-row-between">
        <h3>æ—¥èªŒ</h3>
      </div>
      <div id="logBox" class="log-box"></div>
    </div>

  </div>
</div>

<!-- æº–å‚™è¦–çª— -->
<div id="readyModal" class="modal-backdrop hidden">
  <div class="modal">
    <h3>æº–å‚™é–‹å§‹ï¼Ÿ</h3>
    <p class="small-text" style="margin-bottom:6px;">
      æˆ¿ä¸»é–å®šå¾Œï¼Œæ¯å€‹äººæŒ‰ã€Œæº–å‚™ã€æ‰èƒ½é–‹å§‹ã€‚æŒ‰ã€Œå–æ¶ˆã€æœƒç«‹åˆ»ä¸­æ­¢æº–å‚™ã€‚
    </p>
    <div style="display:flex;gap:8px;margin-bottom:8px;">
      <button id="readyBtn" class="primary" style="flex:1;">æº–å‚™</button>
      <button id="readyCancelBtn" style="flex:1;">å–æ¶ˆ</button>
    </div>
    <div class="small-text" style="margin-bottom:4px;">ç‹€æ…‹ï¼š</div>
    <div id="readyPlayerStatus"></div>
  </div>
</div>

<!-- Firebase + é‚è¼¯ -->
<script type="module">
  // ========= Firebase åˆå§‹åŒ– =========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    set,
    get,
    onValue,
    push,
    update,
    runTransaction,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

  // TODO: æ›æˆä½ è‡ªå·±çš„ Firebase è¨­å®š -----------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyB4IBPbuGxztyzd8E3YTitMoTt8L19MSG0",
    authDomain: "company-bingo.firebaseapp.com",
    databaseURL: "https://company-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "company-bingo",
    storageBucket: "company-bingo.firebasestorage.app",
    messagingSenderId: "844173689886",
    appId: "1:844173689886:web:ac2f1888f542b138861a0f",
    measurementId: "G-WGDVJPKMEH"
  };
  // ------------------------------------------------------------

  const appFirebase = initializeApp(firebaseConfig);
  const db = getDatabase(appFirebase);

  // ========= æœ¬åœ°ç‹€æ…‹ =========
  const localUidKey = "company-bingo-uid";
  let myUid = localStorage.getItem(localUidKey);
  if (!myUid) {
    myUid = "u-" + Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(localUidKey, myUid);
  }

  let myName = "";
  let currentRoomId = null;
  let isHost = false;

  let roomMeta = {};       // {locked, hostId, prepareActive}
  let players = {};        // {uid: {name, order, ready}}
  let publicNumbers = {};  // {num: true}
  let myBoard = [];        // 25 numbers
  let unsubscribes = [];

  // DOM
  const roomPanelEl = document.getElementById("roomPanel");
  const roomToggleEl = document.getElementById("roomToggle");
  const nicknameInput = document.getElementById("nicknameInput");
  const roomIdInput = document.getElementById("roomIdInput");
  const roomPasswordInput = document.getElementById("roomPasswordInput");
  const createRoomBtn = document.getElementById("createRoomBtn");
  const joinRoomBtn = document.getElementById("joinRoomBtn");
  const roomInfoMsg = document.getElementById("roomInfoMsg");
  const currentRoomLabel = document.getElementById("currentRoomLabel");

  const appEl = document.getElementById("app");
  const publicGridEl = document.getElementById("publicGrid");
  const myCardEl = document.getElementById("myCard");
  const logBoxEl = document.getElementById("logBox");
  const playerListEl = document.getElementById("playerList");
  const clearOrderBtn = document.getElementById("clearOrderBtn");
  const lockBtn = document.getElementById("lockBtn");
  const refreshCardBtn = document.getElementById("refreshCardBtn");
  const bingoCountEl = document.getElementById("bingoCount");
  const turnHintEl = document.getElementById("turnHint");

  const readyModalEl = document.getElementById("readyModal");
  const readyBtn = document.getElementById("readyBtn");
  const readyCancelBtn = document.getElementById("readyCancelBtn");
  const readyPlayerStatusEl = document.getElementById("readyPlayerStatus");

  // ========= å°å·¥å…· =========
  function logLocal(message) {
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, "0");
    const mm = String(now.getMinutes()).padStart(2, "0");
    const ss = String(now.getSeconds()).padStart(2, "0");
    const line = `[${hh}:${mm}:${ss}] ${message}`;
    logBoxEl.textContent += (logBoxEl.textContent ? "\n" : "") + line;
    logBoxEl.scrollTop = logBoxEl.scrollHeight;
  }

  function pushLogToRoom(text) {
    if (!currentRoomId) return;
    push(ref(db, `rooms/${currentRoomId}/logs`), {
      text,
      ts: Date.now()
    }).catch(console.error);
  }

  function randomBoard() {
    const nums = Array.from({ length: 50 }, (_, i) => i + 1);
    for (let i = nums.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [nums[i], nums[j]] = [nums[j], nums[i]];
    }
    return nums.slice(0, 25);
  }

  function renderPublicGrid() {
    publicGridEl.innerHTML = "";
    for (let i = 1; i <= 50; i++) {
      const btn = document.createElement("div");
      btn.className = "num-btn" + (publicNumbers[i] ? " active" : "");
      btn.textContent = i;
      btn.dataset.num = i;
      if (roomMeta.locked === true && !isMyTurn()) {
        // å¦‚æœæœ‰åš´æ ¼è¼ªæµé™åˆ¶å¯ä»¥åœ¨é€™è£¡ç”¨ disabled
      }
      btn.addEventListener("click", () => handleToggleNumber(i));
      publicGridEl.appendChild(btn);
    }
  }

  function renderMyCard() {
    myCardEl.innerHTML = "";
    myBoard.forEach(num => {
      const btn = document.createElement("div");
      btn.className = "num-btn" + (publicNumbers[num] ? " active" : "");
      btn.textContent = num;
      btn.dataset.num = num;
      btn.addEventListener("click", () => handleToggleNumber(num));
      myCardEl.appendChild(btn);
    });
    updateBingoCount();
  }

  function calcBingo(boardNums, selected) {
    if (boardNums.length !== 25) return 0;
    let lines = 0;
    const posHas = idx => selected.has(boardNums[idx]);
    // rows
    for (let r = 0; r < 5; r++) {
      if ([0,1,2,3,4].every(c => posHas(r*5 + c))) lines++;
    }
    // cols
    for (let c = 0; c < 5; c++) {
      if ([0,1,2,3,4].every(r => posHas(r*5 + c))) lines++;
    }
    // diag 1
    if ([0,1,2,3,4].every(i => posHas(i*6))) lines++;
    // diag 2
    if ([0,1,2,3,4].every(i => posHas((i+1)*4))) lines++;
    return lines;
  }

  function updateBingoCount() {
    const sel = new Set(Object.keys(publicNumbers).filter(k => publicNumbers[k]).map(n => +n));
    const cnt = calcBingo(myBoard, sel);
    bingoCountEl.textContent = cnt;
  }

  function renderPlayers() {
    playerListEl.innerHTML = "";
    const entries = Object.entries(players);
    // æ’åºï¼šæœ‰ order çš„ç…§ orderï¼Œå°çš„åœ¨ä¸Šï¼›æ²’æœ‰ order çš„æ”¾å¾Œé¢
    entries.sort((a, b) => {
      const pa = a[1];
      const pb = b[1];
      const oa = pa.order || 9999;
      const ob = pb.order || 9999;
      if (oa !== ob) return oa - ob;
      return (pa.name || "").localeCompare(pb.name || "");
    });

    entries.forEach(([uid, p]) => {
      const row = document.createElement("div");
      row.classList.add("player-row");
      if (uid === myUid) row.classList.add("me");
      if (uid === roomMeta.hostId) row.classList.add("host");
      const iconSpan = document.createElement("span");
      iconSpan.className = "icon";
      iconSpan.textContent = uid === roomMeta.hostId ? "ğŸ‘‘" : "ğŸ‘¤";

      const nameSpan = document.createElement("span");
      nameSpan.className = "name";
      nameSpan.textContent = p.name || "(æœªå‘½å)";

      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = p.order ? `â“µâ“¶â“·â“¸â“¹â“ºâ“»â“¼â“½â“¾`.charAt(p.order - 1) || p.order : "";

      row.appendChild(iconSpan);
      row.appendChild(nameSpan);
      row.appendChild(badge);

      // åªæœ‰æˆ¿ä¸»èƒ½è¨­å®šæ’åº
      if (isHost && !roomMeta.locked) {
        row.addEventListener("click", () => togglePlayerOrder(uid));
      } else {
        row.style.cursor = "default";
      }
      playerListEl.appendChild(row);
    });

    renderTurnHint();
  }

  function getUsedOrders() {
    const used = new Set();
    Object.values(players).forEach(p => {
      if (p.order) used.add(p.order);
    });
    return used;
  }

  function nextAvailableOrder() {
    const used = getUsedOrders();
    let i = 1;
    while (used.has(i)) i++;
    return i;
  }

  function togglePlayerOrder(uid) {
    const p = players[uid];
    if (!p) return;
    // å–æ¶ˆ â†’ è¨­ç‚º null
    let newOrder = null;
    if (!p.order) {
      newOrder = nextAvailableOrder();
    }
    update(ref(db, `rooms/${currentRoomId}/players/${uid}`), { order: newOrder });
  }

  function isMyTurn() {
    // æ ¹æ“šå…¬å…±è™Ÿç¢¼å·²é¸å€‹æ•¸ï¼†æ’åºæ±ºå®šç¾åœ¨è¼ªåˆ°èª°
    const ordered = Object.entries(players)
      .filter(([id, p]) => !!p.order)
      .sort((a,b)=> (a[1].order||0)-(b[1].order||0));
    if (ordered.length === 0) return false;
    const selectedCount = Object.values(publicNumbers).filter(Boolean).length;
    const idx = selectedCount % ordered.length; // 0-based
    const uid = ordered[idx][0];
    return uid === myUid;
  }

  function renderTurnHint() {
    const ordered = Object.entries(players)
      .filter(([id, p]) => !!p.order)
      .sort((a,b)=> (a[1].order||0)-(b[1].order||0));
    if (ordered.length === 0) {
      turnHintEl.textContent = "å°šæœªè¨­å®šæ’åº";
      return;
    }
    const selectedCount = Object.values(publicNumbers).filter(Boolean).length;
    const idx = selectedCount % ordered.length;
    const [uid, p] = ordered[idx];
    turnHintEl.textContent = roomMeta.locked ? `${p.name} è«‹é¸è™Ÿ` : "å°šæœªé–å®š";
  }

  function setRoomMetaPartial(obj) {
    if (!currentRoomId) return;
    update(ref(db, `rooms/${currentRoomId}/meta`), obj);
  }

  // ========= äº‹ä»¶ï¼šåˆ‡æ›è™Ÿç¢¼ =========
  function handleToggleNumber(num) {
    if (!currentRoomId) return;
    // é–å®šæ™‚å¯ä»¥é™åˆ¶åªæœ‰è¼ªåˆ°çš„äººèƒ½æŒ‰ï¼ˆè‹¥ä½ è¦æ›´åš´æ ¼çš„è©±ï¼‰
    if (roomMeta.locked && !isMyTurn()) {
      // åªæ˜¯æç¤ºï¼Œä¸é˜»æ­¢ä¹Ÿå¯ä»¥
      // alert("ç¾åœ¨ä¸æ˜¯ä½ çš„å›åˆå–”");
      return;
    }
    const numRef = ref(db, `rooms/${currentRoomId}/publicNumbers/${num}`);
    runTransaction(numRef, (prev) => {
      const newVal = !prev;
      return newVal;
    }).then(res => {
      const after = res.snapshot.val();
      const verb = after ? `${myName}: ${num}` : `${myName}: å–æ¶ˆ ${num}`;
      pushLogToRoom(verb);
    }).catch(console.error);
  }

  // ========= æˆ¿é–“å»ºç«‹ / åŠ å…¥ =========
  async function createRoom() {
    myName = (nicknameInput.value || "").trim();
    const roomId = (roomIdInput.value || "").trim();
    const pwd = roomPasswordInput.value || "";

    if (!myName) { alert("è«‹è¼¸å…¥æš±ç¨±"); return; }
    if (!roomId) { alert("è«‹è¼¸å…¥æˆ¿é–“ ID"); return; }

    const roomMetaRef = ref(db, `rooms/${roomId}/meta`);
    const snap = await get(roomMetaRef);
    if (snap.exists()) {
      alert("æ­¤æˆ¿é–“å·²å­˜åœ¨ï¼Œè«‹æ”¹ç”¨åŠ å…¥æˆ¿é–“ã€‚");
      return;
    }

    // å»ºæˆ¿
    await set(roomMetaRef, {
      hostId: myUid,
      password: pwd,
      locked: false,
      prepareActive: false,
      createdAt: serverTimestamp()
    });

    await set(ref(db, `rooms/${roomId}/players/${myUid}`), {
      name: myName,
      order: null,
      ready: null
    });

    await set(ref(db, `rooms/${roomId}/boards/${myUid}`), {
      nums: randomBoard()
    });

    currentRoomId = roomId;
    isHost = true;
    afterJoinRoom();
    pushLogToRoom(`${myName} å»ºç«‹æˆ¿é–“`);
  }

  async function joinRoom() {
    myName = (nicknameInput.value || "").trim();
    const roomId = (roomIdInput.value || "").trim();
    const pwd = roomPasswordInput.value || "";

    if (!myName) { alert("è«‹è¼¸å…¥æš±ç¨±"); return; }
    if (!roomId) { alert("è«‹è¼¸å…¥æˆ¿é–“ ID"); return; }

    const roomMetaRef = ref(db, `rooms/${roomId}/meta`);
    const snap = await get(roomMetaRef);
    if (!snap.exists()) {
      alert("æˆ¿é–“ä¸å­˜åœ¨ï¼Œè«‹ç¢ºèª IDã€‚");
      return;
    }
    const meta = snap.val();
    if ((meta.password || "") !== pwd) {
      alert("æˆ¿é–“å¯†ç¢¼éŒ¯èª¤ã€‚");
      return;
    }

    await update(roomMetaRef, { }); // ç¢ºä¿å­˜åœ¨

    // ç©å®¶è³‡æ–™
    await set(ref(db, `rooms/${roomId}/players/${myUid}`), {
      name: myName,
      order: null,
      ready: null
    });

    // è‹¥ä¹‹å‰æ²’æœ‰ board å¹«ä»–ç”Ÿä¸€å¼µ
    const boardRef = ref(db, `rooms/${roomId}/boards/${myUid}`);
    const boardSnap = await get(boardRef);
    if (!boardSnap.exists()) {
      await set(boardRef, { nums: randomBoard() });
    }

    currentRoomId = roomId;
    isHost = meta.hostId === myUid;
    afterJoinRoom();
    pushLogToRoom(`${myName} åŠ å…¥æˆ¿é–“`);
  }

  function clearListeners() {
    unsubscribes.forEach(unsub => unsub && unsub());
    unsubscribes = [];
  }

  function afterJoinRoom() {
    roomInfoMsg.textContent = "";
    appEl.classList.remove("hidden");
    currentRoomLabel.textContent = `æˆ¿é–“ï¼š${currentRoomId}ã€€æš±ç¨±ï¼š${myName}`;
    // åŠ å…¥æˆåŠŸå¾Œç¸®èµ·æˆ¿é–“è¨­å®š
    roomPanelEl.classList.add("hidden");
    roomToggleEl.textContent = "é¡¯ç¤ºæˆ¿é–“è¨­å®š";

    clearListeners();
    subscribeRoom();
  }

  // ========= ç›£è½æˆ¿é–“è³‡æ–™ =========
  function subscribeRoom() {
    if (!currentRoomId) return;

    // meta
    unsubscribes.push(
      onValue(ref(db, `rooms/${currentRoomId}/meta`), snap => {
        roomMeta = snap.val() || {};
        isHost = roomMeta.hostId === myUid;
        lockBtn.textContent = roomMeta.locked ? "å–æ¶ˆé–å®š" : "é–å®š";
        // é–å®šæ™‚é—œé–‰åˆ·æ–° & æ’åº
        refreshCardBtn.disabled = !!roomMeta.locked;
        clearOrderBtn.disabled = !!roomMeta.locked;
        renderPlayers();
      })
    );

    // players
    unsubscribes.push(
      onValue(ref(db, `rooms/${currentRoomId}/players`), snap => {
        players = snap.val() || {};
        renderPlayers();
        renderReadyStatus();
      })
    );

    // public numbers
    unsubscribes.push(
      onValue(ref(db, `rooms/${currentRoomId}/publicNumbers`), snap => {
        publicNumbers = snap.val() || {};
        renderPublicGrid();
        renderMyCard();
        renderTurnHint();
      })
    );

    // my board
    unsubscribes.push(
      onValue(ref(db, `rooms/${currentRoomId}/boards/${myUid}/nums`), snap => {
        const arr = snap.val();
        if (Array.isArray(arr) && arr.length === 25) {
          myBoard = arr;
        } else {
          myBoard = randomBoard();
        }
        renderMyCard();
      })
    );

    // logs
    unsubscribes.push(
      onValue(ref(db, `rooms/${currentRoomId}/logs`), snap => {
        const val = snap.val() || {};
        const list = Object.values(val).sort((a,b)=> (a.ts||0)-(b.ts||0));
        logBoxEl.textContent = "";
        list.forEach(entry => logLocal(entry.text));
      })
    );

    // æº–å‚™ç‹€æ…‹
    unsubscribes.push(
      onValue(ref(db, `rooms/${currentRoomId}/meta/prepareActive`), snap => {
        const active = !!snap.val();
        if (active) {
          showReadyModal();
        } else {
          hideReadyModal();
        }
      })
    );
  }

  // ========= æº–å‚™ç›¸é—œ =========
  function showReadyModal() {
    readyModalEl.classList.remove("hidden");
    renderReadyStatus();
  }
  function hideReadyModal() {
    readyModalEl.classList.add("hidden");
  }

  function renderReadyStatus() {
    if (!currentRoomId) return;
    const rows = [];
    Object.entries(players).forEach(([uid,p]) => {
      const row = document.createElement("div");
      row.className = "modal-player-row";
      const left = document.createElement("span");
      left.textContent = (uid === roomMeta.hostId ? "ğŸ‘‘ " : "ğŸ‘¤ ") + (p.name || "");
      const right = document.createElement("span");
      const st = p.ready || "waiting";
      if (st === "ready") {
        right.textContent = "å·²æº–å‚™";
        right.className = "status-ready";
      } else if (st === "cancel") {
        right.textContent = "å–æ¶ˆ";
        right.className = "status-cancel";
      } else {
        right.textContent = "ç­‰å€™æº–å‚™";
        right.className = "status-wait";
      }
      row.appendChild(left);
      row.appendChild(right);
      rows.push(row);
    });
    readyPlayerStatusEl.innerHTML = "";
    rows.forEach(r => readyPlayerStatusEl.appendChild(r));

    // è‹¥æ‰€æœ‰äºº ready â†’ æˆ¿ä¸»å•Ÿå‹•é–å®š
    const arr = Object.values(players);
    if (arr.length > 0 && arr.every(p => p.ready === "ready")) {
      if (isHost && roomMeta.prepareActive) {
        // å•Ÿå‹•é–å®š
        setRoomMetaPartial({ locked: true, prepareActive: false });
        pushLogToRoom("æ‰€æœ‰äººå·²æº–å‚™ï¼ŒéŠæˆ²é–‹å§‹");
      }
    }
  }

  readyBtn.addEventListener("click", () => {
    if (!currentRoomId) return;
    update(ref(db, `rooms/${currentRoomId}/players/${myUid}`), { ready: "ready" });
  });

  readyCancelBtn.addEventListener("click", () => {
    if (!currentRoomId) return;
    update(ref(db, `rooms/${currentRoomId}/players/${myUid}`), { ready: "cancel" });
    setRoomMetaPartial({ prepareActive: false });
    pushLogToRoom(`${myName}: ä½ å€‘å…ˆåˆ¥æ€¥`);
  });

  // ========= UI äº‹ä»¶ =========
  createRoomBtn.addEventListener("click", () => {
    createRoom().catch(err => {
      console.error(err);
      alert("å»ºç«‹æˆ¿é–“å¤±æ•—ï¼Œè«‹çœ‹ consoleã€‚");
    });
  });

  joinRoomBtn.addEventListener("click", () => {
    joinRoom().catch(err => {
      console.error(err);
      alert("åŠ å…¥æˆ¿é–“å¤±æ•—ï¼Œè«‹çœ‹ consoleã€‚");
    });
  });

  roomToggleEl.addEventListener("click", () => {
    const hidden = roomPanelEl.classList.toggle("hidden");
    roomToggleEl.textContent = hidden ? "é¡¯ç¤ºæˆ¿é–“è¨­å®š" : "éš±è—æˆ¿é–“è¨­å®š";
  });

  clearOrderBtn.addEventListener("click", () => {
    if (!isHost) return;
    if (!currentRoomId) return;
    const updates = {};
    Object.keys(players).forEach(uid => {
      updates[`rooms/${currentRoomId}/players/${uid}/order`] = null;
    });
    update(ref(db), updates);
  });

  refreshCardBtn.addEventListener("click", () => {
    if (!currentRoomId) return;
    if (roomMeta.locked) return;
    const newBoard = randomBoard();
    set(ref(db, `rooms/${currentRoomId}/boards/${myUid}/nums`), newBoard);
    pushLogToRoom(`${myName} åˆ·æ–°å¡ç‰‡`);
  });

  lockBtn.addEventListener("click", () => {
    if (!isHost) {
      alert("åªæœ‰æˆ¿ä¸»å¯ä»¥é–å®š / å–æ¶ˆé–å®šã€‚");
      return;
    }
    if (!currentRoomId) return;

    if (!roomMeta.locked) {
      // è¦é–å®š â†’ å…ˆæª¢æŸ¥æ’åº
      const allPlayers = Object.values(players);
      if (allPlayers.length === 0) {
        alert("æ²’æœ‰ç©å®¶ï¼Œç„¡æ³•é–å®šã€‚");
        return;
      }
      const hasUnordered = allPlayers.some(p => !p.order);
      if (hasUnordered) {
        alert("è«‹å…ˆç‚ºæ‰€æœ‰ç©å®¶è¨­å®šå·¦å´çš„é †ä½æ’åºã€‚");
        return;
      }
      // å•Ÿå‹•æº–å‚™éšæ®µ
      const updates = {};
      Object.keys(players).forEach(uid => {
        updates[`rooms/${currentRoomId}/players/${uid}/ready`] = "waiting";
      });
      updates[`rooms/${currentRoomId}/meta/prepareActive`] = true;
      update(ref(db), updates);
      pushLogToRoom("æˆ¿ä¸»å•Ÿå‹•æº–å‚™æµç¨‹");
    } else {
      // å–æ¶ˆé–å®š â†’ çµæŸä¸€å±€
      if (!confirm("æ˜¯å¦çµæŸæ­¤å±€ä¸¦æ¸…é™¤æ‰€æœ‰å…¬å…±è™Ÿç¢¼ï¼Ÿ")) return;
      const updates = {};
      updates[`rooms/${currentRoomId}/meta/locked`] = false;
      updates[`rooms/${currentRoomId}/meta/prepareActive`] = false;
      updates[`rooms/${currentRoomId}/publicNumbers`] = null;
      update(ref(db), updates);
      pushLogToRoom("æˆ¿ä¸»å–æ¶ˆé–å®šä¸¦æ¸…ç©ºå…¬å…±è™Ÿç¢¼");
    }
  });

  // é›¢é–‹é é¢æ™‚ç°¡å–®ç´€éŒ„ä¸€ä¸‹ï¼ˆé€™è£¡å°±ä¸åˆªç©å®¶è³‡æ–™äº†ï¼Œé¿å…èª¤åˆªï¼‰
  window.addEventListener("beforeunload", () => {
    // ä½ å¦‚æœæƒ³é›¢é–‹å°±åˆªæ‰ç©å®¶ï¼Œå¯ä»¥åœ¨é€™è£¡ update / remove
  });

</script>
</body>
</html>
